<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>电商数仓V5.0 | snowgo</title>

  <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://cdn.jsdelivr.net/gh/inkss/fontawesome@5.15.3/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
    <script>
        var themeModelId = '';
        if (themeModelId) {
            localStorage.setItem('modelId', themeModelId);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/gh/yuang01/live2d-widget@latest/autoload.js"></script>
    <script>
        var live2dOpen = eval('true') || false;
        if (!live2dOpen) {
            localStorage.setItem('waifu-display', 1609323474481);
        }
    </script>
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    

    <!-- import link -->
    
        
            <link href="/custom/index.css" rel="stylesheet">
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 5.4.0"></head>

  
  <!-- 依赖于jquery和vue -->
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

  

  
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>

  
  
  <body>
    <!-- 预加载动画 -->
    <!-- 页面预加载动画 -->

    
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (href, before, media, attributes) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header   " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo" src="https://snowgo.top/medias/pre-medias/logo.png" alt="logo">
      <h3 class="drawer-box-head_title">snowgo</h3>
      <h5 class="drawer-box-head_desc"></h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">主页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">时间轴</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">类别</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/about" class="drawer-menu-item-link">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于我</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                    <i class="fas fa-book" aria-hidden="true"></i>
                  
                  <span class="name">友人帐</span>
                </a>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://github.com/snowgo/">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="https://snowgo.top/medias/pre-medias/logo.png" alt="logo">
        </div>
      
      <a href="/" class="logo">snowgo</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="主页">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">主页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="时间轴">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">时间轴</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="标签">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="类别">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">类别</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/about" class="menu-item-link" title="关于我">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于我</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link" title="友人帐">
                  
                    <i class="fas fa-book" aria-hidden="true"></i>
                  
                  <span class="name">友人帐</span>
                </a>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">Search</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="Please enter keywords"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://github.com/snowgo/" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    
</header>
        <!-- 内容区域 -->
        
 <!-- prismjs 代码高亮 -->
 


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('https://images2.alphacoders.com/176/thumb-1920-176292.jpg')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        电商数仓V5.0
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> Published in：2022-01-22 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> category：
          
            <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="post-detail-header_category">
              项目
            </a>
          
        </span>
      

      
        <div class="post-detail-header_wordcount">
          <span class="totalcount">
            <i class="fas fa-file-text-o"></i> Words: 48k |
          </span>
  
          <span class="min2read">
            <i class="fas fa-clock"></i> Reading time: 245min |
          </span>
  
          
        </div>
      
    
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>





<div class="post-detail-content row justify-position" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <p>尚硅谷大数据项目之电商数仓（电商数据仓库系统）</p>
<p>(作者：尚硅谷大数据研发部)</p>
<p>版本：V5.0</p>
<h2 id="第1章-数据仓库概述"><a href="#第1章-数据仓库概述" class="headerlink" title="第1章 数据仓库概述"></a>第1章 数据仓库概述</h2><h3 id="数据仓库概念"><a href="#数据仓库概念" class="headerlink" title="数据仓库概念"></a>数据仓库概念</h3><p>数据仓库是一个为数据分析而设计的企业级数据管理系统。数据仓库可集中、整合多个信息源的大量数据，借助数据仓库的分析能力，企业可从数据中获得宝贵的信息进而改进决策。同时，随着时间的推移，数据仓库中积累的大量历史数据对于数据科学家和业务分析师也是十分宝贵的。</p>
<h3 id="数据仓库核心架构"><a href="#数据仓库核心架构" class="headerlink" title="数据仓库核心架构"></a>数据仓库核心架构</h3><h2 id="第2章-数据仓库建模概述"><a href="#第2章-数据仓库建模概述" class="headerlink" title="第2章 数据仓库建模概述"></a>第2章 数据仓库建模概述</h2><h3 id="数据仓库建模的意义"><a href="#数据仓库建模的意义" class="headerlink" title="数据仓库建模的意义"></a>数据仓库建模的意义</h3><p>如果把数据看作图书馆里的书，我们希望看到它们在书架上分门别类地放置；如果把数据看作城市的建筑，我们希望城市规划布局合理；如果把数据看作电脑文件和文件夹，我们希望按照自己的习惯有很好的文件夹组织方式，而不是糟糕混乱的桌面，经常为找一个文件而不知所措。</p>
<p>数据模型就是数据组织和存储方法，它强调从业务、数据存取和使用角度合理存储数据。只有将数据有序的组织和存储起来之后，数据才能得到高性能、低成本、高效率、高质量的使用。</p>
<p>高性能：良好的数据模型能够帮助我们快速查询所需要的数据。</p>
<p>低成本：良好的数据模型能减少重复计算，实现计算结果的复用，降低计算成本。</p>
<p>高效率：良好的数据模型能极大的改善用户使用数据的体验，提高使用数据的效率。</p>
<p>高质量：良好的数据模型能改善数据统计口径的混乱，减少计算错误的可能性。</p>
<h3 id="数据仓库建模方法论"><a href="#数据仓库建模方法论" class="headerlink" title="数据仓库建模方法论"></a>数据仓库建模方法论</h3><h4 id="ER模型"><a href="#ER模型" class="headerlink" title="ER模型"></a>ER模型</h4><p>数据仓库之父Bill Inmon提出的建模方法是从全企业的高度，用实体关系（Entity<br>Relationship，ER）模型来描述企业业务，并用规范化的方式表示出来，在范式理论上符合3NF。</p>
<p><strong>1）实体关系模型</strong></p>
<p>实体关系模型将复杂的数据抽象为两个概念——实体和关系。实体表示一个对象，例如学生、班级，关系是指两个实体之间的关系，例如学生和班级之间的从属关系。</p>
<p><strong>2）数据库规范化</strong></p>
<p>数据库规范化是使用一系列范式设计数据库（通常是关系型数据库）的过程，其目的是减少数据冗余，增强数据的一致性。</p>
<p>这一系列范式就是指在设计关系型数据库时，需要遵从的不同的规范。关系型数据库的范式一共有六种，分别是第一范式（1NF）、第二范式（2NF）、第三范式（3NF）、巴斯-科德范式（BCNF）、第四范式(4NF）和第五范式（5NF）。遵循的范式级别越高，数据冗余性就越低。</p>
<p><strong>3）三范式</strong></p>
<p><strong>（1）函数依赖</strong></p>
<p><strong>（2）第一范式</strong></p>
<p><strong>（3）第二范式</strong></p>
<p><strong>（4）第三范式</strong></p>
<p>下图为一个采用Bill<br>Inmon倡导的建模方法构建的模型，从图中可以看出，较为松散、零碎，物理表数量多。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/250b56b4e3e1198e1f6df4cfadcf3651.png"></p>
<p>这种建模方法的出发点是整合数据，其目的是将整个企业的数据进行组合和合并，并进行规范处理，减少数据冗余性，保证数据的一致性。这种模型并不适合直接用于分析统计。</p>
<h4 id="维度模型"><a href="#维度模型" class="headerlink" title="维度模型"></a>维度模型</h4><p>数据仓库领域的令一位大师——Ralph<br>Kimball倡导的建模方法为维度建模。维度模型将复杂的业务通过事实和维度两个概念进行呈现。事实通常对应业务过程，而维度通常对应业务过程发生时所处的环境。</p>
<p><strong>注</strong>：业务过程可以概括为一个个不可拆分的行为事件，例如电商交易中的下单，取消订单，付款，退单等，都是业务过程。</p>
<p>下图为一个典型的维度模型，其中位于中心的SalesOrder为事实表，其中保存的是下单这个业务过程的所有记录。位于周围每张表都是维度表，包括Date（日期），Customer（顾客），Product（产品），Location（地区）等，这些维度表就组成了每个订单发生时所处的环境，即何人、何时、在何地下单了何种产品。从图中可以看出，模型相对清晰、简洁。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/d48645420eb5979f3550dc6589449f50.png" alt="图示 描述已自动生成"></p>
<p>维度建模以数据分析作为出发点，为数据分析服务，因此它关注的重点的用户如何更快的完成需求分析以及如何实现较好的大规模复杂查询的响应性能。</p>
<h2 id="第3章-维度建模理论之事实表"><a href="#第3章-维度建模理论之事实表" class="headerlink" title="第3章 维度建模理论之事实表"></a>第3章 维度建模理论之事实表</h2><h3 id="事实表概述"><a href="#事实表概述" class="headerlink" title="事实表概述"></a>事实表概述</h3><p>事实表作为数据仓库维度建模的核心，紧紧围绕着业务过程来设计。其包含与该业务过程有关的维度引用（维度表外键）以及该业务过程的度量（通常是可累加的数字类型字段）。</p>
<h4 id="事实表特点"><a href="#事实表特点" class="headerlink" title="事实表特点"></a>事实表特点</h4><p>事实表通常比较“细长”，即列较少，但行较多，且行的增速快。</p>
<h4 id="事实表分类"><a href="#事实表分类" class="headerlink" title="事实表分类"></a>事实表分类</h4><p>事实表有三种类型：分别是事务事实表、周期快照事实表和累积快照事实表，每种事实表都具有不同的特点和适用场景，下面逐个介绍。</p>
<h3 id="事务型事实表"><a href="#事务型事实表" class="headerlink" title="事务型事实表"></a>事务型事实表</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>事务事实表用来记录各业务过程，它保存的是各业务过程的原子操作事件，即最细粒度的操作事件。粒度是指事实表中一行数据所表达的业务细节程度。</p>
<p>事务型事实表可用于分析与各业务过程相关的各项统计指标，由于其保存了最细粒度的记录，可以提供最大限度的灵活性，可以支持无法预期的各种细节层次的统计需求。</p>
<h4 id="设计流程"><a href="#设计流程" class="headerlink" title="设计流程"></a>设计流程</h4><p>设计事务事实表时一般可遵循以下四个步骤：</p>
<p><strong>选择业务过程→声明粒度→确认维度→确认事实</strong></p>
<p><strong>1）选择业务过程</strong></p>
<p>在业务系统中，挑选我们感兴趣的业务过程，业务过程可以概括为一个个不可拆分的行为事件，例如电商交易中的下单，取消订单，付款，退单等，都是业务过程。通常情况下，一个业务过程对应一张事务型事实表。</p>
<p><strong>2）声明粒度</strong></p>
<p>业务过程确定后，需要为每个业务过程声明粒度。即精确定义每张事务型事实表的每行数据表示什么，应该尽可能选择最细粒度，以此来应各种细节程度的需求。</p>
<p><strong>典型的粒度声明如下：</strong></p>
<p>订单事实表中一行数据表示的是一个订单中的一个商品项。</p>
<p><strong>3）确定维度</strong></p>
<p>确定维度具体是指，确定与每张事务型事实表相关的维度有哪些。</p>
<p>确定维度时应尽量多的选择与业务过程相关的环境信息。因为维度的丰富程度就决定了维度模型能够支持的指标丰富程度。</p>
<p><strong>4）确定事实</strong></p>
<p>此处的“事实”一词，指的是每个业务过程的度量值（通常是可累加的数字类型的值，例如：次数、个数、件数、金额等）。</p>
<p>经过上述四个步骤，事务型事实表就基本设计完成了。第一步选择业务过程可以确定有哪些事务型事实表，第二步可以确定每张事务型事实表的每行数据是什么，第三步可以确定每张事务型事实表的维度外键，第四步可以确定每张事务型事实表的度量值字段。</p>
<h4 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h4><p>事务型事实表可以保存所有业务过程的最细粒度的操作事件，故理论上其可以支撑与各业务过程相关的各种统计粒度的需求。但对于某些特定类型的需求，其逻辑可能会比较复杂，或者效率会比较低下。例如：</p>
<p><strong>1）存量型指标</strong></p>
<p>例如商品库存，账户余额等。此处以电商中的虚拟货币为例，虚拟货币业务包含的业务过程主要包括获取货币和使用货币，两个业务过程各自对应一张事务型事实表，一张存储所有的获取货币的原子操作事件，另一张存储所有使用货币的原子操作事件。</p>
<p>假定现有一个需求，要求统计截至当日的各用户虚拟货币余额。由于获取货币和使用货币均会影响到余额，故需要对两张事务型事实表进行聚合，且需要区分两者对余额的影响（加或减），另外需要对两张表的全表数据聚合才能得到统计结果。</p>
<p>可以看到，不论是从逻辑上还是效率上考虑，这都不是一个好的方案。</p>
<p><strong>2）多事务关联统计</strong></p>
<p>例如，现需要统计最近30天，用户下单到支付的时间间隔的平均值。统计思路应该是找到下单事务事实表和支付事务事实表，过滤出最近30天的记录，然后按照订单id对两张事实表进行关联，之后用支付时间减去下单时间，然后再求平均值。</p>
<p>逻辑上虽然并不复杂，但是其效率较低，应为下单事务事实表和支付事务事实表均为大表，大表join大表的操作应尽量避免。</p>
<p>可以看到，在上述两种场景下事务型事实表的表现并不理想。下面要介绍的另外两种类型的事实表就是为了弥补事务型事实表的不足的。</p>
<h3 id="周期型快照事实表"><a href="#周期型快照事实表" class="headerlink" title="周期型快照事实表"></a>周期型快照事实表</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>周期快照事实表以具有规律性的、可预见的时间间隔来记录事实，主要用于分析一些存量型（例如商品库存，账户余额）或者状态型（空气温度，行驶速度）指标。</p>
<p>对于商品库存、账户余额这些存量型指标，业务系统中通常就会计算并保存最新结果，所以定期同步一份全量数据到数据仓库，构建周期型快照事实表，就能轻松应对此类统计需求，而无需再对事务型事实表中大量的历史记录进行聚合了。</p>
<p>对于空气温度、行驶速度这些状态型指标，由于它们的值往往是连续的，我们无法捕获其变动的原子事务操作，所以无法使用事务型事实表统计此类需求。而只能定期对其进行采样，构建周期型快照事实表。</p>
<h4 id="设计流程-1"><a href="#设计流程-1" class="headerlink" title="设计流程"></a>设计流程</h4><p><strong>1）确定粒度</strong></p>
<p>周期型快照事实表的粒度可由采样周期和维度描述，故确定采样周期和维度后即可确定粒度。</p>
<p>采样周期通常选择每日。</p>
<p>维度可根据统计指标决定，例如指标为统计每个仓库中每种商品的库存，则可确定维度为仓库和商品。</p>
<p>确定完采样周期和维度后，即可确定该表粒度为每日-仓库-商品。</p>
<p><strong>2）确认事实</strong></p>
<p>事实也可根据统计指标决定，例如指标为统计每个仓库中每种商品的库存，则事实为商品库存。</p>
<h4 id="事实类型"><a href="#事实类型" class="headerlink" title="事实类型"></a>事实类型</h4><p>此处的事实类型是指度量值的类型，而非事实表的类型。事实（度量值）共分为三类，分别是可加事实，半可加事实和不可加事实。</p>
<p><strong>1）可加事实</strong></p>
<p>可加事实是指可以按照与事实表相关的所有维度进行累加，例如事务型事实表中的事实。</p>
<p><strong>2）半可加事实</strong></p>
<p>半可加事实是指只能按照与事实表相关的一部分维度进行累加，例如周期型快照事实表中的事实。以上述各仓库中各商品的库存每天快照事实表为例，这张表中的库存事实可以按照仓库或者商品维度进行累加，但是不能按照时间维度进行累加，因为将每天的库存累加起来是没有任何意义的。</p>
<p><strong>3）不可加事实</strong></p>
<p>不可加事实是指完全不具备可加性，例如比率型事实。不可加事实通常需要转化为可加事实，例如比率可转化为分子和分母。</p>
<h3 id="累积型快照事实表"><a href="#累积型快照事实表" class="headerlink" title="累积型快照事实表"></a>累积型快照事实表</h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>累计快照事实表是基于一个业务流程中的多个关键业务过程联合处理而构建的事实表，如交易流程中的下单、支付、发货、确认收货业务过程。</p>
<p>累积型快照事实表通常具有多个日期字段，每个日期对应业务流程中的一个关键业务过程（里程碑）。</p>
<table>
<thead>
<tr>
<th>订单id</th>
<th>用户id</th>
<th>下单日期</th>
<th>支付日期</th>
<th>发货日期</th>
<th>确认收货日期</th>
<th>订单金额</th>
<th>支付金额</th>
</tr>
</thead>
<tbody><tr>
<td>1001</td>
<td>1234</td>
<td>2020-06-14</td>
<td>2020-06-15</td>
<td>2020-06-16</td>
<td>2020-06-17</td>
<td>1000</td>
<td>1000</td>
</tr>
</tbody></table>
<p>累积型快照事实表主要用于分析业务过程（里程碑）之间的时间间隔等需求。例如前文提到的用户下单到支付的平均时间间隔，使用累积型快照事实表进行统计，就能避免两个事务事实表的关联操作，从而变得十分简单高效。</p>
<h4 id="设计流程-2"><a href="#设计流程-2" class="headerlink" title="设计流程"></a>设计流程</h4><p>累积型快照事实表的设计流程同事务型事实表类似，也可采用以下四个步骤，下面重点描述与事务型事实表的不同之处。</p>
<p><strong>选择业务过程→声明粒度→确认维度→确认事实。</strong></p>
<p><strong>1）选择业务过程</strong></p>
<p>选择一个业务流程中需要关联分析的多个关键业务过程，多个业务过程对应一张累积型快照事实表。</p>
<p><strong>2）声明粒度</strong></p>
<p>精确定义每行数据表示的是什么，尽量选择最小粒度。</p>
<p><strong>3）确认维度</strong></p>
<p>选择与各业务过程相关的维度，需要注意的是，每各业务过程均需要一个日期维度。</p>
<p><strong>4）确认事实</strong></p>
<p>选择各业务过程的度量值。</p>
<h2 id="第4章-维度建模理论之维度表"><a href="#第4章-维度建模理论之维度表" class="headerlink" title="第4章 维度建模理论之维度表"></a>第4章 维度建模理论之维度表</h2><h3 id="维度表概述"><a href="#维度表概述" class="headerlink" title="维度表概述"></a>维度表概述</h3><p>维度表是维度建模的基础和灵魂。前文提到，事实表紧紧围绕业务过程进行设计，而维度表则围绕业务过程所处的环境进行设计。维度表主要包含一个主键和各种维度字段，维度字段称为维度属性。</p>
<h3 id="维度表设计步骤"><a href="#维度表设计步骤" class="headerlink" title="维度表设计步骤"></a>维度表设计步骤</h3><p><strong>1）确定维度（表）</strong></p>
<p>在设计事实表时，已经确定了与每个事实表相关的维度，理论上每个相关维度均需对应一张维度表。需要注意到，可能存在多个事实表与同一个维度都相关的情况，这种情况需保证维度的唯一性，即只创建一张维度表。另外，如果某些维度表的维度属性很少，例如只有一个**名称，则可不创建该维度表，而把该表的维度属性直接增加到与之相关的事实表中，这个操作称为<strong>维度退化</strong>。</p>
<p><strong>2）确定主维表和相关维表</strong></p>
<p>此处的主维表和相关维表均指<strong>业务系统</strong>中与某维度相关的表。例如业务系统中与商品相关的表有sku_info，spu_info，base_trademark，base_category3，base_category2，base_category1等，其中sku_info就称为商品维度的主维表，其余表称为商品维度的相关维表。维度表的粒度通常与主维表相同。</p>
<p><strong>3）确定维度属性</strong></p>
<p>确定维度属性即确定维度表字段。维度属性主要来自于业务系统中与该维度对应的主维表和相关维表。维度属性可直接从主维表或相关维表中选择，也可通过进一步加工得到。</p>
<p>确定维度属性时，需要遵循以下要求：</p>
<p><strong>（1）尽可能生成丰富的维度属性</strong></p>
<p>维度属性是后续做分析统计时的查询约束条件、分组字段的基本来源，是数据易用性的关键。维度属性的丰富程度直接影响到数据模型能够支持的指标的丰富程度。</p>
<p><strong>（2）尽量不使用编码，而使用明确的文字说明，一般可以编码和文字共存。</strong></p>
<p><strong>（3）尽量沉淀出通用的维度属性</strong></p>
<p>有些维度属性的获取需要进行比较复杂的逻辑处理，例如需要通过多个字段拼接得到。为避免后续每次使用时的重复处理，可将这些维度属性沉淀到维度表中。</p>
<h3 id="维度设计要点"><a href="#维度设计要点" class="headerlink" title="维度设计要点"></a>维度设计要点</h3><h4 id="规范化与反规范化"><a href="#规范化与反规范化" class="headerlink" title="规范化与反规范化"></a>规范化与反规范化</h4><p><strong>规范化</strong>是指使用一系列范式设计数据库的过程，其目的是减少数据冗余，增强数据的一致性。通常情况下，规范化之后，一张表的字段会拆分到多张表。</p>
<p><strong>反规范化</strong>是指将多张表的数据冗余到一张表，其目的是减少join操作，提高查询性能。</p>
<p>在设计维度表时，如果对其进行规范化，得到的维度模型称为雪花模型，如果对其进行反规范化，得到的模型称为星型模型。</p>
<p>数据仓库系统的主要目的是用于数据分析和统计，所以是否方便用户进行统计分析决定了模型的优劣。采用雪花模型，用户在统计分析的过程中需要大量的关联操作，使用复杂度高，同时查询性能很差，而采用星型模型，则方便、易用且性能好。所以出于易用性和性能的考虑，维度表一般是很不规范化的。</p>
<h4 id="维度变化"><a href="#维度变化" class="headerlink" title="维度变化"></a>维度变化</h4><p>维度属性通常不是静态的，而是会随时间变化的，数据仓库的一个重要特点就是反映历史的变化，所以如何保存维度的历史状态是维度设计的重要工作之一。保存维度数据的历史状态，通常有以下两种做法，分别是全量快照表和拉链表。</p>
<p><strong>1）全量快照表</strong></p>
<p>离线数据仓库的计算周期通常为每天一次，所以可以每天保存一份全量的维度数据。这种方式的优点和缺点都很明显。</p>
<p>优点是简单而有效，开发和维护成本低，且方便理解和使用。</p>
<p>缺点是浪费存储空间，尤其是当数据的变化比例比较低时。</p>
<p><strong>2）拉链表</strong></p>
<p>拉链表的意义就在于能够更加高效的保存维度信息的历史状态。</p>
<p><strong>（1）什么是拉链表</strong></p>
<p><strong>（2）为什么要做拉链表</strong></p>
<p><strong>（3）如何使用拉链表</strong></p>
<h4 id="多值维度"><a href="#多值维度" class="headerlink" title="多值维度"></a>多值维度</h4><p>如果事实表中一条记录在某个维度表中有多条记录与之对应，称为多值维度。例如，下单事实表中的一条记录为一个订单，一个订单可能包含多个商品，所会商品维度表中就可能有多条数据与之对应。</p>
<p>针对这种情况，通常采用以下两种方案解决。</p>
<p>第一种：降低事实表的粒度，例如将订单事实表的粒度由一个订单降低为一个订单中的一个商品项。</p>
<p>第二种：在事实表中采用多字段保存多个维度值，每个字段保存一个维度id。这种方案只适用于多值维度个数固定的情况。</p>
<p>建议尽量采用第一种方案解决多值维度问题。</p>
<h4 id="多值属性"><a href="#多值属性" class="headerlink" title="多值属性"></a>多值属性</h4><p>维表中的某个属性同时有多个值，称之为“多值属性”，例如商品维度的平台属性和销售属性，每个商品均有多个属性值。</p>
<p>针对这种情况，通常有可以采用以下两种方案。</p>
<p>第一种：将多值属性放到一个字段，该字段内容为key1:value1，key2:value2的形式，例如一个手机商品的平台属性值为“品牌:华为，系统:鸿蒙，CPU:麒麟990”。</p>
<p>第二种：将多值属性放到多个字段，每个字段对应一个属性。这种方案只适用于多值属性个数固定的情况。</p>
<h2 id="第5章-数据仓库设计"><a href="#第5章-数据仓库设计" class="headerlink" title="第5章 数据仓库设计"></a>第5章 数据仓库设计</h2><h3 id="数据仓库分层规划"><a href="#数据仓库分层规划" class="headerlink" title="数据仓库分层规划"></a>数据仓库分层规划</h3><p>优秀可靠的数仓体系，需要良好的数据分层结构。合理的分层，能够使数据体系更加清晰，使复杂问题得以简化。以下是该项目的分层规划。</p>
<h3 id="数据仓库构建流程"><a href="#数据仓库构建流程" class="headerlink" title="数据仓库构建流程"></a>数据仓库构建流程</h3><p>以下是构建数据仓库的完整流程。</p>
<h4 id="数据调研"><a href="#数据调研" class="headerlink" title="数据调研"></a>数据调研</h4><p>数据调研重点要做两项工作，分别是业务调研和需求分析。这两项工作做的是否充分，直接影响着数据仓库的质量。</p>
<p><strong>1）业务调研</strong></p>
<p>业务调研的主要目标是<strong>熟悉业务流程</strong>、<strong>熟悉业务数据</strong>。</p>
<p><strong>熟悉业务流程</strong>要求做到，明确每个业务的具体流程，需要将该业务所包含的每个<strong>业务过程</strong>一一列举出来。</p>
<p><strong>熟悉业务数据</strong>要求做到，将数据（包括埋点日志和业务数据表）与业务过程对应起来，明确每个业务过程会对哪些表的数据产生影响，以及产生什么影响。产生的影响，需要具体到，是新增一条数据，还是修改一条数据，并且需要明确新增的内容或者是修改的逻辑。</p>
<p>下面业务电商中的交易为例进行演示，交易业务涉及到的业务过程有买家下单、买家支付、卖家发货，买家收货，具体流程如下图。</p>
<p><strong>2）需求分析</strong></p>
<p>典型的需求指标如，最近一天各省份手机品类订单总额。</p>
<p>分析需求时，需要明确需求所需的<strong>业务过程</strong>及<strong>维度</strong>，例如该需求所需的业务过程就是买家下单，所需的维度有日期，省份，商品品类。</p>
<p><strong>3）总结</strong></p>
<p>做完业务分析和需求分析之后，要保证每个需求都能找到与之对应的业务过程及维度。若现有数据无法满足需求，则需要和业务方进行沟通，例如某个页面需要新增某个行为的埋点。</p>
<h4 id="明确数据域"><a href="#明确数据域" class="headerlink" title="明确数据域"></a>明确数据域</h4><p>数据仓库模型设计除横向的分层外，通常也需要根据业务情况进行纵向划分数据域。</p>
<p>划分数据域的意义是<strong>便于数据的管理和应用</strong>。</p>
<p>通常可以根据业务过程或者部门进行划分，本项目根据业务过程进行划分，需要注意的是一个业务过程只能属于一个数据域。</p>
<p>下面是本数仓项目所需的所有业务过程及数据域划分详情。</p>
<table>
<thead>
<tr>
<th>数据域</th>
<th>业务过程</th>
</tr>
</thead>
<tbody><tr>
<td>交易域</td>
<td>加购、下单、取消订单、支付成功、退单、退款成功</td>
</tr>
<tr>
<td>流量域</td>
<td>页面浏览、启动应用、动作、曝光、错误</td>
</tr>
<tr>
<td>用户域</td>
<td>注册、登录</td>
</tr>
<tr>
<td>互动域</td>
<td>收藏、评价</td>
</tr>
<tr>
<td>工具域</td>
<td>优惠券领取、优惠券使用（下单）、优惠券使用（支付）</td>
</tr>
</tbody></table>
<h4 id="构建业务总线矩阵"><a href="#构建业务总线矩阵" class="headerlink" title="构建业务总线矩阵"></a>构建业务总线矩阵</h4><p>业务总线矩阵中包含维度模型所需的所有事实（业务过程）以及维度，以及各业务过程与各维度的关系。矩阵的行是一个个业务过程，矩阵的列是一个个的维度，行列的交点表示业务过程与维度的关系。</p>
<p>一个业务过程对应维度模型中一张事务型事实表，一个维度则对应维度模型中的一张维度表。所以构建业务总线矩阵的过程就是设计维度模型的过程。但是需要注意的是，总线矩阵中通常只包含事务型事实表，另外两种类型的事实表需单独设计。</p>
<p>按照事务型事实表的设计流程，<strong>选择业务过程声明粒度确认维度确认事实</strong>，得到的最终的业务总线矩阵见以下表格。</p>
<p>后续的DWD层以及DIM层的搭建需参考业务总线矩阵。</p>
<h4 id="明确统计指标"><a href="#明确统计指标" class="headerlink" title="明确统计指标"></a>明确统计指标</h4><p>明确统计指标具体的工作是，深入分析需求，构建指标体系。构建指标体系的主要意义就是指标定义标准化。所有指标的定义，都必须遵循同一套标准，这样能有效的避免指标定义存在歧义，指标定义重复等问题。</p>
<p><strong>1）指标体系相关概念</strong></p>
<p><strong>（1）原子指标</strong></p>
<p>原子指标基于某一<strong>业务过程</strong>的<strong>度量值</strong>，是业务定义中不可再拆解的指标，原子指标的核心功能就是对指标的<strong>聚合逻辑</strong>进行了定义。我们可以得出结论，原子指标包含三要素，分别是业务过程、度量值和聚合逻辑。</p>
<p>例如<strong>订单总额</strong>就是一个典型的原子指标，其中的业务过程为用户下单、度量值为订单金额，聚合逻辑为sum()求和。需要注意的是原子指标只是用来辅助定义指标一个概念，通常不会对应有实际统计需求与之对应。</p>
<p><strong>（2）派生指标</strong></p>
<p>派生指标基于原子指标，其与原子指标的关系如下图所示。</p>
<p>与原子指标不同，派生指标通常会对应实际的统计需求。请从图中的例子中，体会指标定义标准化的含义。</p>
<p><strong>（3）衍生指标</strong></p>
<p>衍生指标是在一个或多个派生指标的基础上，通过各种逻辑运算复合而成的。例如比率、比例等类型的指标。衍生指标也会对应实际的统计需求。</p>
<p><strong>2）指标体系对于数仓建模的意义</strong></p>
<p>通过上述两个具体的案例可以看出，绝大多数的统计需求，都可以使用原子指标、派生指标以及衍生指标这套标准去定义。同时能够发现这些统计需求都直接的或间接的对应一个或者是多个派生指标。</p>
<p>当统计需求足够多时，必然会出现部分统计需求对应的派生指标相同的情况。这种情况下，我们就可以考虑将这些公共的派生指标保存下来，这样做的主要目的就是减少重复计算，提高数据的复用性。</p>
<p>这些公共的派生指标统一保存在数据仓库的DWS层。因此DWS层设计，就可以参考我们根据现有的统计需求整理出的派生指标。</p>
<p>按照上述标准整理出的指标体系如下：</p>
<p>（1）思维导图版</p>
<p>（2）PDF版</p>
<p>从上述指标体系中抽取出来的所有派生指标见如下表格。</p>
<h4 id="维度模型设计"><a href="#维度模型设计" class="headerlink" title="维度模型设计"></a>维度模型设计</h4><p>维度模型的设计参照上述得到的业务总线矩阵即可。事实表存储在DWD层，维度表存储在DIM层。</p>
<h4 id="汇总模型设计"><a href="#汇总模型设计" class="headerlink" title="汇总模型设计"></a>汇总模型设计</h4><p>汇总模型的设计参考上述整理出的指标体系（主要是派生指标）即可。汇总表与派生指标的对应关系是，<strong>一张汇总</strong>表通常<strong>包含</strong>业务过程相同、统计周期相同、统计粒度相同的<strong>多个派生指标</strong>。请思考：汇总表与事实表的对应关系是？</p>
<h2 id="第6章-数据仓库环境准备"><a href="#第6章-数据仓库环境准备" class="headerlink" title="第6章 数据仓库环境准备"></a>第6章 数据仓库环境准备</h2><h3 id="数据仓库运行环境"><a href="#数据仓库运行环境" class="headerlink" title="数据仓库运行环境"></a>数据仓库运行环境</h3><h4 id="Hive环境搭建"><a href="#Hive环境搭建" class="headerlink" title="Hive环境搭建"></a>Hive环境搭建</h4><p><strong>1）Hive引擎简介</strong></p>
<p>Hive引擎包括：默认MR、tez、spark</p>
<p>Hive on<br>Spark：Hive既作为存储元数据又负责SQL的解析优化，语法是HQL语法，执行引擎变成了Spark，Spark负责采用RDD执行。</p>
<p>Spark on Hive : Hive只作为存储元数据，Spark负责SQL解析优化，语法是Spark<br>SQL语法，Spark负责采用RDD执行。</p>
<p><strong>2）Hive on Spark配置</strong></p>
<p><strong>（1）兼容性说明</strong></p>
<p>注意：官网下载的Hive3.1.2和Spark3.0.0默认是不兼容的。因为Hive3.1.2支持的Spark版本是2.4.5，所以需要我们重新编译Hive3.1.2版本。</p>
<p>编译步骤：官网下载Hive3.1.2源码，修改pom文件中引用的Spark版本为3.0.0，如果编译通过，直接打包获取jar包。如果报错，就根据提示，修改相关方法，直到不报错，打包获取jar包。</p>
<p><strong>（2）在Hive所在节点部署Spark</strong></p>
<p>如果之前已经部署了Spark，则该步骤可以跳过</p>
<p>Spark官网下载jar包地址：</p>
<p><a target="_blank" rel="noopener" href="http://spark.apache.org/downloads.html">http://spark.apache.org/downloads.html</a></p>
<p>上传并解压解压spark-3.0.0-bin-hadoop3.2.tgz</p>
<p>[atguigu@hadoop102 software]$ tar -zxvf spark-3.0.0-bin-hadoop3.2.tgz -C<br>/opt/module/</p>
<p>[atguigu@hadoop102 software]$ mv /opt/module/spark-3.0.0-bin-hadoop3.2<br>/opt/module/spark</p>
<p><strong>（3）配置SPARK_HOME环境变量</strong></p>
<p>[atguigu@hadoop102 software]$ sudo vim /etc/profile.d/my_env.sh</p>
<p>添加如下内容</p>
<p>## SPARK_HOME</p>
<p>export SPARK_HOME=/opt/module/spark</p>
<p>export PATH=$PATH:$SPARK_HOME/bin</p>
<p>source 使其生效</p>
<p>[atguigu@hadoop102 software]$ source /etc/profile.d/my_env.sh</p>
<p><strong>（4）在hive中创建spark配置文件</strong></p>
<p>[atguigu@hadoop102 software]$ vim /opt/module/hive/conf/spark-defaults.conf</p>
<p>添加如下内容（在执行任务时，会根据如下参数执行）</p>
<p>spark.master yarn</p>
<p>spark.eventLog.enabled true</p>
<p>spark.eventLog.dir hdfs://hadoop102:8020/spark-history</p>
<p>spark.executor.memory 1g</p>
<p>spark.driver.memory 1g</p>
<p>在HDFS创建如下路径，用于存储历史日志</p>
<p>[atguigu@hadoop102 software]$ hadoop fs -mkdir /spark-history</p>
<p><strong>（5）向HDFS上传Spark纯净版jar包</strong></p>
<p>说明1：由于Spark3.0.0非纯净版默认支持的是hive2.3.7版本，直接使用会和安装的Hive3.1.2出现兼容性问题。所以采用Spark纯净版jar包，不包含hadoop和hive相关依赖，避免冲突。</p>
<p>说明2：Hive任务最终由Spark来执行，Spark任务资源分配由Yarn来调度，该任务有可能被分配到集群的任何一个节点。所以需要将Spark的依赖上传到HDFS集群路径，这样集群中任何一个节点都能获取到。</p>
<p>上传并解压spark-3.0.0-bin-without-hadoop.tgz</p>
<p>[atguigu@hadoop102 software]$ tar -zxvf<br>/opt/software/spark-3.0.0-bin-without-hadoop.tgz</p>
<p>上传Spark纯净版jar包到HDFS</p>
<p>[atguigu@hadoop102 software]$ hadoop fs -mkdir /spark-jars</p>
<p>[atguigu@hadoop102 software]$ hadoop fs -put<br>spark-3.0.0-bin-without-hadoop/jars/* /spark-jars</p>
<p><strong>（6）修改hive-site.xml文件</strong></p>
<p>[atguigu@hadoop102 ~]$ vim /opt/module/hive/conf/hive-site.xml</p>
<p>添加如下内容</p>
<p>&lt;!–Spark依赖位置（注意：端口号8020必须和namenode的端口号一致）–&gt;</p>
<p>&lt;property&gt;</p>
<p>&lt;name&gt;spark.yarn.jars&lt;/name&gt;</p>
<p>&lt;value&gt;hdfs://hadoop102:8020/spark-jars/*&lt;/value&gt;</p>
<p>&lt;/property&gt;</p>
<p>&lt;!–Hive执行引擎–&gt;</p>
<p>&lt;property&gt;</p>
<p>&lt;name&gt;hive.execution.engine&lt;/name&gt;</p>
<p>&lt;value&gt;spark&lt;/value&gt;</p>
<p>&lt;/property&gt;</p>
<p><strong>3）Hive on Spark测试</strong></p>
<p>（1）启动hive客户端</p>
<p>[atguigu@hadoop102 hive]$ bin/hive</p>
<p>（2）创建一张测试表</p>
<p>hive (default)&gt; create table student(id int, name string);</p>
<p>（3）通过insert测试效果</p>
<p>hive (default)&gt; insert into table student values(1,’abc’);</p>
<p>若结果如下，则说明配置成功</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/bce7a0b2e183b0457f5cdde8c162d748.png" alt="日程表 中度可信度描述已自动生成"></p>
<h4 id="Yarn环境配置"><a href="#Yarn环境配置" class="headerlink" title="Yarn环境配置"></a>Yarn环境配置</h4><p><strong>1）增加ApplicationMaster资源比例</strong></p>
<p>容量调度器对每个资源队列中同时运行的Application<br>Master占用的资源进行了限制，该限制通过yarn.scheduler.capacity.maximum-am-resource-percent参数实现，其默认值是0.1，表示每个资源队列上Application<br>Master最多可使用的资源为该队列总资源的10%，目的是防止大部分资源都被Application<br>Master占用，而导致Map/Reduce Task无法执行。</p>
<p>生产环境该参数可使用默认值。但学习环境，集群资源总数很少，如果只分配10%的资源给Application<br>Master，则可能出现，同一时刻只能运行一个Job的情况，因为一个Application<br>Master使用的资源就可能已经达到10%的上限了。故此处可将该值适当调大。</p>
<p>（1）在hadoop102的/opt/module/hadoop-3.1.3/etc/hadoop/capacity-scheduler.xml文件中<strong>修改</strong>如下参数值</p>
<p>[atguigu@hadoop102 hadoop]$ vim capacity-scheduler.xml</p>
<p>&lt;property&gt;</p>
<p>&lt;name&gt;yarn.scheduler.capacity.maximum-am-resource-percent&lt;/name&gt;</p>
<p>&lt;value&gt;0.8&lt;/value&gt;</p>
<p>&lt;/property</p>
<p>（2）分发capacity-scheduler.xml配置文件</p>
<p>[atguigu@hadoop102 hadoop]$ xsync capacity-scheduler.xml</p>
<p>（3）关闭正在运行的任务，重新启动yarn集群</p>
<p>[atguigu@hadoop103 hadoop-3.1.3]$ sbin/stop-yarn.sh</p>
<p>[atguigu@hadoop103 hadoop-3.1.3]$ sbin/start-yarn.sh</p>
<h3 id="数据仓库开发环境"><a href="#数据仓库开发环境" class="headerlink" title="数据仓库开发环境"></a>数据仓库开发环境</h3><p>数仓开发工具可选用DBeaver或者DataGrip。两者都需要用到JDBC协议连接到Hive，故需要启动HiveServer2。</p>
<p><strong>1）启动HiveServer2</strong></p>
<p>[atguigu@hadoop102 hive]$ hiveserver2</p>
<p><strong>2）配置DataGrip连接</strong></p>
<p><strong>（1）创建连接</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/2c4f63c096e1079aa93cfc2317b65f36.png" alt="图形用户界面, 文本, 应用程序, 电子邮件
描述已自动生成"></p>
<p><strong>（2）配置连接属性</strong></p>
<p>所有属性配置，和Hive的beeline客户端配置一致即可。初次使用，配置过程会提示缺少JDBC驱动，按照提示下载即可。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/8abb9efbe0512cd0f64fabdaaa697e1d.png" alt="图形用户界面, 应用程序, 电子邮件
描述已自动生成"></p>
<p><strong>3）测试使用</strong></p>
<p><strong>创建数据库gmall，并观察是否创建成功。</strong></p>
<p><strong>（1）创建数据库</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/776073b0a8029c742544c71c93991b7d.png" alt="图形用户界面, 文本, 应用程序
描述已自动生成"></p>
<p><strong>（2）查看数据库</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/fa877779fb43f2aa89a925ddbe79f537.png" alt="图形用户界面, 应用程序, Word
描述已自动生成"></p>
<p><strong>（3）修改连接，指明连接数据库</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/9fea377dcc34e3844f0d14dae5db060e.png" alt="图形用户界面, 文本, 应用程序, 电子邮件
描述已自动生成"></p>
<p><strong>（4）选择当前数据库为gmall</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/5e6b5bfea4448d2ea28ef971eeaadaee.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<h3 id="模拟数据准备"><a href="#模拟数据准备" class="headerlink" title="模拟数据准备"></a>模拟数据准备</h3><p>通常企业在开始搭建数仓时，业务系统中会存在历史数据，一般是业务数据库存在历史数据，而用户行为日志无历史数据。假定数仓上线的日期为2020-06-14，为模拟真实场景，需准备以下数据。</p>
<p>注：在执行以下操作之前，先将HDFS上/origin_data路径下之前的数据删除。</p>
<p><strong>1）用户行为日志</strong></p>
<p>用户行为日志，一般是没有历史数据的，故日志只需要准备2020-06-14一天的数据。具体操作如下：</p>
<p>（1）启动日志采集通道，包括Flume、Kafak等</p>
<p>（2）修改两个日志服务器（hadoop102、hadoop103）中的</p>
<p>/opt/module/applog/application.yml配置文件，将mock.date参数改为2020-06-14。</p>
<p>（3）执行日志生成脚本lg.sh。</p>
<p>（4）观察HDFS是否出现相应文件。</p>
<p><strong>2）业务数据</strong></p>
<p>业务数据一般存在历史数据，此处需准备2020-06-10至2020-06-14的数据。具体操作如下。</p>
<p><strong>（1）生成模拟数据</strong></p>
<p>修改hadoop102节点上的/opt/module/db_log/application.properties文件，将mock.date、mock.clear，mock.clear.user三个参数调整为如图所示的值。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/928174bb07164efac9511dbf482a878f.png" alt="文本 描述已自动生成"></p>
<p>执行模拟生成业务数据的命令，生成第一天2020-06-10的历史数据。</p>
<p>[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2021-01-22.jar</p>
<p>修改/opt/module/db_log/application.properties文件，将mock.date、mock.clear，mock.clear.user三个参数调整为如图所示的值。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/10f27d1b2dceed818de8b1a8b4de20fa.png" alt="文本 描述已自动生成"></p>
<p>执行模拟生成业务数据的命令，生成第二天2020-06-11的历史数据。</p>
<p>[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2021-10-10.jar</p>
<p>之后只修改/opt/module/db_log/application.properties文件中的mock.date参数，依次改为2020-06-12，2020-06-13，2020-06-14，并分别生成对应日期的数据。</p>
<p><strong>（2）全量表同步</strong></p>
<p>执行全量表同步脚本</p>
<p>[atguigu@hadoop102 bin]$ mysql_to_hdfs_full.sh all 2020-06-14</p>
<p>观察HDFS上是否出现全量表数据</p>
<p><strong>（3）增量表首日全量同步</strong></p>
<p>清除Maxwell断点记录</p>
<p>由于Maxwell支持断点续传，而上述重新生成业务数据的过程，会产生大量的binlog操作日志，这些日志我们并不需要。故此处需清除Maxwell的断点记录，另其从binlog最新的位置开始采集。</p>
<p>关闭Maxwell</p>
<p>[atguigu@hadoop102 bin]$ mxw.sh stop</p>
<p>清空Maxwell数据库，相当于初始化Maxwell</p>
<p>mysql&gt;</p>
<p>drop table maxwell.bootstrap;</p>
<p>drop table maxwell.columns;</p>
<p>drop table maxwell.databases;</p>
<p>drop table maxwell.heartbeats;</p>
<p>drop table maxwell.positions;</p>
<p>drop table maxwell.schemas;</p>
<p>drop table maxwell.tables;</p>
<p>修改Maxwell配置文件中的mock_date参数</p>
<p>[atguigu@hadoop102 maxwell]$ vim /opt/module/maxwell/config.properties</p>
<p><strong>mock_date=2020-06-14</strong></p>
<p>启动增量表数据通道，包括Maxwell、Kafka、Flume</p>
<p>执行增量表首日全量同步脚本</p>
<p>[atguigu@hadoop102 bin]$ mysql_to_kafka_inc_init.sh all</p>
<p>观察HDFS上是否出现全量表数据</p>
<h2 id="第7章-数仓开发之ODS层"><a href="#第7章-数仓开发之ODS层" class="headerlink" title="第7章 数仓开发之ODS层"></a>第7章 数仓开发之ODS层</h2><p>ODS层的设计要点如下：</p>
<p>1）ODS层的表结构设计依托于从业务系统同步过来的数据结构。</p>
<p>2）ODS层要保存全部历史数据，故其压缩格式应选择压缩比较高的，此处选择gzip。</p>
<p>3）ODS层表名的命名规范为：ods_表名_单分区增量全量标识（inc/full）。</p>
<h3 id="日志表"><a href="#日志表" class="headerlink" title="日志表"></a>日志表</h3><p><strong>1）建表数据</strong></p>
<p>DROP TABLE IF EXISTS ods_log_inc;</p>
<p>CREATE EXTERNAL TABLE ods_log_inc</p>
<p>(</p>
<p>`common` STRUCT&lt;ar :STRING,ba :STRING,ch :STRING,is_new :STRING,md<br>:STRING,mid :STRING,os :STRING,uid :STRING,vc</p>
<p>:STRING&gt; COMMENT ‘公共信息’,</p>
<p>`page` STRUCT&lt;during_time :STRING,item :STRING,item_type :STRING,last_page_id<br>:STRING,page_id</p>
<p>:STRING,source_type :STRING&gt; COMMENT ‘页面信息’,</p>
<p>`actions`<br>ARRAY&lt;STRUCT&lt;action_id:STRING,item:STRING,item_type:STRING,ts:BIGINT&gt;&gt;<br>COMMENT ‘动作信息’,</p>
<p>`displays` ARRAY&lt;STRUCT&lt;display_type :STRING,item :STRING,item_type<br>:STRING,`order` :STRING,pos_id</p>
<p>:STRING&gt;&gt; COMMENT ‘曝光信息’,</p>
<p>`start` STRUCT&lt;entry :STRING,loading_time :BIGINT,open_ad_id<br>:BIGINT,open_ad_ms :BIGINT,open_ad_skip_ms</p>
<p>:BIGINT&gt; COMMENT ‘启动信息’,</p>
<p>`err` STRUCT&lt;error_code:BIGINT,msg:STRING&gt; COMMENT ‘错误信息’,</p>
<p>`ts` BIGINT COMMENT ‘时间戳’</p>
<p>) COMMENT ‘活动信息表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_log_inc/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>load data inpath ‘/origin_data/gmall/log/topic_log/2020-06-14’ into table<br>ods_log_inc partition(dt=’2020-06-14’);</p>
<p><strong>3）每日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建hdfs_to_ods_log.sh</p>
<p>[atguigu@hadoop102 bin]$ vim hdfs_to_ods_log.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>## 定义变量方便修改</p>
<p>APP=gmall</p>
<p>## 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$1” ] ;then</p>
<p>do_date=$1</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>echo ================== 日志日期为 $do_date ==================</p>
<p>sql=”</p>
<p>load data inpath ‘/origin_data/$APP/log/topic_log/$do_date’ into table<br>${APP}.ods_log_inc partition(dt=’$do_date’);</p>
<p>“</p>
<p>hive -e “$sql”</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x hdfs_to_ods_log.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ hdfs_to_ods_log.sh 2020-06-14</p>
<h3 id="业务表"><a href="#业务表" class="headerlink" title="业务表"></a>业务表</h3><h4 id="活动信息表（全量表）"><a href="#活动信息表（全量表）" class="headerlink" title="活动信息表（全量表）"></a>活动信息表（全量表）</h4><p>DROP TABLE IF EXISTS ods_activity_info_full;</p>
<p>CREATE EXTERNAL TABLE ods_activity_info_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘活动id’,</p>
<p>`activity_name` STRING COMMENT ‘活动名称’,</p>
<p>`activity_type` STRING COMMENT ‘活动类型’,</p>
<p>`activity_desc` STRING COMMENT ‘活动描述’,</p>
<p>`start_time` STRING COMMENT ‘开始时间’,</p>
<p>`end_time` STRING COMMENT ‘结束时间’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’</p>
<p>) COMMENT ‘活动信息表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_activity_info_full/‘;</p>
<h4 id="活动规则表（全量表）"><a href="#活动规则表（全量表）" class="headerlink" title="活动规则表（全量表）"></a>活动规则表（全量表）</h4><p>DROP TABLE IF EXISTS ods_activity_rule_full;</p>
<p>CREATE EXTERNAL TABLE ods_activity_rule_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`activity_id` STRING COMMENT ‘类型’,</p>
<p>`activity_type` STRING COMMENT ‘活动类型’,</p>
<p>`condition_amount` DECIMAL(16, 2) COMMENT ‘满减金额’,</p>
<p>`condition_num` BIGINT COMMENT ‘满减件数’,</p>
<p>`benefit_amount` DECIMAL(16, 2) COMMENT ‘优惠金额’,</p>
<p>`benefit_discount` DECIMAL(16, 2) COMMENT ‘优惠折扣’,</p>
<p>`benefit_level` STRING COMMENT ‘优惠级别’</p>
<p>) COMMENT ‘活动规则表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_activity_rule_full/‘;</p>
<h4 id="一级品类表（全量表）"><a href="#一级品类表（全量表）" class="headerlink" title="一级品类表（全量表）"></a>一级品类表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_category1_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_category1_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`name` STRING COMMENT ‘分类名称’</p>
<p>) COMMENT ‘一级品类表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_category1_full/‘;</p>
<h4 id="二级品类表（全量表）"><a href="#二级品类表（全量表）" class="headerlink" title="二级品类表（全量表）"></a>二级品类表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_category2_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_category2_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`name` STRING COMMENT ‘二级分类名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类编号’</p>
<p>) COMMENT ‘二级品类表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_category2_full/‘;</p>
<h4 id="三级品类表（全量表）"><a href="#三级品类表（全量表）" class="headerlink" title="三级品类表（全量表）"></a>三级品类表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_category3_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_category3_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`name` STRING COMMENT ‘三级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘二级分类编号’</p>
<p>) COMMENT ‘三级品类表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_category3_full/‘;</p>
<h4 id="编码字典表（全量表）"><a href="#编码字典表（全量表）" class="headerlink" title="编码字典表（全量表）"></a>编码字典表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_dic_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_dic_full</p>
<p>(</p>
<p>`dic_code` STRING COMMENT ‘编号’,</p>
<p>`dic_name` STRING COMMENT ‘编码名称’,</p>
<p>`parent_code` STRING COMMENT ‘父编号’,</p>
<p>`create_time` STRING COMMENT ‘创建日期’,</p>
<p>`operate_time` STRING COMMENT ‘修改日期’</p>
<p>) COMMENT ‘编码字典表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_dic_full/‘;</p>
<h4 id="省份表（全量表）"><a href="#省份表（全量表）" class="headerlink" title="省份表（全量表）"></a>省份表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_province_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_province_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`name` STRING COMMENT ‘省份名称’,</p>
<p>`region_id` STRING COMMENT ‘地区ID’,</p>
<p>`area_code` STRING COMMENT ‘地区编码’,</p>
<p>`iso_code` STRING COMMENT ‘旧版ISO-3166-2编码，供可视化使用’,</p>
<p>`iso_3166_2` STRING COMMENT ‘新版IOS-3166-2编码，供可视化使用’</p>
<p>) COMMENT ‘省份表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_province_full/‘;</p>
<h4 id="地区表（全量表）"><a href="#地区表（全量表）" class="headerlink" title="地区表（全量表）"></a>地区表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_region_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_region_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`region_name` STRING COMMENT ‘地区名称’</p>
<p>) COMMENT ‘地区表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_region_full/‘;</p>
<h4 id="品牌表（全量表）"><a href="#品牌表（全量表）" class="headerlink" title="品牌表（全量表）"></a>品牌表（全量表）</h4><p>DROP TABLE IF EXISTS ods_base_trademark_full;</p>
<p>CREATE EXTERNAL TABLE ods_base_trademark_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`logo_url` STRING COMMENT ‘品牌logo的图片路径’</p>
<p>) COMMENT ‘品牌表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_base_trademark_full/‘;</p>
<h4 id="购物车表（全量表）"><a href="#购物车表（全量表）" class="headerlink" title="购物车表（全量表）"></a>购物车表（全量表）</h4><p>DROP TABLE IF EXISTS ods_cart_info_full;</p>
<p>CREATE EXTERNAL TABLE ods_cart_info_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`cart_price` DECIMAL(16, 2) COMMENT ‘放入购物车时价格’,</p>
<p>`sku_num` BIGINT COMMENT ‘数量’,</p>
<p>`img_url` BIGINT COMMENT ‘商品图片地址’,</p>
<p>`sku_name` STRING COMMENT ‘sku名称 (冗余)’,</p>
<p>`is_checked` STRING COMMENT ‘是否被选中’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’,</p>
<p>`operate_time` STRING COMMENT ‘修改时间’,</p>
<p>`is_ordered` STRING COMMENT ‘是否已经下单’,</p>
<p>`order_time` STRING COMMENT ‘下单时间’,</p>
<p>`source_type` STRING COMMENT ‘来源类型’,</p>
<p>`source_id` STRING COMMENT ‘来源编号’</p>
<p>) COMMENT ‘购物车全量表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_cart_info_full/‘;</p>
<h4 id="优惠券信息表（全量表）"><a href="#优惠券信息表（全量表）" class="headerlink" title="优惠券信息表（全量表）"></a>优惠券信息表（全量表）</h4><p>DROP TABLE IF EXISTS ods_coupon_info_full;</p>
<p>CREATE EXTERNAL TABLE ods_coupon_info_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘购物券编号’,</p>
<p>`coupon_name` STRING COMMENT ‘购物券名称’,</p>
<p>`coupon_type` STRING COMMENT ‘购物券类型 1 现金券 2 折扣券 3 满减券 4<br>满件打折券’,</p>
<p>`condition_amount` DECIMAL(16, 2) COMMENT ‘满额数’,</p>
<p>`condition_num` BIGINT COMMENT ‘满件数’,</p>
<p>`activity_id` STRING COMMENT ‘活动编号’,</p>
<p>`benefit_amount` DECIMAL(16, 2) COMMENT ‘减金额’,</p>
<p>`benefit_discount` DECIMAL(16, 2) COMMENT ‘折扣’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’,</p>
<p>`range_type` STRING COMMENT ‘范围类型 1、商品 2、品类 3、品牌’,</p>
<p>`limit_num` BIGINT COMMENT ‘最多领用次数’,</p>
<p>`taken_count` BIGINT COMMENT ‘已领用次数’,</p>
<p>`start_time` STRING COMMENT ‘开始领取时间’,</p>
<p>`end_time` STRING COMMENT ‘结束领取时间’,</p>
<p>`operate_time` STRING COMMENT ‘修改时间’,</p>
<p>`expire_time` STRING COMMENT ‘过期时间’</p>
<p>) COMMENT ‘优惠券信息表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_coupon_info_full/‘;</p>
<h4 id="商品平台属性表（全量表）"><a href="#商品平台属性表（全量表）" class="headerlink" title="商品平台属性表（全量表）"></a>商品平台属性表（全量表）</h4><p>DROP TABLE IF EXISTS ods_sku_attr_value_full;</p>
<p>CREATE EXTERNAL TABLE ods_sku_attr_value_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`attr_id` STRING COMMENT ‘平台属性ID’,</p>
<p>`value_id` STRING COMMENT ‘平台属性值ID’,</p>
<p>`sku_id` STRING COMMENT ‘商品ID’,</p>
<p>`attr_name` STRING COMMENT ‘平台属性名称’,</p>
<p>`value_name` STRING COMMENT ‘平台属性值名称’</p>
<p>) COMMENT ‘sku平台属性表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_sku_attr_value_full/‘;</p>
<h4 id="商品表（全量表）"><a href="#商品表（全量表）" class="headerlink" title="商品表（全量表）"></a>商品表（全量表）</h4><p>DROP TABLE IF EXISTS ods_sku_info_full;</p>
<p>CREATE EXTERNAL TABLE ods_sku_info_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘skuId’,</p>
<p>`spu_id` STRING COMMENT ‘spuid’,</p>
<p>`price` DECIMAL(16, 2) COMMENT ‘价格’,</p>
<p>`sku_name` STRING COMMENT ‘商品名称’,</p>
<p>`sku_desc` STRING COMMENT ‘商品描述’,</p>
<p>`weight` DECIMAL(16, 2) COMMENT ‘重量’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`category3_id` STRING COMMENT ‘品类id’,</p>
<p>`sku_default_igm` STRING COMMENT ‘商品图片地址’,</p>
<p>`is_sale` STRING COMMENT ‘是否在售’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’</p>
<p>) COMMENT ‘SKU商品表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_sku_info_full/‘;</p>
<h4 id="商品销售属性值表（全量表）"><a href="#商品销售属性值表（全量表）" class="headerlink" title="商品销售属性值表（全量表）"></a>商品销售属性值表（全量表）</h4><p>DROP TABLE IF EXISTS ods_sku_sale_attr_value_full;</p>
<p>CREATE EXTERNAL TABLE ods_sku_sale_attr_value_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`spu_id` STRING COMMENT ‘spu_id’,</p>
<p>`sale_attr_value_id` STRING COMMENT ‘销售属性值id’,</p>
<p>`sale_attr_id` STRING COMMENT ‘销售属性id’,</p>
<p>`sale_attr_name` STRING COMMENT ‘销售属性名称’,</p>
<p>`sale_attr_value_name` STRING COMMENT ‘销售属性值名称’</p>
<p>) COMMENT ‘sku销售属性名称’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_sku_sale_attr_value_full/‘;</p>
<h4 id="SPU表（全量表）"><a href="#SPU表（全量表）" class="headerlink" title="SPU表（全量表）"></a>SPU表（全量表）</h4><p>DROP TABLE IF EXISTS ods_spu_info_full;</p>
<p>CREATE EXTERNAL TABLE ods_spu_info_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘spu_id’,</p>
<p>`spu_name` STRING COMMENT ‘spu名称’,</p>
<p>`description` STRING COMMENT ‘描述信息’,</p>
<p>`category3_id` STRING COMMENT ‘品类id’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’</p>
<p>) COMMENT ‘SPU商品表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>NULL DEFINED AS ‘’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_spu_info_full/‘;</p>
<h4 id="购物车表（增量表）"><a href="#购物车表（增量表）" class="headerlink" title="购物车表（增量表）"></a>购物车表（增量表）</h4><p>DROP TABLE IF EXISTS ods_cart_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_cart_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,user_id :STRING,sku_id :STRING,cart_price<br>:DECIMAL(16, 2),sku_num :BIGINT,img_url :STRING,sku_name</p>
<p>:STRING,is_checked :STRING,create_time :STRING,operate_time :STRING,is_ordered<br>:STRING,order_time</p>
<p>:STRING,source_type :STRING,source_id :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘购物车增量表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_cart_info_inc/‘;</p>
<h4 id="评论表（增量表）"><a href="#评论表（增量表）" class="headerlink" title="评论表（增量表）"></a>评论表（增量表）</h4><p>DROP TABLE IF EXISTS ods_comment_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_comment_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,user_id :STRING,nick_name :STRING,head_img<br>:STRING,sku_id :STRING,spu_id :STRING,order_id</p>
<p>:STRING,appraise :STRING,comment_txt :STRING,create_time :STRING,operate_time<br>:STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘评价表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_comment_info_inc/‘;</p>
<h4 id="优惠券领用表（增量表）"><a href="#优惠券领用表（增量表）" class="headerlink" title="优惠券领用表（增量表）"></a>优惠券领用表（增量表）</h4><p>DROP TABLE IF EXISTS ods_coupon_use_inc;</p>
<p>CREATE EXTERNAL TABLE ods_coupon_use_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,coupon_id :STRING,user_id :STRING,order_id<br>:STRING,coupon_status :STRING,get_time :STRING,using_time</p>
<p>:STRING,used_time :STRING,expire_time :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘优惠券领用表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_coupon_use_inc/‘;</p>
<h4 id="收藏表（增量表）"><a href="#收藏表（增量表）" class="headerlink" title="收藏表（增量表）"></a>收藏表（增量表）</h4><p>DROP TABLE IF EXISTS ods_favor_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_favor_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,user_id :STRING,sku_id :STRING,spu_id<br>:STRING,is_cancel :STRING,create_time :STRING,cancel_time</p>
<p>:STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘收藏表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_favor_info_inc/‘;</p>
<h4 id="订单明细表（增量表）"><a href="#订单明细表（增量表）" class="headerlink" title="订单明细表（增量表）"></a>订单明细表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_detail_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_detail_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,order_id :STRING,sku_id :STRING,sku_name<br>:STRING,img_url :STRING,order_price</p>
<p>:DECIMAL(16, 2),sku_num :BIGINT,create_time :STRING,source_type<br>:STRING,source_id :STRING,split_total_amount</p>
<p>:DECIMAL(16, 2),split_activity_amount :DECIMAL(16, 2),split_coupon_amount</p>
<p>:DECIMAL(16, 2)&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘订单明细表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_detail_inc/‘;</p>
<h4 id="订单明细活动关联表（增量表）"><a href="#订单明细活动关联表（增量表）" class="headerlink" title="订单明细活动关联表（增量表）"></a>订单明细活动关联表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_detail_activity_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_detail_activity_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,order_id :STRING,order_detail_id :STRING,activity_id<br>:STRING,activity_rule_id :STRING,sku_id</p>
<p>:STRING,create_time :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘订单明细活动关联表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_detail_activity_inc/‘;</p>
<h4 id="订单明细优惠券关联表（增量表）"><a href="#订单明细优惠券关联表（增量表）" class="headerlink" title="订单明细优惠券关联表（增量表）"></a>订单明细优惠券关联表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_detail_coupon_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_detail_coupon_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,order_id :STRING,order_detail_id :STRING,coupon_id<br>:STRING,coupon_use_id :STRING,sku_id</p>
<p>:STRING,create_time :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘订单明细优惠券关联表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_detail_coupon_inc/‘;</p>
<h4 id="订单表（增量表）"><a href="#订单表（增量表）" class="headerlink" title="订单表（增量表）"></a>订单表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,consignee :STRING,consignee_tel :STRING,total_amount<br>:DECIMAL(16, 2),order_status :STRING,user_id</p>
<p>:STRING,payment_way :STRING,delivery_address :STRING,order_comment<br>:STRING,out_trade_no :STRING,trade_body</p>
<p>:STRING,create_time :STRING,operate_time :STRING,expire_time<br>:STRING,process_status :STRING,tracking_no</p>
<p>:STRING,parent_order_id :STRING,img_url :STRING,province_id<br>:STRING,activity_reduce_amount</p>
<p>:DECIMAL(16, 2),coupon_reduce_amount :DECIMAL(16, 2),original_total_amount<br>:DECIMAL(16, 2),freight_fee</p>
<p>:DECIMAL(16, 2),freight_fee_reduce :DECIMAL(16, 2),refundable_time :DECIMAL(16,<br>2)&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘订单表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_info_inc/‘;</p>
<h4 id="退单表（增量表）"><a href="#退单表（增量表）" class="headerlink" title="退单表（增量表）"></a>退单表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_refund_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_refund_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,user_id :STRING,order_id :STRING,sku_id<br>:STRING,refund_type :STRING,refund_num :BIGINT,refund_amount</p>
<p>:DECIMAL(16, 2),refund_reason_type :STRING,refund_reason_txt<br>:STRING,refund_status :STRING,create_time</p>
<p>:STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘退单表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_refund_info_inc/‘;</p>
<h4 id="订单状态流水表（增量表）"><a href="#订单状态流水表（增量表）" class="headerlink" title="订单状态流水表（增量表）"></a>订单状态流水表（增量表）</h4><p>DROP TABLE IF EXISTS ods_order_status_log_inc;</p>
<p>CREATE EXTERNAL TABLE ods_order_status_log_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,order_id :STRING,order_status :STRING,operate_time<br>:STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘退单表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_order_status_log_inc/‘;</p>
<h4 id="支付表（增量表）"><a href="#支付表（增量表）" class="headerlink" title="支付表（增量表）"></a>支付表（增量表）</h4><p>DROP TABLE IF EXISTS ods_payment_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_payment_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,out_trade_no :STRING,order_id :STRING,user_id<br>:STRING,payment_type :STRING,trade_no</p>
<p>:STRING,total_amount :DECIMAL(16, 2),subject :STRING,payment_status<br>:STRING,create_time :STRING,callback_time</p>
<p>:STRING,callback_content :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘支付表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_payment_info_inc/‘;</p>
<h4 id="退款表（增量表）"><a href="#退款表（增量表）" class="headerlink" title="退款表（增量表）"></a>退款表（增量表）</h4><p>DROP TABLE IF EXISTS ods_refund_payment_inc;</p>
<p>CREATE EXTERNAL TABLE ods_refund_payment_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,out_trade_no :STRING,order_id :STRING,sku_id<br>:STRING,payment_type :STRING,trade_no :STRING,total_amount</p>
<p>:DECIMAL(16, 2),subject :STRING,refund_status :STRING,create_time<br>:STRING,callback_time :STRING,callback_content</p>
<p>:STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘退款表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_refund_payment_inc/‘;</p>
<h4 id="用户表（增量表）"><a href="#用户表（增量表）" class="headerlink" title="用户表（增量表）"></a>用户表（增量表）</h4><p>DROP TABLE IF EXISTS ods_user_info_inc;</p>
<p>CREATE EXTERNAL TABLE ods_user_info_inc</p>
<p>(</p>
<p>`type` STRING COMMENT ‘变动类型’,</p>
<p>`ts` BIGINT COMMENT ‘变动时间’,</p>
<p>`data` STRUCT&lt;id :STRING,login_name :STRING,nick_name :STRING,passwd<br>:STRING,name :STRING,phone_num :STRING,email</p>
<p>:STRING,head_img :STRING,user_level :STRING,birthday :STRING,gender<br>:STRING,create_time :STRING,operate_time</p>
<p>:STRING,status :STRING&gt; COMMENT ‘数据’,</p>
<p>`old` MAP&lt;STRING,STRING&gt; COMMENT ‘旧值’</p>
<p>) COMMENT ‘用户表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT SERDE ‘org.apache.hadoop.hive.serde2.JsonSerDe’</p>
<p>LOCATION ‘/warehouse/gmall/ods/ods_user_info_inc/‘;</p>
<h4 id="数据装载脚本"><a href="#数据装载脚本" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建hdfs_to_ods_db.sh</p>
<p>[atguigu@hadoop102 bin]$ vim hdfs_to_ods_db.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d ‘-1 day’ +%F`</p>
<p>fi</p>
<p>load_data(){</p>
<p>sql=””</p>
<p>for i in $*; do</p>
<p>##判断路径是否存在</p>
<p>hadoop fs -test -e /origin_data/$APP/db/${i:4}/$do_date</p>
<p>##路径存在方可装载数据</p>
<p>if [[ $? = 0 ]]; then</p>
<p>sql=$sql”load data inpath ‘/origin_data/$APP/db/${i:4}/$do_date’ OVERWRITE<br>into table ${APP}.$i partition(dt=’$do_date’);”</p>
<p>fi</p>
<p>done</p>
<p>hive -e “$sql”</p>
<p>}</p>
<p>case $1 in</p>
<p>“ods_activity_info_full”)</p>
<p>load_data “ods_activity_info_full”</p>
<p>;;</p>
<p>“ods_activity_rule_full”)</p>
<p>load_data “ods_activity_rule_full”</p>
<p>;;</p>
<p>“ods_base_category1_full”)</p>
<p>load_data “ods_base_category1_full”</p>
<p>;;</p>
<p>“ods_base_category2_full”)</p>
<p>load_data “ods_base_category2_full”</p>
<p>;;</p>
<p>“ods_base_category3_full”)</p>
<p>load_data “ods_base_category3_full”</p>
<p>;;</p>
<p>“ods_base_dic_full”)</p>
<p>load_data “ods_base_dic_full”</p>
<p>;;</p>
<p>“ods_base_province_full”)</p>
<p>load_data “ods_base_province_full”</p>
<p>;;</p>
<p>“ods_base_region_full”)</p>
<p>load_data “ods_base_region_full”</p>
<p>;;</p>
<p>“ods_base_trademark_full”)</p>
<p>load_data “ods_base_trademark_full”</p>
<p>;;</p>
<p>“ods_cart_info_full”)</p>
<p>load_data “ods_cart_info_full”</p>
<p>;;</p>
<p>“ods_coupon_info_full”)</p>
<p>load_data “ods_coupon_info_full”</p>
<p>;;</p>
<p>“ods_sku_attr_value_full”)</p>
<p>load_data “ods_sku_attr_value_full”</p>
<p>;;</p>
<p>“ods_sku_info_full”)</p>
<p>load_data “ods_sku_info_full”</p>
<p>;;</p>
<p>“ods_sku_sale_attr_value_full”)</p>
<p>load_data “ods_sku_sale_attr_value_full”</p>
<p>;;</p>
<p>“ods_spu_info_full”)</p>
<p>load_data “ods_spu_info_full”</p>
<p>;;</p>
<p>“ods_cart_info_inc”)</p>
<p>load_data “ods_cart_info_inc”</p>
<p>;;</p>
<p>“ods_comment_info_inc”)</p>
<p>load_data “ods_comment_info_inc”</p>
<p>;;</p>
<p>“ods_coupon_use_inc”)</p>
<p>load_data “ods_coupon_use_inc”</p>
<p>;;</p>
<p>“ods_favor_info_inc”)</p>
<p>load_data “ods_favor_info_inc”</p>
<p>;;</p>
<p>“ods_order_detail_inc”)</p>
<p>load_data “ods_order_detail_inc”</p>
<p>;;</p>
<p>“ods_order_detail_activity_inc”)</p>
<p>load_data “ods_order_detail_activity_inc”</p>
<p>;;</p>
<p>“ods_order_detail_coupon_inc”)</p>
<p>load_data “ods_order_detail_coupon_inc”</p>
<p>;;</p>
<p>“ods_order_info_inc”)</p>
<p>load_data “ods_order_info_inc”</p>
<p>;;</p>
<p>“ods_order_refund_info_inc”)</p>
<p>load_data “ods_order_refund_info_inc”</p>
<p>;;</p>
<p>“ods_order_status_log_inc”)</p>
<p>load_data “ods_order_status_log_inc”</p>
<p>;;</p>
<p>“ods_payment_info_inc”)</p>
<p>load_data “ods_payment_info_inc”</p>
<p>;;</p>
<p>“ods_refund_payment_inc”)</p>
<p>load_data “ods_refund_payment_inc”</p>
<p>;;</p>
<p>“ods_user_info_inc”)</p>
<p>load_data “ods_user_info_inc”</p>
<p>;;</p>
<p>“all”)</p>
<p>load_data “ods_activity_info_full” “ods_activity_rule_full”<br>“ods_base_category1_full” “ods_base_category2_full” “ods_base_category3_full”<br>“ods_base_dic_full” “ods_base_province_full” “ods_base_region_full”<br>“ods_base_trademark_full” “ods_cart_info_full” “ods_coupon_info_full”<br>“ods_sku_attr_value_full” “ods_sku_info_full” “ods_sku_sale_attr_value_full”<br>“ods_spu_info_full” “ods_cart_info_inc” “ods_comment_info_inc”<br>“ods_coupon_use_inc” “ods_favor_info_inc” “ods_order_detail_inc”<br>“ods_order_detail_activity_inc” “ods_order_detail_coupon_inc”<br>“ods_order_info_inc” “ods_order_refund_info_inc” “ods_order_status_log_inc”<br>“ods_payment_info_inc” “ods_refund_payment_inc” “ods_user_info_inc”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x hdfs_to_ods_db.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ hdfs_to_ods_db.sh all 2020-06-14</p>
<h2 id="第8章-数仓开发之DIM层"><a href="#第8章-数仓开发之DIM层" class="headerlink" title="第8章 数仓开发之DIM层"></a>第8章 数仓开发之DIM层</h2><p>DIM层设计要点：</p>
<p>1）DIM层的设计依据是维度建模理论，该层存储维度模型的维度表。</p>
<p>2）DIM层的数据存储格式为orc列式存储+snappy压缩。</p>
<p>3）DIM层表名的命名规范为dim_表名_全量表或者拉链表标识（full/zip）</p>
<h3 id="商品维度表"><a href="#商品维度表" class="headerlink" title="商品维度表"></a>商品维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_sku_full;</p>
<p>CREATE EXTERNAL TABLE dim_sku_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘sku_id’,</p>
<p>`price` DECIMAL(16, 2) COMMENT ‘商品价格’,</p>
<p>`sku_name` STRING COMMENT ‘商品名称’,</p>
<p>`sku_desc` STRING COMMENT ‘商品描述’,</p>
<p>`weight` DECIMAL(16, 2) COMMENT ‘重量’,</p>
<p>`is_sale` BOOLEAN COMMENT ‘是否在售’,</p>
<p>`spu_id` STRING COMMENT ‘spu编号’,</p>
<p>`spu_name` STRING COMMENT ‘spu名称’,</p>
<p>`category3_id` STRING COMMENT ‘三级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘三级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘二级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘二级分类名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`sku_attr_values` ARRAY&lt;STRUCT&lt;attr_id :STRING,value_id :STRING,attr_name<br>:STRING,value_name:STRING&gt;&gt; COMMENT ‘平台属性’,</p>
<p>`sku_sale_attr_values` ARRAY&lt;STRUCT&lt;sale_attr_id :STRING,sale_attr_value_id<br>:STRING,sale_attr_name :STRING,sale_attr_value_name:STRING&gt;&gt; COMMENT<br>‘销售属性’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’</p>
<p>) COMMENT ‘商品维度表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_sku_full/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>with</p>
<p>sku as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>price,</p>
<p>sku_name,</p>
<p>sku_desc,</p>
<p>weight,</p>
<p>is_sale,</p>
<p>spu_id,</p>
<p>category3_id,</p>
<p>tm_id,</p>
<p>create_time</p>
<p>from ods_sku_info_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>spu as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>spu_name</p>
<p>from ods_spu_info_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>c3 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category2_id</p>
<p>from ods_base_category3_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>c2 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category1_id</p>
<p>from ods_base_category2_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>c1 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name</p>
<p>from ods_base_category1_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>tm as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>tm_name</p>
<p>from ods_base_trademark_full</p>
<p>where dt=’2020-06-14’</p>
<p>),</p>
<p>attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘attr_id’,attr_id,’value_id’,value_id,’attr_name’,attr_name,’value_name’,value_name))<br>attrs</p>
<p>from ods_sku_attr_value_full</p>
<p>where dt=’2020-06-14’</p>
<p>group by sku_id</p>
<p>),</p>
<p>sale_attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘sale_attr_id’,sale_attr_id,’sale_attr_value_id’,sale_attr_value_id,’sale_attr_name’,sale_attr_name,’sale_attr_value_name’,sale_attr_value_name))<br>sale_attrs</p>
<p>from ods_sku_sale_attr_value_full</p>
<p>where dt=’2020-06-14’</p>
<p>group by sku_id</p>
<p>)</p>
<p>insert overwrite table dim_sku_full partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>sku.id,</p>
<p>sku.price,</p>
<p>sku.sku_name,</p>
<p>sku.sku_desc,</p>
<p>sku.weight,</p>
<p>sku.is_sale,</p>
<p>sku.spu_id,</p>
<p>spu.spu_name,</p>
<p>sku.category3_id,</p>
<p>c3.name,</p>
<p>c3.category2_id,</p>
<p>c2.name,</p>
<p>c2.category1_id,</p>
<p>c1.name,</p>
<p>sku.tm_id,</p>
<p>tm.tm_name,</p>
<p>attr.attrs,</p>
<p>sale_attr.sale_attrs,</p>
<p>sku.create_time</p>
<p>from sku</p>
<p>left join spu on sku.spu_id=spu.id</p>
<p>left join c3 on sku.category3_id=c3.id</p>
<p>left join c2 on c3.category2_id=c2.id</p>
<p>left join c1 on c2.category1_id=c1.id</p>
<p>left join tm on sku.tm_id=tm.id</p>
<p>left join attr on sku.id=attr.sku_id</p>
<p>left join sale_attr on sku.id=sale_attr.sku_id;</p>
<h3 id="优惠券维度表"><a href="#优惠券维度表" class="headerlink" title="优惠券维度表"></a>优惠券维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_coupon_full;</p>
<p>CREATE EXTERNAL TABLE dim_coupon_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘购物券编号’,</p>
<p>`coupon_name` STRING COMMENT ‘购物券名称’,</p>
<p>`coupon_type_code` STRING COMMENT ‘购物券类型编码’,</p>
<p>`coupon_type_name` STRING COMMENT ‘购物券类型名称’,</p>
<p>`condition_amount` DECIMAL(16, 2) COMMENT ‘满额数’,</p>
<p>`condition_num` BIGINT COMMENT ‘满件数’,</p>
<p>`activity_id` STRING COMMENT ‘活动编号’,</p>
<p>`benefit_amount` DECIMAL(16, 2) COMMENT ‘减金额’,</p>
<p>`benefit_discount` DECIMAL(16, 2) COMMENT ‘折扣’,</p>
<p>`benefit_rule` STRING COMMENT ‘优惠规则:满元*减*元，满*件打*折’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’,</p>
<p>`range_type_code` STRING COMMENT ‘优惠范围类型编码’,</p>
<p>`range_type_name` STRING COMMENT ‘优惠范围类型名称’,</p>
<p>`limit_num` BIGINT COMMENT ‘最多领取次数’,</p>
<p>`taken_count` BIGINT COMMENT ‘已领取次数’,</p>
<p>`start_time` STRING COMMENT ‘可以领取的开始日期’,</p>
<p>`end_time` STRING COMMENT ‘可以领取的结束日期’,</p>
<p>`operate_time` STRING COMMENT ‘修改时间’,</p>
<p>`expire_time` STRING COMMENT ‘过期时间’</p>
<p>) COMMENT ‘优惠券维度表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_coupon_full/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dim_coupon_full partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>coupon_dic.dic_name,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case coupon_type</p>
<p>when ‘3201’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3202’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3203’ then concat(‘减’,benefit_amount,’元’)</p>
<p>end benefit_rule,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>range_dic.dic_name,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from ods_coupon_info_full</p>
<p>where dt=’2020-06-14’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’32’</p>
<p>)coupon_dic</p>
<p>on ci.coupon_type=coupon_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’33’</p>
<p>)range_dic</p>
<p>on ci.range_type=range_dic.dic_code;</p>
<h3 id="活动维度表"><a href="#活动维度表" class="headerlink" title="活动维度表"></a>活动维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_activity_full;</p>
<p>CREATE EXTERNAL TABLE dim_activity_full</p>
<p>(</p>
<p>`activity_rule_id` STRING COMMENT ‘活动规则ID’,</p>
<p>`activity_id` STRING COMMENT ‘活动ID’,</p>
<p>`activity_name` STRING COMMENT ‘活动名称’,</p>
<p>`activity_type_code` STRING COMMENT ‘活动类型编码’,</p>
<p>`activity_type_name` STRING COMMENT ‘活动类型名称’,</p>
<p>`activity_desc` STRING COMMENT ‘活动描述’,</p>
<p>`start_time` STRING COMMENT ‘开始时间’,</p>
<p>`end_time` STRING COMMENT ‘结束时间’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’,</p>
<p>`condition_amount` DECIMAL(16, 2) COMMENT ‘满减金额’,</p>
<p>`condition_num` BIGINT COMMENT ‘满减件数’,</p>
<p>`benefit_amount` DECIMAL(16, 2) COMMENT ‘优惠金额’,</p>
<p>`benefit_discount` DECIMAL(16, 2) COMMENT ‘优惠折扣’,</p>
<p>`benefit_rule` STRING COMMENT ‘优惠规则’,</p>
<p>`benefit_level` STRING COMMENT ‘优惠级别’</p>
<p>) COMMENT ‘活动信息表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_activity_full/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dim_activity_full partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>rule.id,</p>
<p>info.id,</p>
<p>activity_name,</p>
<p>rule.activity_type,</p>
<p>dic.dic_name,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case rule.activity_type</p>
<p>when ‘3101’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3102’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3103’ then concat(‘打’,10*(1-benefit_discount),’折’)</p>
<p>end benefit_rule,</p>
<p>benefit_level</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_id,</p>
<p>activity_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>benefit_level</p>
<p>from ods_activity_rule_full</p>
<p>where dt=’2020-06-14’</p>
<p>)rule</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_name,</p>
<p>activity_type,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time</p>
<p>from ods_activity_info_full</p>
<p>where dt=’2020-06-14’</p>
<p>)info</p>
<p>on rule.activity_id=info.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’31’</p>
<p>)dic</p>
<p>on rule.activity_type=dic.dic_code;</p>
<h3 id="地区维度表"><a href="#地区维度表" class="headerlink" title="地区维度表"></a>地区维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_province_full;</p>
<p>CREATE EXTERNAL TABLE dim_province_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘id’,</p>
<p>`province_name` STRING COMMENT ‘省市名称’,</p>
<p>`area_code` STRING COMMENT ‘地区编码’,</p>
<p>`iso_code` STRING COMMENT ‘旧版ISO-3166-2编码，供可视化使用’,</p>
<p>`iso_3166_2` STRING COMMENT ‘新版IOS-3166-2编码，供可视化使用’,</p>
<p>`region_id` STRING COMMENT ‘地区id’,</p>
<p>`region_name` STRING COMMENT ‘地区名称’</p>
<p>) COMMENT ‘地区维度表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_province_full/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dim_province_full partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province.id,</p>
<p>province.name,</p>
<p>province.area_code,</p>
<p>province.iso_code,</p>
<p>province.iso_3166_2,</p>
<p>region_id,</p>
<p>region_name</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>region_id,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)province</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>region_name</p>
<p>from ods_base_region_full</p>
<p>where dt=’2020-06-14’</p>
<p>)region</p>
<p>on province.region_id=region.id;</p>
<h3 id="日期维度表"><a href="#日期维度表" class="headerlink" title="日期维度表"></a>日期维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_date;</p>
<p>CREATE EXTERNAL TABLE dim_date</p>
<p>(</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`week_id` STRING COMMENT ‘周ID,一年中的第几周’,</p>
<p>`week_day` STRING COMMENT ‘周几’,</p>
<p>`day` STRING COMMENT ‘每月的第几天’,</p>
<p>`month` STRING COMMENT ‘一年中的第几月’,</p>
<p>`quarter` STRING COMMENT ‘一年中的第几季度’,</p>
<p>`year` STRING COMMENT ‘年份’,</p>
<p>`is_workday` STRING COMMENT ‘是否是工作日’,</p>
<p>`holiday_id` STRING COMMENT ‘节假日’</p>
<p>) COMMENT ‘时间维度表’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_date/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>通常情况下，时间维度表的数据并不是来自于业务系统，而是手动写入，并且由于时间维度表数据的可预见性，无须每日导入，一般可一次性导入一年的数据。</p>
<p>（1）创建临时表</p>
<p>DROP TABLE IF EXISTS tmp_dim_date_info;</p>
<p>CREATE EXTERNAL TABLE tmp_dim_date_info (</p>
<p>`date_id` STRING COMMENT ‘日’,</p>
<p>`week_id` STRING COMMENT ‘周ID’,</p>
<p>`week_day` STRING COMMENT ‘周几’,</p>
<p>`day` STRING COMMENT ‘每月的第几天’,</p>
<p>`month` STRING COMMENT ‘第几月’,</p>
<p>`quarter` STRING COMMENT ‘第几季度’,</p>
<p>`year` STRING COMMENT ‘年’,</p>
<p>`is_workday` STRING COMMENT ‘是否是工作日’,</p>
<p>`holiday_id` STRING COMMENT ‘节假日’</p>
<p>) COMMENT ‘时间维度表’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/tmp/tmp_dim_date_info/‘;</p>
<p>（2）将数据文件上传到HFDS上临时表路径/warehouse/gmall/tmp/tmp_dim_date_info</p>
<p>（3）执行以下语句将其导入时间维度表</p>
<p>insert overwrite table dim_date select * from tmp_dim_date_info;</p>
<p>（4）检查数据是否导入成功</p>
<p>select * from dim_date;</p>
<h3 id="用户维度表"><a href="#用户维度表" class="headerlink" title="用户维度表"></a>用户维度表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dim_user_zip;</p>
<p>CREATE EXTERNAL TABLE dim_user_zip</p>
<p>(</p>
<p>`id` STRING COMMENT ‘用户id’,</p>
<p>`login_name` STRING COMMENT ‘用户名称’,</p>
<p>`nick_name` STRING COMMENT ‘用户昵称’,</p>
<p>`name` STRING COMMENT ‘用户姓名’,</p>
<p>`phone_num` STRING COMMENT ‘手机号码’,</p>
<p>`email` STRING COMMENT ‘邮箱’,</p>
<p>`user_level` STRING COMMENT ‘用户等级’,</p>
<p>`birthday` STRING COMMENT ‘生日’,</p>
<p>`gender` STRING COMMENT ‘性别’,</p>
<p>`create_time` STRING COMMENT ‘创建时间’,</p>
<p>`operate_time` STRING COMMENT ‘操作时间’,</p>
<p>`start_date` STRING COMMENT ‘开始日期’,</p>
<p>`end_date` STRING COMMENT ‘结束日期’</p>
<p>) COMMENT ‘用户表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dim/dim_user_zip/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）分区规划</strong></p>
<p><strong>3）数据装载</strong></p>
<p><strong>（1）数据装载过程</strong></p>
<p><strong>（2）数据流向</strong></p>
<p><strong>（3）首日装载</strong></p>
<p>insert overwrite table dim_user_zip partition (dt=’9999-12-31’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.login_name,</p>
<p>data.nick_name,</p>
<p>md5(data.name),</p>
<p>md5(data.phone_num),</p>
<p>md5(data.email),</p>
<p>data.user_level,</p>
<p>data.birthday,</p>
<p>data.gender,</p>
<p>data.create_time,</p>
<p>data.operate_time,</p>
<p>‘2020-06-14’ start_date,</p>
<p>‘9999-12-31’ end_date</p>
<p>from ods_user_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’;</p>
<p><strong>（4）每日装载</strong></p>
<p><strong>装载思路</strong></p>
<p><strong>装载语句</strong></p>
<p>with</p>
<p>tmp as</p>
<p>(</p>
<p>select</p>
<p>old.id old_id,</p>
<p>old.login_name old_login_name,</p>
<p>old.nick_name old_nick_name,</p>
<p>old.name old_name,</p>
<p>old.phone_num old_phone_num,</p>
<p>old.email old_email,</p>
<p>old.user_level old_user_level,</p>
<p>old.birthday old_birthday,</p>
<p>old.gender old_gender,</p>
<p>old.create_time old_create_time,</p>
<p>old.operate_time old_operate_time,</p>
<p>old.start_date old_start_date,</p>
<p>old.end_date old_end_date,</p>
<p>new.id new_id,</p>
<p>new.login_name new_login_name,</p>
<p>new.nick_name new_nick_name,</p>
<p>new.name new_name,</p>
<p>new.phone_num new_phone_num,</p>
<p>new.email new_email,</p>
<p>new.user_level new_user_level,</p>
<p>new.birthday new_birthday,</p>
<p>new.gender new_gender,</p>
<p>new.create_time new_create_time,</p>
<p>new.operate_time new_operate_time,</p>
<p>new.start_date new_start_date,</p>
<p>new.end_date new_end_date</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>login_name,</p>
<p>nick_name,</p>
<p>name,</p>
<p>phone_num,</p>
<p>email,</p>
<p>user_level,</p>
<p>birthday,</p>
<p>gender,</p>
<p>create_time,</p>
<p>operate_time,</p>
<p>start_date,</p>
<p>end_date</p>
<p>from dim_user_zip</p>
<p>where dt=’9999-12-31’</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>login_name,</p>
<p>nick_name,</p>
<p>md5(name) name,</p>
<p>md5(phone_num) phone_num,</p>
<p>md5(email) email,</p>
<p>user_level,</p>
<p>birthday,</p>
<p>gender,</p>
<p>create_time,</p>
<p>operate_time,</p>
<p>‘2020-06-15’ start_date,</p>
<p>‘9999-12-31’ end_date</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.login_name,</p>
<p>data.nick_name,</p>
<p>data.name,</p>
<p>data.phone_num,</p>
<p>data.email,</p>
<p>data.user_level,</p>
<p>data.birthday,</p>
<p>data.gender,</p>
<p>data.create_time,</p>
<p>data.operate_time,</p>
<p>row_number() over (partition by data.id order by ts desc) rn</p>
<p>from ods_user_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>)t1</p>
<p>where rn=1</p>
<p>)new</p>
<p>on old.id=new.id</p>
<p>)</p>
<p>insert overwrite table dim_user_zip partition(dt)</p>
<p>select</p>
<p>if(new_id is not null,new_id,old_id),</p>
<p>if(new_id is not null,new_login_name,old_login_name),</p>
<p>if(new_id is not null,new_nick_name,old_nick_name),</p>
<p>if(new_id is not null,new_name,old_name),</p>
<p>if(new_id is not null,new_phone_num,old_phone_num),</p>
<p>if(new_id is not null,new_email,old_email),</p>
<p>if(new_id is not null,new_user_level,old_user_level),</p>
<p>if(new_id is not null,new_birthday,old_birthday),</p>
<p>if(new_id is not null,new_gender,old_gender),</p>
<p>if(new_id is not null,new_create_time,old_create_time),</p>
<p>if(new_id is not null,new_operate_time,old_operate_time),</p>
<p>if(new_id is not null,new_start_date,old_start_date),</p>
<p>if(new_id is not null,new_end_date,old_end_date),</p>
<p>if(new_id is not null,new_end_date,old_end_date) dt</p>
<p>from tmp</p>
<p>union all</p>
<p>select</p>
<p>old_id,</p>
<p>old_login_name,</p>
<p>old_nick_name,</p>
<p>old_name,</p>
<p>old_phone_num,</p>
<p>old_email,</p>
<p>old_user_level,</p>
<p>old_birthday,</p>
<p>old_gender,</p>
<p>old_create_time,</p>
<p>old_operate_time,</p>
<p>old_start_date,</p>
<p>cast(date_add(‘2020-06-15’,-1) as string) old_end_date,</p>
<p>cast(date_add(‘2020-06-15’,-1) as string) dt</p>
<p>from tmp</p>
<p>where old_id is not null</p>
<p>and new_id is not null;</p>
<h3 id="数据装载脚本-1"><a href="#数据装载脚本-1" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h3><h4 id="首日装载脚本"><a href="#首日装载脚本" class="headerlink" title="首日装载脚本"></a>首日装载脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建ods_to_dim_init.sh</p>
<p>[atguigu@hadoop102 bin]$ vim ods_to_dim_init.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>echo “请传入日期参数”</p>
<p>exit</p>
<p>fi</p>
<p>dim_user_zip=”</p>
<p>insert overwrite table ${APP}.dim_user_zip partition (dt=’9999-12-31’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.login_name,</p>
<p>data.nick_name,</p>
<p>md5(data.name),</p>
<p>md5(data.phone_num),</p>
<p>md5(data.email),</p>
<p>data.user_level,</p>
<p>data.birthday,</p>
<p>data.gender,</p>
<p>data.create_time,</p>
<p>data.operate_time,</p>
<p>‘$do_date’ start_date,</p>
<p>‘9999-12-31’ end_date</p>
<p>from ${APP}.ods_user_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’;</p>
<p>“</p>
<p>dim_sku_full=”</p>
<p>with</p>
<p>sku as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>price,</p>
<p>sku_name,</p>
<p>sku_desc,</p>
<p>weight,</p>
<p>is_sale,</p>
<p>spu_id,</p>
<p>category3_id,</p>
<p>tm_id,</p>
<p>create_time</p>
<p>from ${APP}.ods_sku_info_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>spu as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>spu_name</p>
<p>from ${APP}.ods_spu_info_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c3 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category2_id</p>
<p>from ${APP}.ods_base_category3_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c2 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category1_id</p>
<p>from ${APP}.ods_base_category2_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c1 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name</p>
<p>from ${APP}.ods_base_category1_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>tm as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>tm_name</p>
<p>from ${APP}.ods_base_trademark_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘attr_id’,attr_id,’value_id’,value_id,’attr_name’,attr_name,’value_name’,value_name))<br>attrs</p>
<p>from ${APP}.ods_sku_attr_value_full</p>
<p>where dt=’$do_date’</p>
<p>group by sku_id</p>
<p>),</p>
<p>sale_attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘sale_attr_id’,sale_attr_id,’sale_attr_value_id’,sale_attr_value_id,’sale_attr_name’,sale_attr_name,’sale_attr_value_name’,sale_attr_value_name))<br>sale_attrs</p>
<p>from ${APP}.ods_sku_sale_attr_value_full</p>
<p>where dt=’$do_date’</p>
<p>group by sku_id</p>
<p>)</p>
<p>insert overwrite table ${APP}.dim_sku_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>sku.id,</p>
<p>sku.price,</p>
<p>sku.sku_name,</p>
<p>sku.sku_desc,</p>
<p>sku.weight,</p>
<p>sku.is_sale,</p>
<p>sku.spu_id,</p>
<p>spu.spu_name,</p>
<p>sku.category3_id,</p>
<p>c3.name,</p>
<p>c3.category2_id,</p>
<p>c2.name,</p>
<p>c2.category1_id,</p>
<p>c1.name,</p>
<p>sku.tm_id,</p>
<p>tm.tm_name,</p>
<p>attr.attrs,</p>
<p>sale_attr.sale_attrs,</p>
<p>sku.create_time</p>
<p>from sku</p>
<p>left join spu on sku.spu_id=spu.id</p>
<p>left join c3 on sku.category3_id=c3.id</p>
<p>left join c2 on c3.category2_id=c2.id</p>
<p>left join c1 on c2.category1_id=c1.id</p>
<p>left join tm on sku.tm_id=tm.id</p>
<p>left join attr on sku.id=attr.sku_id</p>
<p>left join sale_attr on sku.id=sale_attr.sku_id;</p>
<p>“</p>
<p>dim_province_full=”</p>
<p>insert overwrite table ${APP}.dim_province_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>province.id,</p>
<p>province.name,</p>
<p>province.area_code,</p>
<p>province.iso_code,</p>
<p>province.iso_3166_2,</p>
<p>region_id,</p>
<p>region_name</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>region_id,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)province</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>region_name</p>
<p>from ${APP}.ods_base_region_full</p>
<p>where dt=’$do_date’</p>
<p>)region</p>
<p>on province.region_id=region.id;</p>
<p>“</p>
<p>dim_coupon_full=”</p>
<p>insert overwrite table ${APP}.dim_coupon_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>coupon_dic.dic_name,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case coupon_type</p>
<p>when ‘3201’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3202’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3203’ then concat(‘减’,benefit_amount,’元’)</p>
<p>end benefit_rule,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>range_dic.dic_name,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from ${APP}.ods_coupon_info_full</p>
<p>where dt=’$do_date’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’32’</p>
<p>)coupon_dic</p>
<p>on ci.coupon_type=coupon_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’33’</p>
<p>)range_dic</p>
<p>on ci.range_type=range_dic.dic_code;</p>
<p>“</p>
<p>dim_activity_full=”</p>
<p>insert overwrite table ${APP}.dim_activity_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>rule.id,</p>
<p>info.id,</p>
<p>activity_name,</p>
<p>rule.activity_type,</p>
<p>dic.dic_name,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case rule.activity_type</p>
<p>when ‘3101’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3102’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3103’ then concat(‘打’,10*(1-benefit_discount),’折’)</p>
<p>end benefit_rule,</p>
<p>benefit_level</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_id,</p>
<p>activity_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>benefit_level</p>
<p>from ${APP}.ods_activity_rule_full</p>
<p>where dt=’$do_date’</p>
<p>)rule</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_name,</p>
<p>activity_type,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time</p>
<p>from ${APP}.ods_activity_info_full</p>
<p>where dt=’$do_date’</p>
<p>)info</p>
<p>on rule.activity_id=info.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’31’</p>
<p>)dic</p>
<p>on rule.activity_type=dic.dic_code;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dim_user_zip”)</p>
<p>hive -e “$dim_user_zip”</p>
<p>;;</p>
<p>“dim_sku_full”)</p>
<p>hive -e “$dim_sku_full”</p>
<p>;;</p>
<p>“dim_province_full”)</p>
<p>hive -e “$dim_province_full”</p>
<p>;;</p>
<p>“dim_coupon_full”)</p>
<p>hive -e “$dim_coupon_full”</p>
<p>;;</p>
<p>“dim_activity_full”)</p>
<p>hive -e “$dim_activity_full”</p>
<p>;;</p>
<p>“all”)</p>
<p>hive -e<br>“$dim_user_zip$dim_sku_full$dim_province_full$dim_coupon_full$dim_activity_full”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x ods_to_dim_init.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ ods_to_dim_init.sh all 2020-06-14</p>
<h4 id="每日装载脚本"><a href="#每日装载脚本" class="headerlink" title="每日装载脚本"></a>每日装载脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建ods_to_dim.sh</p>
<p>[atguigu@hadoop102 bin]$ vim ods_to_dim.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>dim_user_zip=”</p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>with</p>
<p>tmp as</p>
<p>(</p>
<p>select</p>
<p>old.id old_id,</p>
<p>old.login_name old_login_name,</p>
<p>old.nick_name old_nick_name,</p>
<p>old.name old_name,</p>
<p>old.phone_num old_phone_num,</p>
<p>old.email old_email,</p>
<p>old.user_level old_user_level,</p>
<p>old.birthday old_birthday,</p>
<p>old.gender old_gender,</p>
<p>old.create_time old_create_time,</p>
<p>old.operate_time old_operate_time,</p>
<p>old.start_date old_start_date,</p>
<p>old.end_date old_end_date,</p>
<p>new.id new_id,</p>
<p>new.login_name new_login_name,</p>
<p>new.nick_name new_nick_name,</p>
<p>new.name new_name,</p>
<p>new.phone_num new_phone_num,</p>
<p>new.email new_email,</p>
<p>new.user_level new_user_level,</p>
<p>new.birthday new_birthday,</p>
<p>new.gender new_gender,</p>
<p>new.create_time new_create_time,</p>
<p>new.operate_time new_operate_time,</p>
<p>new.start_date new_start_date,</p>
<p>new.end_date new_end_date</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>login_name,</p>
<p>nick_name,</p>
<p>name,</p>
<p>phone_num,</p>
<p>email,</p>
<p>user_level,</p>
<p>birthday,</p>
<p>gender,</p>
<p>create_time,</p>
<p>operate_time,</p>
<p>start_date,</p>
<p>end_date</p>
<p>from ${APP}.dim_user_zip</p>
<p>where dt=’9999-12-31’</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>login_name,</p>
<p>nick_name,</p>
<p>md5(name) name,</p>
<p>md5(phone_num) phone_num,</p>
<p>md5(email) email,</p>
<p>user_level,</p>
<p>birthday,</p>
<p>gender,</p>
<p>create_time,</p>
<p>operate_time,</p>
<p>‘$do_date’ start_date,</p>
<p>‘9999-12-31’ end_date</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.login_name,</p>
<p>data.nick_name,</p>
<p>data.name,</p>
<p>data.phone_num,</p>
<p>data.email,</p>
<p>data.user_level,</p>
<p>data.birthday,</p>
<p>data.gender,</p>
<p>data.create_time,</p>
<p>data.operate_time,</p>
<p>row_number() over (partition by data.id order by ts desc) rn</p>
<p>from ${APP}.ods_user_info_inc</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>where rn=1</p>
<p>)new</p>
<p>on old.id=new.id</p>
<p>)</p>
<p>insert overwrite table ${APP}.dim_user_zip partition(dt)</p>
<p>select</p>
<p>if(new_id is not null,new_id,old_id),</p>
<p>if(new_id is not null,new_login_name,old_login_name),</p>
<p>if(new_id is not null,new_nick_name,old_nick_name),</p>
<p>if(new_id is not null,new_name,old_name),</p>
<p>if(new_id is not null,new_phone_num,old_phone_num),</p>
<p>if(new_id is not null,new_email,old_email),</p>
<p>if(new_id is not null,new_user_level,old_user_level),</p>
<p>if(new_id is not null,new_birthday,old_birthday),</p>
<p>if(new_id is not null,new_gender,old_gender),</p>
<p>if(new_id is not null,new_create_time,old_create_time),</p>
<p>if(new_id is not null,new_operate_time,old_operate_time),</p>
<p>if(new_id is not null,new_start_date,old_start_date),</p>
<p>if(new_id is not null,new_end_date,old_end_date),</p>
<p>if(new_id is not null,new_end_date,old_end_date) dt</p>
<p>from tmp</p>
<p>union all</p>
<p>select</p>
<p>old_id,</p>
<p>old_login_name,</p>
<p>old_nick_name,</p>
<p>old_name,</p>
<p>old_phone_num,</p>
<p>old_email,</p>
<p>old_user_level,</p>
<p>old_birthday,</p>
<p>old_gender,</p>
<p>old_create_time,</p>
<p>old_operate_time,</p>
<p>old_start_date,</p>
<p>cast(date_add(‘$do_date’,-1) as string) old_end_date,</p>
<p>cast(date_add(‘$do_date’,-1) as string) dt</p>
<p>from tmp</p>
<p>where old_id is not null</p>
<p>and new_id is not null;</p>
<p>“</p>
<p>dim_sku_full=”</p>
<p>with</p>
<p>sku as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>price,</p>
<p>sku_name,</p>
<p>sku_desc,</p>
<p>weight,</p>
<p>is_sale,</p>
<p>spu_id,</p>
<p>category3_id,</p>
<p>tm_id,</p>
<p>create_time</p>
<p>from ${APP}.ods_sku_info_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>spu as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>spu_name</p>
<p>from ${APP}.ods_spu_info_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c3 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category2_id</p>
<p>from ${APP}.ods_base_category3_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c2 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>category1_id</p>
<p>from ${APP}.ods_base_category2_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>c1 as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name</p>
<p>from ${APP}.ods_base_category1_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>tm as</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>tm_name</p>
<p>from ${APP}.ods_base_trademark_full</p>
<p>where dt=’$do_date’</p>
<p>),</p>
<p>attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘attr_id’,attr_id,’value_id’,value_id,’attr_name’,attr_name,’value_name’,value_name))<br>attrs</p>
<p>from ${APP}.ods_sku_attr_value_full</p>
<p>where dt=’$do_date’</p>
<p>group by sku_id</p>
<p>),</p>
<p>sale_attr as</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>collect_set(named_struct(‘sale_attr_id’,sale_attr_id,’sale_attr_value_id’,sale_attr_value_id,’sale_attr_name’,sale_attr_name,’sale_attr_value_name’,sale_attr_value_name))<br>sale_attrs</p>
<p>from ${APP}.ods_sku_sale_attr_value_full</p>
<p>where dt=’$do_date’</p>
<p>group by sku_id</p>
<p>)</p>
<p>insert overwrite table ${APP}.dim_sku_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>sku.id,</p>
<p>sku.price,</p>
<p>sku.sku_name,</p>
<p>sku.sku_desc,</p>
<p>sku.weight,</p>
<p>sku.is_sale,</p>
<p>sku.spu_id,</p>
<p>spu.spu_name,</p>
<p>sku.category3_id,</p>
<p>c3.name,</p>
<p>c3.category2_id,</p>
<p>c2.name,</p>
<p>c2.category1_id,</p>
<p>c1.name,</p>
<p>sku.tm_id,</p>
<p>tm.tm_name,</p>
<p>attr.attrs,</p>
<p>sale_attr.sale_attrs,</p>
<p>sku.create_time</p>
<p>from sku</p>
<p>left join spu on sku.spu_id=spu.id</p>
<p>left join c3 on sku.category3_id=c3.id</p>
<p>left join c2 on c3.category2_id=c2.id</p>
<p>left join c1 on c2.category1_id=c1.id</p>
<p>left join tm on sku.tm_id=tm.id</p>
<p>left join attr on sku.id=attr.sku_id</p>
<p>left join sale_attr on sku.id=sale_attr.sku_id;</p>
<p>“</p>
<p>dim_province_full=”</p>
<p>insert overwrite table ${APP}.dim_province_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>province.id,</p>
<p>province.name,</p>
<p>province.area_code,</p>
<p>province.iso_code,</p>
<p>province.iso_3166_2,</p>
<p>region_id,</p>
<p>region_name</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>name,</p>
<p>region_id,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)province</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>region_name</p>
<p>from ${APP}.ods_base_region_full</p>
<p>where dt=’$do_date’</p>
<p>)region</p>
<p>on province.region_id=region.id;</p>
<p>“</p>
<p>dim_coupon_full=”</p>
<p>insert overwrite table ${APP}.dim_coupon_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>coupon_dic.dic_name,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case coupon_type</p>
<p>when ‘3201’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3202’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3203’ then concat(‘减’,benefit_amount,’元’)</p>
<p>end benefit_rule,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>range_dic.dic_name,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>activity_id,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>create_time,</p>
<p>range_type,</p>
<p>limit_num,</p>
<p>taken_count,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>operate_time,</p>
<p>expire_time</p>
<p>from ${APP}.ods_coupon_info_full</p>
<p>where dt=’$do_date’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’32’</p>
<p>)coupon_dic</p>
<p>on ci.coupon_type=coupon_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’33’</p>
<p>)range_dic</p>
<p>on ci.range_type=range_dic.dic_code;</p>
<p>“</p>
<p>dim_activity_full=”</p>
<p>insert overwrite table ${APP}.dim_activity_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>rule.id,</p>
<p>info.id,</p>
<p>activity_name,</p>
<p>rule.activity_type,</p>
<p>dic.dic_name,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>case rule.activity_type</p>
<p>when ‘3101’ then concat(‘满’,condition_amount,’元减’,benefit_amount,’元’)</p>
<p>when ‘3102’ then concat(‘满’,condition_num,’件打’,10*(1-benefit_discount),’折’)</p>
<p>when ‘3103’ then concat(‘打’,10*(1-benefit_discount),’折’)</p>
<p>end benefit_rule,</p>
<p>benefit_level</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_id,</p>
<p>activity_type,</p>
<p>condition_amount,</p>
<p>condition_num,</p>
<p>benefit_amount,</p>
<p>benefit_discount,</p>
<p>benefit_level</p>
<p>from ${APP}.ods_activity_rule_full</p>
<p>where dt=’$do_date’</p>
<p>)rule</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>activity_name,</p>
<p>activity_type,</p>
<p>activity_desc,</p>
<p>start_time,</p>
<p>end_time,</p>
<p>create_time</p>
<p>from ${APP}.ods_activity_info_full</p>
<p>where dt=’$do_date’</p>
<p>)info</p>
<p>on rule.activity_id=info.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’31’</p>
<p>)dic</p>
<p>on rule.activity_type=dic.dic_code;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dim_user_zip”)</p>
<p>hive -e “$dim_user_zip”</p>
<p>;;</p>
<p>“dim_sku_full”)</p>
<p>hive -e “$dim_sku_full”</p>
<p>;;</p>
<p>“dim_province_full”)</p>
<p>hive -e “$dim_province_full”</p>
<p>;;</p>
<p>“dim_coupon_full”)</p>
<p>hive -e “$dim_coupon_full”</p>
<p>;;</p>
<p>“dim_activity_full”)</p>
<p>hive -e “$dim_activity_full”</p>
<p>;;</p>
<p>“all”)</p>
<p>hive -e<br>“$dim_user_zip$dim_sku_full$dim_province_full$dim_coupon_full$dim_activity_full”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x ods_to_dim.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ ods_to_dim.sh all 2020-06-14</p>
<h2 id="第9章-数仓开发之DWD层"><a href="#第9章-数仓开发之DWD层" class="headerlink" title="第9章 数仓开发之DWD层"></a>第9章 数仓开发之DWD层</h2><p>DWD层设计要点：</p>
<p>1）DWD层的设计依据是维度建模理论，该层存储维度模型的事实表。</p>
<p>2）DWD层的数据存储格式为orc列式存储+snappy压缩。</p>
<p>3）DWD层表名的命名规范为dwd_数据域_表名_单分区增量全量标识（inc/full）</p>
<h3 id="交易域加购事务事实表"><a href="#交易域加购事务事实表" class="headerlink" title="交易域加购事务事实表"></a>交易域加购事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_cart_add_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_cart_add_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`date_id` STRING COMMENT ‘时间id’,</p>
<p>`create_time` STRING COMMENT ‘加购时间’,</p>
<p>`source_id` STRING COMMENT ‘来源类型ID’,</p>
<p>`source_type_code` STRING COMMENT ‘来源类型编码’,</p>
<p>`source_type_name` STRING COMMENT ‘来源类型名称’,</p>
<p>`sku_num` BIGINT COMMENT ‘加购物车件数’</p>
<p>) COMMENT ‘交易域加购物车事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_cart_add_inc/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）分区规划</strong></p>
<p><strong>3）数据装载</strong></p>
<p><strong>（1）数据流向</strong></p>
<p><strong>（2）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dwd_trade_cart_add_inc partition (dt)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic.dic_name,</p>
<p>sku_num,</p>
<p>date_format(create_time, ‘yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num</p>
<p>from ods_cart_info_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on ci.source_type=dic.dic_code;</p>
<p><strong>（3）每日装载</strong></p>
<p>insert overwrite table dwd_trade_cart_add_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type_code,</p>
<p>source_type_name,</p>
<p>sku_num</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(from_utc_timestamp(ts*1000,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts*1000,’GMT+8’),’yyyy-MM-dd HH:mm:ss’)<br>create_time,</p>
<p>data.source_id,</p>
<p>data.source_type source_type_code,</p>
<p>if(type=’insert’,data.sku_num,data.sku_num-old[‘sku_num’]) sku_num</p>
<p>from ods_cart_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and (type=’insert’</p>
<p>or(type=’update’ and old[‘sku_num’] is not null and<br>data.sku_num&gt;cast(old[‘sku_num’] as int)))</p>
<p>)cart</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name source_type_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on cart.source_type_code=dic.dic_code;</p>
<h3 id="交易域下单事务事实表"><a href="#交易域下单事务事实表" class="headerlink" title="交易域下单事务事实表"></a>交易域下单事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_order_detail_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_order_detail_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`order_id` STRING COMMENT ‘订单id’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`activity_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`activity_rule_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`coupon_id` STRING COMMENT ‘使用优惠券id’,</p>
<p>`date_id` STRING COMMENT ‘下单日期id’,</p>
<p>`create_time` STRING COMMENT ‘下单时间’,</p>
<p>`source_id` STRING COMMENT ‘来源编号’,</p>
<p>`source_type_code` STRING COMMENT ‘来源类型编码’,</p>
<p>`source_type_name` STRING COMMENT ‘来源类型名称’,</p>
<p>`sku_num` BIGINT COMMENT ‘商品数量’,</p>
<p>`split_original_amount` DECIMAL(16, 2) COMMENT ‘原始价格’,</p>
<p>`split_activity_amount` DECIMAL(16, 2) COMMENT ‘活动优惠分摊’,</p>
<p>`split_coupon_amount` DECIMAL(16, 2) COMMENT ‘优惠券优惠分摊’,</p>
<p>`split_total_amount` DECIMAL(16, 2) COMMENT ‘最终价格分摊’</p>
<p>) COMMENT ‘交易域下单明细事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_order_detail_inc/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dwd_trade_order_detail_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(create_time, ‘yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_trade_order_detail_inc partition (dt=’2020-06-15’)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time, ‘yyyy-MM-dd’) date_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where dt = ‘2020-06-15’</p>
<p>and type = ‘insert’</p>
<p>) od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt = ‘2020-06-15’</p>
<p>and type = ‘insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where dt = ‘2020-06-15’</p>
<p>and type = ‘insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where dt = ‘2020-06-15’</p>
<p>and type = ‘insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<h3 id="交易域取消订单事务事实表"><a href="#交易域取消订单事务事实表" class="headerlink" title="交易域取消订单事务事实表"></a>交易域取消订单事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_cancel_detail_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_cancel_detail_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`order_id` STRING COMMENT ‘订单id’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`activity_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`activity_rule_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`coupon_id` STRING COMMENT ‘使用优惠券id’,</p>
<p>`date_id` STRING COMMENT ‘取消订单日期id’,</p>
<p>`cancel_time` STRING COMMENT ‘取消订单时间’,</p>
<p>`source_id` STRING COMMENT ‘来源编号’,</p>
<p>`source_type_code` STRING COMMENT ‘来源类型编码’,</p>
<p>`source_type_name` STRING COMMENT ‘来源类型名称’,</p>
<p>`sku_num` BIGINT COMMENT ‘商品数量’,</p>
<p>`split_original_amount` DECIMAL(16, 2) COMMENT ‘原始价格’,</p>
<p>`split_activity_amount` DECIMAL(16, 2) COMMENT ‘活动优惠分摊’,</p>
<p>`split_coupon_amount` DECIMAL(16, 2) COMMENT ‘优惠券优惠分摊’,</p>
<p>`split_total_amount` DECIMAL(16, 2) COMMENT ‘最终价格分摊’</p>
<p>) COMMENT ‘交易域取消订单明细事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_cancel_detail_inc/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dwd_trade_cancel_detail_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(canel_time,’yyyy-MM-dd’) date_id,</p>
<p>canel_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(canel_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id,</p>
<p>data.operate_time canel_time</p>
<p>from ods_order_info_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>and data.order_status=’1003’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_trade_cancel_detail_inc partition (dt=’2020-06-15’)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(canel_time,’yyyy-MM-dd’) date_id,</p>
<p>canel_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where (dt=’2020-06-15’ or dt=date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id,</p>
<p>data.operate_time canel_time</p>
<p>from ods_order_info_inc</p>
<p>where dt = ‘2020-06-15’</p>
<p>and type = ‘update’</p>
<p>and data.order_status=’1003’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>) oi</p>
<p>on order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where (dt=’2020-06-15’ or dt=date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where (dt=’2020-06-15’ or dt=date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<h3 id="交易域支付成功事务事实表"><a href="#交易域支付成功事务事实表" class="headerlink" title="交易域支付成功事务事实表"></a>交易域支付成功事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_pay_detail_suc_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_pay_detail_suc_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`order_id` STRING COMMENT ‘订单id’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`activity_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`activity_rule_id` STRING COMMENT ‘参与活动规则id’,</p>
<p>`coupon_id` STRING COMMENT ‘使用优惠券id’,</p>
<p>`payment_type_code` STRING COMMENT ‘支付类型编码’,</p>
<p>`payment_type_name` STRING COMMENT ‘支付类型名称’,</p>
<p>`date_id` STRING COMMENT ‘支付日期id’,</p>
<p>`callback_time` STRING COMMENT ‘支付成功时间’,</p>
<p>`source_id` STRING COMMENT ‘来源编号’,</p>
<p>`source_type_code` STRING COMMENT ‘来源类型编码’,</p>
<p>`source_type_name` STRING COMMENT ‘来源类型名称’,</p>
<p>`sku_num` BIGINT COMMENT ‘商品数量’,</p>
<p>`split_original_amount` DECIMAL(16, 2) COMMENT ‘应支付原始金额’,</p>
<p>`split_activity_amount` DECIMAL(16, 2) COMMENT ‘支付活动优惠分摊’,</p>
<p>`split_coupon_amount` DECIMAL(16, 2) COMMENT ‘支付优惠券优惠分摊’,</p>
<p>`split_payment_amount` DECIMAL(16, 2) COMMENT ‘支付金额’</p>
<p>) COMMENT ‘交易域成功支付事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_pay_detail_suc_inc/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_trade_pay_detail_suc_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>od.order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>payment_type,</p>
<p>pay_dic.dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>src_dic.dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(callback_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time</p>
<p>from ods_payment_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.payment_status=’1602’</p>
<p>) pi</p>
<p>on od.order_id=pi.order_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where dt = ‘2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’11’</p>
<p>) pay_dic</p>
<p>on pi.payment_type=pay_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’24’</p>
<p>)src_dic</p>
<p>on od.source_type=src_dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_trade_pay_detail_suc_inc partition (dt=’2020-06-15’)</p>
<p>select</p>
<p>od.id,</p>
<p>od.order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>payment_type,</p>
<p>pay_dic.dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>src_dic.dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ods_order_detail_inc</p>
<p>where (dt = ‘2020-06-15’ or dt = date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time</p>
<p>from ods_payment_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’payment_status’)</p>
<p>and data.payment_status=’1602’</p>
<p>) pi</p>
<p>on od.order_id=pi.order_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where (dt = ‘2020-06-15’ or dt = date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ods_order_detail_activity_inc</p>
<p>where (dt = ‘2020-06-15’ or dt = date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ods_order_detail_coupon_inc</p>
<p>where (dt = ‘2020-06-15’ or dt = date_add(‘2020-06-15’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’11’</p>
<p>) pay_dic</p>
<p>on pi.payment_type=pay_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’24’</p>
<p>)src_dic</p>
<p>on od.source_type=src_dic.dic_code;</p>
<h3 id="交易域退单事务事实表"><a href="#交易域退单事务事实表" class="headerlink" title="交易域退单事务事实表"></a>交易域退单事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_order_refund_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_order_refund_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户ID’,</p>
<p>`order_id` STRING COMMENT ‘订单ID’,</p>
<p>`sku_id` STRING COMMENT ‘商品ID’,</p>
<p>`province_id` STRING COMMENT ‘地区ID’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`create_time` STRING COMMENT ‘退单时间’,</p>
<p>`refund_type_code` STRING COMMENT ‘退单类型编码’,</p>
<p>`refund_type_name` STRING COMMENT ‘退单类型名称’,</p>
<p>`refund_reason_type_code` STRING COMMENT ‘退单原因类型编码’,</p>
<p>`refund_reason_type_name` STRING COMMENT ‘退单原因类型名称’,</p>
<p>`refund_reason_txt` STRING COMMENT ‘退单原因描述’,</p>
<p>`refund_num` BIGINT COMMENT ‘退单件数’,</p>
<p>`refund_amount` DECIMAL(16, 2) COMMENT ‘退单金额’</p>
<p>) COMMENT ‘交易域退单事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_order_refund_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_trade_order_refund_inc partition(dt)</p>
<p>select</p>
<p>ri.id,</p>
<p>user_id,</p>
<p>order_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>refund_type,</p>
<p>type_dic.dic_name,</p>
<p>refund_reason_type,</p>
<p>reason_dic.dic_name,</p>
<p>refund_reason_txt,</p>
<p>refund_num,</p>
<p>refund_amount,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_type,</p>
<p>data.refund_num,</p>
<p>data.refund_amount,</p>
<p>data.refund_reason_type,</p>
<p>data.refund_reason_txt,</p>
<p>data.create_time</p>
<p>from ods_order_refund_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ri</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)oi</p>
<p>on ri.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code = ‘15’</p>
<p>)type_dic</p>
<p>on ri.refund_type=type_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code = ‘13’</p>
<p>)reason_dic</p>
<p>on ri.refund_reason_type=reason_dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_trade_order_refund_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>ri.id,</p>
<p>user_id,</p>
<p>order_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>refund_type,</p>
<p>type_dic.dic_name,</p>
<p>refund_reason_type,</p>
<p>reason_dic.dic_name,</p>
<p>refund_reason_txt,</p>
<p>refund_num,</p>
<p>refund_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_type,</p>
<p>data.refund_num,</p>
<p>data.refund_amount,</p>
<p>data.refund_reason_type,</p>
<p>data.refund_reason_txt,</p>
<p>data.create_time</p>
<p>from ods_order_refund_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’insert’</p>
<p>)ri</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and data.order_status=’1005’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>)oi</p>
<p>on ri.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code = ‘15’</p>
<p>)type_dic</p>
<p>on ri.refund_type=type_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code = ‘13’</p>
<p>)reason_dic</p>
<p>on ri.refund_reason_type=reason_dic.dic_code;</p>
<h3 id="交易域退款成功事务事实表"><a href="#交易域退款成功事务事实表" class="headerlink" title="交易域退款成功事务事实表"></a>交易域退款成功事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_refund_pay_suc_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_refund_pay_suc_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户ID’,</p>
<p>`order_id` STRING COMMENT ‘订单编号’,</p>
<p>`sku_id` STRING COMMENT ‘SKU编号’,</p>
<p>`province_id` STRING COMMENT ‘地区ID’,</p>
<p>`payment_type_code` STRING COMMENT ‘支付类型编码’,</p>
<p>`payment_type_name` STRING COMMENT ‘支付类型名称’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`callback_time` STRING COMMENT ‘支付成功时间’,</p>
<p>`refund_num` DECIMAL(16, 2) COMMENT ‘退款件数’,</p>
<p>`refund_amount` DECIMAL(16, 2) COMMENT ‘退款金额’</p>
<p>) COMMENT ‘交易域提交退款成功事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_refund_pay_suc_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_trade_refund_pay_suc_inc partition(dt)</p>
<p>select</p>
<p>rp.id,</p>
<p>user_id,</p>
<p>rp.order_id,</p>
<p>rp.sku_id,</p>
<p>province_id,</p>
<p>payment_type,</p>
<p>dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>refund_num,</p>
<p>total_amount,</p>
<p>date_format(callback_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time,</p>
<p>data.total_amount</p>
<p>from ods_refund_payment_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>and data.refund_status=’1602’</p>
<p>)rp</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)oi</p>
<p>on rp.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_num</p>
<p>from ods_order_refund_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ri</p>
<p>on rp.order_id=ri.order_id</p>
<p>and rp.sku_id=ri.sku_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’11’</p>
<p>)dic</p>
<p>on rp.payment_type=dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_trade_refund_pay_suc_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>rp.id,</p>
<p>user_id,</p>
<p>rp.order_id,</p>
<p>rp.sku_id,</p>
<p>province_id,</p>
<p>payment_type,</p>
<p>dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>refund_num,</p>
<p>total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time,</p>
<p>data.total_amount</p>
<p>from ods_refund_payment_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type = ‘update’</p>
<p>and array_contains(map_keys(old),’refund_status’)</p>
<p>and data.refund_status=’1602’</p>
<p>)rp</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ods_order_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and data.order_status=’1006’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>)oi</p>
<p>on rp.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_num</p>
<p>from ods_order_refund_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and data.refund_status=’0705’</p>
<p>and array_contains(map_keys(old),’refund_status’)</p>
<p>)ri</p>
<p>on rp.order_id=ri.order_id</p>
<p>and rp.sku_id=ri.sku_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’11’</p>
<p>)dic</p>
<p>on rp.payment_type=dic.dic_code;</p>
<h3 id="交易域购物车周期快照事实表"><a href="#交易域购物车周期快照事实表" class="headerlink" title="交易域购物车周期快照事实表"></a>交易域购物车周期快照事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_trade_cart_full;</p>
<p>CREATE EXTERNAL TABLE dwd_trade_cart_full</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`sku_name` STRING COMMENT ‘商品名称’,</p>
<p>`sku_num` BIGINT COMMENT ‘加购物车件数’</p>
<p>) COMMENT ‘交易域购物车周期快照事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_trade_cart_full/‘</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dwd_trade_cart_full partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>sku_num</p>
<p>from ods_cart_info_full</p>
<p>where dt=’2020-06-14’</p>
<p>and is_ordered=’0’;</p>
<h3 id="工具域优惠券领取事务事实表"><a href="#工具域优惠券领取事务事实表" class="headerlink" title="工具域优惠券领取事务事实表"></a>工具域优惠券领取事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_tool_coupon_get_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_tool_coupon_get_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`coupon_id` STRING COMMENT ‘优惠券ID’,</p>
<p>`user_id` STRING COMMENT ‘userid’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`get_time` STRING COMMENT ‘领取时间’</p>
<p>) COMMENT ‘优惠券领取事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_tool_coupon_get_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_get_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’) date_id,</p>
<p>data.get_time,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’)</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_get_inc partition (dt=’2020-06-15’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’) date_id,</p>
<p>data.get_time</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’insert’;</p>
<h3 id="工具域优惠券使用-下单-事务事实表"><a href="#工具域优惠券使用-下单-事务事实表" class="headerlink" title="工具域优惠券使用(下单)事务事实表"></a>工具域优惠券使用(下单)事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_tool_coupon_order_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_tool_coupon_order_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`coupon_id` STRING COMMENT ‘优惠券ID’,</p>
<p>`user_id` STRING COMMENT ‘user_id’,</p>
<p>`order_id` STRING COMMENT ‘order_id’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`order_time` STRING COMMENT ‘使用下单时间’</p>
<p>) COMMENT ‘优惠券使用下单事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_tool_coupon_order_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_order_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’) date_id,</p>
<p>data.using_time,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’)</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.using_time is not null;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_order_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’) date_id,</p>
<p>data.using_time</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’using_time’);</p>
<h3 id="工具域优惠券使用-支付-事务事实表"><a href="#工具域优惠券使用-支付-事务事实表" class="headerlink" title="工具域优惠券使用(支付)事务事实表"></a>工具域优惠券使用(支付)事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_tool_coupon_pay_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_tool_coupon_pay_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`coupon_id` STRING COMMENT ‘优惠券ID’,</p>
<p>`user_id` STRING COMMENT ‘user_id’,</p>
<p>`order_id` STRING COMMENT ‘order_id’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`payment_time` STRING COMMENT ‘使用下单时间’</p>
<p>) COMMENT ‘优惠券使用支付事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_tool_coupon_pay_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_pay_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’) date_id,</p>
<p>data.used_time,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’)</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.used_time is not null;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_tool_coupon_pay_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’) date_id,</p>
<p>data.used_time</p>
<p>from ods_coupon_use_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’used_time’);</p>
<h3 id="互动域收藏商品事务事实表"><a href="#互动域收藏商品事务事实表" class="headerlink" title="互动域收藏商品事务事实表"></a>互动域收藏商品事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_interaction_favor_add_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_interaction_favor_add_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`create_time` STRING COMMENT ‘收藏时间’</p>
<p>) COMMENT ‘收藏事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_interaction_favor_add_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dwd_interaction_favor_add_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’) date_id,</p>
<p>data.create_time,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’)</p>
<p>from ods_favor_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type = ‘bootstrap-insert’;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_interaction_favor_add_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’) date_id,</p>
<p>data.create_time</p>
<p>from ods_favor_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type = ‘insert’;</p>
<h3 id="互动域评价事务事实表"><a href="#互动域评价事务事实表" class="headerlink" title="互动域评价事务事实表"></a>互动域评价事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_interaction_comment_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_interaction_comment_inc</p>
<p>(</p>
<p>`id` STRING COMMENT ‘编号’,</p>
<p>`user_id` STRING COMMENT ‘用户ID’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`order_id` STRING COMMENT ‘订单ID’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`create_time` STRING COMMENT ‘评价时间’,</p>
<p>`appraise_code` STRING COMMENT ‘评价编码’,</p>
<p>`appraise_name` STRING COMMENT ‘评价名称’</p>
<p>) COMMENT ‘评价事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_interaction_comment_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dwd_interaction_comment_inc partition(dt)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>order_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>appraise,</p>
<p>dic_name,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.order_id,</p>
<p>data.create_time,</p>
<p>data.appraise</p>
<p>from ods_comment_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-14’</p>
<p>and parent_code=’12’</p>
<p>)dic</p>
<p>on ci.appraise=dic.dic_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_interaction_comment_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>order_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>appraise,</p>
<p>dic_name</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.order_id,</p>
<p>data.create_time,</p>
<p>data.appraise</p>
<p>from ods_comment_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ods_base_dic_full</p>
<p>where dt=’2020-06-15’</p>
<p>and parent_code=’12’</p>
<p>)dic</p>
<p>on ci.appraise=dic.dic_code;</p>
<h3 id="流量域页面浏览事务事实表"><a href="#流量域页面浏览事务事实表" class="headerlink" title="流量域页面浏览事务事实表"></a>流量域页面浏览事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_traffic_page_view_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_traffic_page_view_inc</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`brand` STRING COMMENT ‘手机品牌’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`is_new` STRING COMMENT ‘是否首次启动’,</p>
<p>`model` STRING COMMENT ‘手机型号’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`operate_system` STRING COMMENT ‘操作系统’,</p>
<p>`user_id` STRING COMMENT ‘会员id’,</p>
<p>`version_code` STRING COMMENT ‘app版本号’,</p>
<p>`page_item` STRING COMMENT ‘目标id ‘,</p>
<p>`page_item_type` STRING COMMENT ‘目标类型’,</p>
<p>`last_page_id` STRING COMMENT ‘上页类型’,</p>
<p>`page_id` STRING COMMENT ‘页面ID ‘,</p>
<p>`source_type` STRING COMMENT ‘来源类型’,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`view_time` STRING COMMENT ‘跳入时间’,</p>
<p>`session_id` STRING COMMENT ‘所属会话id’,</p>
<p>`during_time` BIGINT COMMENT ‘持续时间毫秒’</p>
<p>) COMMENT ‘页面日志表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_traffic_page_view_inc’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table dwd_traffic_page_view_inc partition (dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) view_time,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over (partition by mid_id<br>order by ts)) session_id,</p>
<p>during_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and page is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="流量域启动事务事实表"><a href="#流量域启动事务事实表" class="headerlink" title="流量域启动事务事实表"></a>流量域启动事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_traffic_start_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_traffic_start_inc</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`brand` STRING COMMENT ‘手机品牌’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`is_new` STRING COMMENT ‘是否首次启动’,</p>
<p>`model` STRING COMMENT ‘手机型号’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`operate_system` STRING COMMENT ‘操作系统’,</p>
<p>`user_id` STRING COMMENT ‘会员id’,</p>
<p>`version_code` STRING COMMENT ‘app版本号’,</p>
<p>`entry` STRING COMMENT ‘icon手机图标 notice 通知’,</p>
<p>`open_ad_id` STRING COMMENT ‘广告页ID ‘,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`start_time` STRING COMMENT ‘启动时间’,</p>
<p>`loading_time_ms` BIGINT COMMENT ‘启动加载时间’,</p>
<p>`open_ad_ms` BIGINT COMMENT ‘广告总共播放时间’,</p>
<p>`open_ad_skip_ms` BIGINT COMMENT ‘用户跳过广告时点’</p>
<p>) COMMENT ‘启动日志表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_traffic_start_inc’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table dwd_traffic_start_inc partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>entry,</p>
<p>open_ad_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time,</p>
<p>loading_time,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>`start`.entry,</p>
<p>`start`.loading_time,</p>
<p>`start`.open_ad_id,</p>
<p>`start`.open_ad_ms,</p>
<p>`start`.open_ad_skip_ms,</p>
<p>ts</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and `start` is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="流量域动作事务事实表"><a href="#流量域动作事务事实表" class="headerlink" title="流量域动作事务事实表"></a>流量域动作事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_traffic_action_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_traffic_action_inc</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`brand` STRING COMMENT ‘手机品牌’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`is_new` STRING COMMENT ‘是否首次启动’,</p>
<p>`model` STRING COMMENT ‘手机型号’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`operate_system` STRING COMMENT ‘操作系统’,</p>
<p>`user_id` STRING COMMENT ‘会员id’,</p>
<p>`version_code` STRING COMMENT ‘app版本号’,</p>
<p>`during_time` BIGINT COMMENT ‘持续时间毫秒’,</p>
<p>`page_item` STRING COMMENT ‘目标id ‘,</p>
<p>`page_item_type` STRING COMMENT ‘目标类型’,</p>
<p>`last_page_id` STRING COMMENT ‘上页类型’,</p>
<p>`page_id` STRING COMMENT ‘页面id ‘,</p>
<p>`source_type` STRING COMMENT ‘来源类型’,</p>
<p>`action_id` STRING COMMENT ‘动作id’,</p>
<p>`action_item` STRING COMMENT ‘目标id ‘,</p>
<p>`action_item_type` STRING COMMENT ‘目标类型’,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`action_time` STRING COMMENT ‘动作发生时间’</p>
<p>) COMMENT ‘动作日志表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_traffic_action_inc’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table dwd_traffic_action_inc partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>action_id,</p>
<p>action_item,</p>
<p>action_item_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>action.action_id,</p>
<p>action.item action_item,</p>
<p>action.item_type action_item_type,</p>
<p>action.ts</p>
<p>from ods_log_inc lateral view explode(actions) tmp as action</p>
<p>where dt=’2020-06-14’</p>
<p>and actions is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="流量域曝光事务事实表"><a href="#流量域曝光事务事实表" class="headerlink" title="流量域曝光事务事实表"></a>流量域曝光事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_traffic_display_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_traffic_display_inc</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`brand` STRING COMMENT ‘手机品牌’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`is_new` STRING COMMENT ‘是否首次启动’,</p>
<p>`model` STRING COMMENT ‘手机型号’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`operate_system` STRING COMMENT ‘操作系统’,</p>
<p>`user_id` STRING COMMENT ‘会员id’,</p>
<p>`version_code` STRING COMMENT ‘app版本号’,</p>
<p>`during_time` BIGINT COMMENT ‘app版本号’,</p>
<p>`page_item` STRING COMMENT ‘目标id ‘,</p>
<p>`page_item_type` STRING COMMENT ‘目标类型’,</p>
<p>`last_page_id` STRING COMMENT ‘上页类型’,</p>
<p>`page_id` STRING COMMENT ‘页面ID ‘,</p>
<p>`source_type` STRING COMMENT ‘来源类型’,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`display_time` STRING COMMENT ‘曝光时间’,</p>
<p>`display_type` STRING COMMENT ‘曝光类型’,</p>
<p>`display_item` STRING COMMENT ‘曝光对象id ‘,</p>
<p>`display_item_type` STRING COMMENT ‘app版本号’,</p>
<p>`display_order` BIGINT COMMENT ‘曝光顺序’,</p>
<p>`display_pos_id` BIGINT COMMENT ‘曝光位置’</p>
<p>) COMMENT ‘曝光日志表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_traffic_display_inc’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table dwd_traffic_display_inc partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) display_time,</p>
<p>display_type,</p>
<p>display_item,</p>
<p>display_item_type,</p>
<p>display_order,</p>
<p>display_pos_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>display.display_type,</p>
<p>display.item display_item,</p>
<p>display.item_type display_item_type,</p>
<p>display.`order` display_order,</p>
<p>display.pos_id display_pos_id,</p>
<p>ts</p>
<p>from ods_log_inc lateral view explode(displays) tmp as display</p>
<p>where dt=’2020-06-14’</p>
<p>and displays is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="流量域错误事务事实表"><a href="#流量域错误事务事实表" class="headerlink" title="流量域错误事务事实表"></a>流量域错误事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_traffic_error_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_traffic_error_inc</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘地区编码’,</p>
<p>`brand` STRING COMMENT ‘手机品牌’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`is_new` STRING COMMENT ‘是否首次启动’,</p>
<p>`model` STRING COMMENT ‘手机型号’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`operate_system` STRING COMMENT ‘操作系统’,</p>
<p>`user_id` STRING COMMENT ‘会员id’,</p>
<p>`version_code` STRING COMMENT ‘app版本号’,</p>
<p>`page_item` STRING COMMENT ‘目标id ‘,</p>
<p>`page_item_type` STRING COMMENT ‘目标类型’,</p>
<p>`last_page_id` STRING COMMENT ‘上页类型’,</p>
<p>`page_id` STRING COMMENT ‘页面ID ‘,</p>
<p>`source_type` STRING COMMENT ‘来源类型’,</p>
<p>`entry` STRING COMMENT ‘icon手机图标 notice 通知’,</p>
<p>`loading_time` STRING COMMENT ‘启动加载时间’,</p>
<p>`open_ad_id` STRING COMMENT ‘广告页ID ‘,</p>
<p>`open_ad_ms` STRING COMMENT ‘广告总共播放时间’,</p>
<p>`open_ad_skip_ms` STRING COMMENT ‘用户跳过广告时点’,</p>
<p>`actions`<br>ARRAY&lt;STRUCT&lt;action_id:STRING,item:STRING,item_type:STRING,ts:BIGINT&gt;&gt;<br>COMMENT ‘动作信息’,</p>
<p>`displays` ARRAY&lt;STRUCT&lt;display_type :STRING,item :STRING,item_type<br>:STRING,`order` :STRING,pos_id</p>
<p>:STRING&gt;&gt; COMMENT ‘曝光信息’,</p>
<p>`date_id` STRING COMMENT ‘日期id’,</p>
<p>`error_time` STRING COMMENT ‘错误时间’,</p>
<p>`error_code` STRING COMMENT ‘错误码’,</p>
<p>`error_msg` STRING COMMENT ‘错误信息’</p>
<p>) COMMENT ‘错误日志表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_traffic_error_inc’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>set hive.cbo.enable=false;</p>
<p>set hive.execution.engine=mr;</p>
<p>insert overwrite table dwd_traffic_error_inc partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>entry,</p>
<p>loading_time,</p>
<p>open_ad_id,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) error_time,</p>
<p>error_code,</p>
<p>error_msg</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>`start`.entry,</p>
<p>`start`.loading_time,</p>
<p>`start`.open_ad_id,</p>
<p>`start`.open_ad_ms,</p>
<p>`start`.open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>err.error_code,</p>
<p>err.msg error_msg,</p>
<p>ts</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and err is not null</p>
<p>)log</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="用户域用户注册事务事实表"><a href="#用户域用户注册事务事实表" class="headerlink" title="用户域用户注册事务事实表"></a>用户域用户注册事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_user_register_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_user_register_inc</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户ID’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`create_time` STRING COMMENT ‘注册时间’,</p>
<p>`channel` STRING COMMENT ‘应用下载渠道’,</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`version_code` STRING COMMENT ‘应用版本’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`brand` STRING COMMENT ‘设备品牌’,</p>
<p>`model` STRING COMMENT ‘设备型号’,</p>
<p>`operate_system` STRING COMMENT ‘设备操作系统’</p>
<p>) COMMENT ‘用户域用户注册事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_user_register_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dwd_user_register_inc partition(dt)</p>
<p>select</p>
<p>ui.user_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id user_id,</p>
<p>data.create_time</p>
<p>from ods_user_info_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ui</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and page.page_id=’register’</p>
<p>and common.uid is not null</p>
<p>)log</p>
<p>on ui.user_id=log.user_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dwd_user_register_inc partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>ui.user_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id user_id,</p>
<p>data.create_time</p>
<p>from ods_user_info_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and type=’insert’</p>
<p>)ui</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-15’</p>
<p>and page.page_id=’register’</p>
<p>and common.uid is not null</p>
<p>)log</p>
<p>on ui.user_id=log.user_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-15’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<h3 id="用户域用户登录事务事实表"><a href="#用户域用户登录事务事实表" class="headerlink" title="用户域用户登录事务事实表"></a>用户域用户登录事务事实表</h3><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dwd_user_login_inc;</p>
<p>CREATE EXTERNAL TABLE dwd_user_login_inc</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户ID’,</p>
<p>`date_id` STRING COMMENT ‘日期ID’,</p>
<p>`login_time` STRING COMMENT ‘登录时间’,</p>
<p>`channel` STRING COMMENT ‘应用下载渠道’,</p>
<p>`province_id` STRING COMMENT ‘省份id’,</p>
<p>`version_code` STRING COMMENT ‘应用版本’,</p>
<p>`mid_id` STRING COMMENT ‘设备id’,</p>
<p>`brand` STRING COMMENT ‘设备品牌’,</p>
<p>`model` STRING COMMENT ‘设备型号’,</p>
<p>`operate_system` STRING COMMENT ‘设备操作系统’</p>
<p>) COMMENT ‘用户域用户登录事务事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dwd/dwd_user_login_inc/‘</p>
<p>TBLPROPERTIES (“orc.compress” = “snappy”);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dwd_user_login_inc partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) login_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>row_number() over (partition by session_id order by ts) rn</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over(partition by mid_id<br>order by ts)) session_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.uid user_id,</p>
<p>common.ch channel,</p>
<p>common.ar area_code,</p>
<p>common.vc version_code,</p>
<p>common.mid mid_id,</p>
<p>common.ba brand,</p>
<p>common.md model,</p>
<p>common.os operate_system,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ods_log_inc</p>
<p>where dt=’2020-06-14’</p>
<p>and page is not null</p>
<p>)t1</p>
<p>)t2</p>
<p>where user_id is not null</p>
<p>)t3</p>
<p>where rn=1</p>
<p>)t4</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ods_base_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)bp</p>
<p>on t4.area_code=bp.area_code;</p>
<h3 id="数据装载脚本-2"><a href="#数据装载脚本-2" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h3><h4 id="首日装载脚本-1"><a href="#首日装载脚本-1" class="headerlink" title="首日装载脚本"></a>首日装载脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建ods_to_dwd_init.sh</p>
<p>[atguigu@hadoop102 bin]$ vim ods_to_dwd_init.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>echo “请传入日期参数”</p>
<p>exit</p>
<p>fi</p>
<p>dwd_interaction_comment_inc=”</p>
<p>insert overwrite table ${APP}.dwd_interaction_comment_inc partition(dt)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>order_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>appraise,</p>
<p>dic_name,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.order_id,</p>
<p>data.create_time,</p>
<p>data.appraise</p>
<p>from ${APP}.ods_comment_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’12’</p>
<p>)dic</p>
<p>on ci.appraise=dic.dic_code;</p>
<p>“</p>
<p>dwd_interaction_favor_add_inc=”</p>
<p>insert overwrite table ${APP}.dwd_interaction_favor_add_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’) date_id,</p>
<p>data.create_time,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’)</p>
<p>from ${APP}.ods_favor_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type = ‘bootstrap-insert’;</p>
<p>“</p>
<p>dwd_tool_coupon_get_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_get_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’) date_id,</p>
<p>data.get_time,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’)</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’;</p>
<p>“</p>
<p>dwd_tool_coupon_order_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_order_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’) date_id,</p>
<p>data.using_time,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’)</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.using_time is not null;</p>
<p>“</p>
<p>dwd_tool_coupon_pay_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_pay_inc partition(dt)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’) date_id,</p>
<p>data.used_time,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’)</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.used_time is not null;</p>
<p>“</p>
<p>dwd_trade_cancel_detail_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cancel_detail_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(canel_time,’yyyy-MM-dd’) date_id,</p>
<p>canel_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(canel_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id,</p>
<p>data.operate_time canel_time</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>and data.order_status=’1003’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_cart_add_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cart_add_inc partition (dt)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic.dic_name,</p>
<p>sku_num,</p>
<p>date_format(create_time, ‘yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num</p>
<p>from ${APP}.ods_cart_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on ci.source_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_cart_full=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cart_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>sku_num</p>
<p>from ${APP}.ods_cart_info_full</p>
<p>where dt=’$do_date’</p>
<p>and is_ordered=’0’;</p>
<p>“</p>
<p>dwd_trade_order_detail_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_order_detail_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(create_time, ‘yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_order_refund_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_order_refund_inc partition(dt)</p>
<p>select</p>
<p>ri.id,</p>
<p>user_id,</p>
<p>order_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>refund_type,</p>
<p>type_dic.dic_name,</p>
<p>refund_reason_type,</p>
<p>reason_dic.dic_name,</p>
<p>refund_reason_txt,</p>
<p>refund_num,</p>
<p>refund_amount,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_type,</p>
<p>data.refund_num,</p>
<p>data.refund_amount,</p>
<p>data.refund_reason_type,</p>
<p>data.refund_reason_txt,</p>
<p>data.create_time</p>
<p>from ${APP}.ods_order_refund_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ri</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)oi</p>
<p>on ri.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code = ‘15’</p>
<p>)type_dic</p>
<p>on ri.refund_type=type_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code = ‘13’</p>
<p>)reason_dic</p>
<p>on ri.refund_reason_type=reason_dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_pay_detail_suc_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_pay_detail_suc_inc partition (dt)</p>
<p>select</p>
<p>od.id,</p>
<p>od.order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>payment_type,</p>
<p>pay_dic.dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>src_dic.dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount,</p>
<p>date_format(callback_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time</p>
<p>from ${APP}.ods_payment_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>and data.payment_status=’1602’</p>
<p>) pi</p>
<p>on od.order_id=pi.order_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’11’</p>
<p>) pay_dic</p>
<p>on pi.payment_type=pay_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)src_dic</p>
<p>on od.source_type=src_dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_refund_pay_suc_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_refund_pay_suc_inc partition(dt)</p>
<p>select</p>
<p>rp.id,</p>
<p>user_id,</p>
<p>rp.order_id,</p>
<p>rp.sku_id,</p>
<p>province_id,</p>
<p>payment_type,</p>
<p>dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>refund_num,</p>
<p>total_amount,</p>
<p>date_format(callback_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time,</p>
<p>data.total_amount</p>
<p>from ${APP}.ods_refund_payment_inc</p>
<p>where dt=’$do_date’</p>
<p>and type = ‘bootstrap-insert’</p>
<p>and data.refund_status=’1602’</p>
<p>)rp</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)oi</p>
<p>on rp.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_num</p>
<p>from ${APP}.ods_order_refund_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ri</p>
<p>on rp.order_id=ri.order_id</p>
<p>and rp.sku_id=ri.sku_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’11’</p>
<p>)dic</p>
<p>on rp.payment_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_traffic_action_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_action_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>action_id,</p>
<p>action_item,</p>
<p>action_item_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>action.action_id,</p>
<p>action.item action_item,</p>
<p>action.item_type action_item_type,</p>
<p>action.ts</p>
<p>from ${APP}.ods_log_inc lateral view explode(actions) tmp as action</p>
<p>where dt=’$do_date’</p>
<p>and actions is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_display_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_display_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) display_time,</p>
<p>display_type,</p>
<p>display_item,</p>
<p>display_item_type,</p>
<p>display_order,</p>
<p>display_pos_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>display.display_type,</p>
<p>display.item display_item,</p>
<p>display.item_type display_item_type,</p>
<p>display.\`order\` display_order,</p>
<p>display.pos_id display_pos_id,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc lateral view explode(displays) tmp as display</p>
<p>where dt=’$do_date’</p>
<p>and displays is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_error_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>set hive.execution.engine=mr;</p>
<p>insert overwrite table ${APP}.dwd_traffic_error_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>entry,</p>
<p>loading_time,</p>
<p>open_ad_id,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) error_time,</p>
<p>error_code,</p>
<p>error_msg</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>\`start\`.entry,</p>
<p>\`start\`.loading_time,</p>
<p>\`start\`.open_ad_id,</p>
<p>\`start\`.open_ad_ms,</p>
<p>\`start\`.open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>err.error_code,</p>
<p>err.msg error_msg,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and err is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>set hive.execution.engine=spark;</p>
<p>“</p>
<p>dwd_traffic_page_view_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_page_view_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) view_time,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over (partition by mid_id<br>order by ts)) session_id,</p>
<p>during_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_start_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_start_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>entry,</p>
<p>open_ad_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time,</p>
<p>loading_time,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>\`start\`.entry,</p>
<p>\`start\`.loading_time,</p>
<p>\`start\`.open_ad_id,</p>
<p>\`start\`.open_ad_ms,</p>
<p>\`start\`.open_ad_skip_ms,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and \`start\` is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_user_login_inc=”</p>
<p>insert overwrite table ${APP}.dwd_user_login_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) login_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>row_number() over (partition by session_id order by ts) rn</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over(partition by mid_id<br>order by ts)) session_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.uid user_id,</p>
<p>common.ch channel,</p>
<p>common.ar area_code,</p>
<p>common.vc version_code,</p>
<p>common.mid mid_id,</p>
<p>common.ba brand,</p>
<p>common.md model,</p>
<p>common.os operate_system,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page is not null</p>
<p>)t1</p>
<p>)t2</p>
<p>where user_id is not null</p>
<p>)t3</p>
<p>where rn=1</p>
<p>)t4</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on t4.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_user_register_inc=”</p>
<p>insert overwrite table ${APP}.dwd_user_register_inc partition(dt)</p>
<p>select</p>
<p>ui.user_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>date_format(create_time,’yyyy-MM-dd’)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id user_id,</p>
<p>data.create_time</p>
<p>from ${APP}.ods_user_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’bootstrap-insert’</p>
<p>)ui</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page.page_id=’register’</p>
<p>and common.uid is not null</p>
<p>)log</p>
<p>on ui.user_id=log.user_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dwd_interaction_comment_inc” )</p>
<p>hive -e “$dwd_interaction_comment_inc”</p>
<p>;;</p>
<p>“dwd_interaction_favor_add_inc” )</p>
<p>hive -e “$dwd_interaction_favor_add_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_get_inc” )</p>
<p>hive -e “$dwd_tool_coupon_get_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_order_inc” )</p>
<p>hive -e “$dwd_tool_coupon_order_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_pay_inc” )</p>
<p>hive -e “$dwd_tool_coupon_pay_inc”</p>
<p>;;</p>
<p>“dwd_trade_cancel_detail_inc” )</p>
<p>hive -e “$dwd_trade_cancel_detail_inc”</p>
<p>;;</p>
<p>“dwd_trade_cart_add_inc” )</p>
<p>hive -e “$dwd_trade_cart_add_inc”</p>
<p>;;</p>
<p>“dwd_trade_cart_full” )</p>
<p>hive -e “$dwd_trade_cart_full”</p>
<p>;;</p>
<p>“dwd_trade_order_detail_inc” )</p>
<p>hive -e “$dwd_trade_order_detail_inc”</p>
<p>;;</p>
<p>“dwd_trade_order_refund_inc” )</p>
<p>hive -e “$dwd_trade_order_refund_inc”</p>
<p>;;</p>
<p>“dwd_trade_pay_detail_suc_inc” )</p>
<p>hive -e “$dwd_trade_pay_detail_suc_inc”</p>
<p>;;</p>
<p>“dwd_trade_refund_pay_suc_inc” )</p>
<p>hive -e “$dwd_trade_refund_pay_suc_inc”</p>
<p>;;</p>
<p>“dwd_traffic_action_inc” )</p>
<p>hive -e “$dwd_traffic_action_inc”</p>
<p>;;</p>
<p>“dwd_traffic_display_inc” )</p>
<p>hive -e “$dwd_traffic_display_inc”</p>
<p>;;</p>
<p>“dwd_traffic_error_inc” )</p>
<p>hive -e “$dwd_traffic_error_inc”</p>
<p>;;</p>
<p>“dwd_traffic_page_view_inc” )</p>
<p>hive -e “$dwd_traffic_page_view_inc”</p>
<p>;;</p>
<p>“dwd_traffic_start_inc” )</p>
<p>hive -e “$dwd_traffic_start_inc”</p>
<p>;;</p>
<p>“dwd_user_login_inc” )</p>
<p>hive -e “$dwd_user_login_inc”</p>
<p>;;</p>
<p>“dwd_user_register_inc” )</p>
<p>hive -e “$dwd_user_register_inc”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dwd_interaction_comment_inc$dwd_interaction_favor_add_inc$dwd_tool_coupon_get_inc$dwd_tool_coupon_order_inc$dwd_tool_coupon_pay_inc$dwd_trade_cancel_detail_inc$dwd_trade_cart_add_inc$dwd_trade_cart_full$dwd_trade_order_detail_inc$dwd_trade_order_refund_inc$dwd_trade_pay_detail_suc_inc$dwd_trade_refund_pay_suc_inc$dwd_traffic_action_inc$dwd_traffic_display_inc$dwd_traffic_error_inc$dwd_traffic_page_view_inc$dwd_traffic_start_inc$dwd_user_login_inc$dwd_user_register_inc”</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x ods_to_dwd_init.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ ods_to_dwd_init.sh all 2020-06-14</p>
<h4 id="每日装载脚本-1"><a href="#每日装载脚本-1" class="headerlink" title="每日装载脚本"></a>每日装载脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建ods_to_dwd.sh</p>
<p>[atguigu@hadoop102 bin]$ vim ods_to_dwd.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>dwd_interaction_comment_inc=”</p>
<p>insert overwrite table ${APP}.dwd_interaction_comment_inc<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>order_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>appraise,</p>
<p>dic_name</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>data.order_id,</p>
<p>data.create_time,</p>
<p>data.appraise</p>
<p>from ${APP}.ods_comment_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’insert’</p>
<p>)ci</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’12’</p>
<p>)dic</p>
<p>on ci.appraise=dic.dic_code;</p>
<p>“</p>
<p>dwd_interaction_favor_add_inc=”</p>
<p>insert overwrite table ${APP}.dwd_interaction_favor_add_inc<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time,’yyyy-MM-dd’) date_id,</p>
<p>data.create_time</p>
<p>from ${APP}.ods_favor_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type = ‘insert’;</p>
<p>“</p>
<p>dwd_tool_coupon_get_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_get_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>date_format(data.get_time,’yyyy-MM-dd’) date_id,</p>
<p>data.get_time</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’insert’;</p>
<p>“</p>
<p>dwd_tool_coupon_order_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_order_inc<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.using_time,’yyyy-MM-dd’) date_id,</p>
<p>data.using_time</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’using_time’);</p>
<p>“</p>
<p>dwd_tool_coupon_pay_inc=”</p>
<p>insert overwrite table ${APP}.dwd_tool_coupon_pay_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>data.id,</p>
<p>data.coupon_id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>date_format(data.used_time,’yyyy-MM-dd’) date_id,</p>
<p>data.used_time</p>
<p>from ${APP}.ods_coupon_use_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’used_time’);</p>
<p>“</p>
<p>dwd_trade_cancel_detail_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cancel_detail_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_format(canel_time,’yyyy-MM-dd’) date_id,</p>
<p>canel_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where (dt=’$do_date’ or dt=date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id,</p>
<p>data.operate_time canel_time</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘update’</p>
<p>and data.order_status=’1003’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>) oi</p>
<p>on order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where (dt=’$do_date’ or dt=date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where (dt=’$do_date’ or dt=date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type= ‘bootstrap-insert’)</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_cart_add_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cart_add_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type_code,</p>
<p>source_type_name,</p>
<p>sku_num</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.sku_id,</p>
<p>date_format(from_utc_timestamp(ts*1000,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts*1000,’GMT+8’),’yyyy-MM-dd HH:mm:ss’)<br>create_time,</p>
<p>data.source_id,</p>
<p>data.source_type source_type_code,</p>
<p>if(type=’insert’,data.sku_num,data.sku_num-old[‘sku_num’]) sku_num</p>
<p>from ${APP}.ods_cart_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and (type=’insert’</p>
<p>or(type=’update’ and old[‘sku_num’] is not null and<br>data.sku_num&gt;cast(old[‘sku_num’] as int)))</p>
<p>)cart</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name source_type_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on cart.source_type_code=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_cart_full=”</p>
<p>insert overwrite table ${APP}.dwd_trade_cart_full partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>sku_num</p>
<p>from ${APP}.ods_cart_info_full</p>
<p>where dt=’$do_date’</p>
<p>and is_ordered=’0’;</p>
<p>“</p>
<p>dwd_trade_order_detail_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_order_detail_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>od.id,</p>
<p>order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>date_id,</p>
<p>create_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>date_format(data.create_time, ‘yyyy-MM-dd’) date_id,</p>
<p>data.create_time,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘insert’</p>
<p>) od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘insert’</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘insert’</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where dt = ‘$do_date’</p>
<p>and type = ‘insert’</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)dic</p>
<p>on od.source_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_order_refund_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_order_refund_inc<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>ri.id,</p>
<p>user_id,</p>
<p>order_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>refund_type,</p>
<p>type_dic.dic_name,</p>
<p>refund_reason_type,</p>
<p>reason_dic.dic_name,</p>
<p>refund_reason_txt,</p>
<p>refund_num,</p>
<p>refund_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_type,</p>
<p>data.refund_num,</p>
<p>data.refund_amount,</p>
<p>data.refund_reason_type,</p>
<p>data.refund_reason_txt,</p>
<p>data.create_time</p>
<p>from ${APP}.ods_order_refund_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’insert’</p>
<p>)ri</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and data.order_status=’1005’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>)oi</p>
<p>on ri.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code = ‘15’</p>
<p>)type_dic</p>
<p>on ri.refund_type=type_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code = ‘13’</p>
<p>)reason_dic</p>
<p>on ri.refund_reason_type=reason_dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_pay_detail_suc_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_pay_detail_suc_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>od.id,</p>
<p>od.order_id,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>province_id,</p>
<p>activity_id,</p>
<p>activity_rule_id,</p>
<p>coupon_id,</p>
<p>payment_type,</p>
<p>pay_dic.dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>source_id,</p>
<p>source_type,</p>
<p>src_dic.dic_name,</p>
<p>sku_num,</p>
<p>split_original_amount,</p>
<p>split_activity_amount,</p>
<p>split_coupon_amount,</p>
<p>split_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.source_id,</p>
<p>data.source_type,</p>
<p>data.sku_num,</p>
<p>data.sku_num * data.order_price split_original_amount,</p>
<p>data.split_total_amount,</p>
<p>data.split_activity_amount,</p>
<p>data.split_coupon_amount</p>
<p>from ${APP}.ods_order_detail_inc</p>
<p>where (dt = ‘$do_date’ or dt = date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) od</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>data.user_id,</p>
<p>data.order_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time</p>
<p>from ${APP}.ods_payment_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and array_contains(map_keys(old),’payment_status’)</p>
<p>and data.payment_status=’1602’</p>
<p>) pi</p>
<p>on od.order_id=pi.order_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where (dt = ‘$do_date’ or dt = date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) oi</p>
<p>on od.order_id = oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.activity_id,</p>
<p>data.activity_rule_id</p>
<p>from ${APP}.ods_order_detail_activity_inc</p>
<p>where (dt = ‘$do_date’ or dt = date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) act</p>
<p>on od.id = act.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_detail_id,</p>
<p>data.coupon_id</p>
<p>from ${APP}.ods_order_detail_coupon_inc</p>
<p>where (dt = ‘$do_date’ or dt = date_add(‘$do_date’,-1))</p>
<p>and (type = ‘insert’ or type = ‘bootstrap-insert’)</p>
<p>) cou</p>
<p>on od.id = cou.order_detail_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’11’</p>
<p>) pay_dic</p>
<p>on pi.payment_type=pay_dic.dic_code</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’24’</p>
<p>)src_dic</p>
<p>on od.source_type=src_dic.dic_code;</p>
<p>“</p>
<p>dwd_trade_refund_pay_suc_inc=”</p>
<p>insert overwrite table ${APP}.dwd_trade_refund_pay_suc_inc<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>rp.id,</p>
<p>user_id,</p>
<p>rp.order_id,</p>
<p>rp.sku_id,</p>
<p>province_id,</p>
<p>payment_type,</p>
<p>dic_name,</p>
<p>date_format(callback_time,’yyyy-MM-dd’) date_id,</p>
<p>callback_time,</p>
<p>refund_num,</p>
<p>total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.payment_type,</p>
<p>data.callback_time,</p>
<p>data.total_amount</p>
<p>from ${APP}.ods_refund_payment_inc</p>
<p>where dt=’$do_date’</p>
<p>and type = ‘update’</p>
<p>and array_contains(map_keys(old),’refund_status’)</p>
<p>and data.refund_status=’1602’</p>
<p>)rp</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.id,</p>
<p>data.user_id,</p>
<p>data.province_id</p>
<p>from ${APP}.ods_order_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and data.order_status=’1006’</p>
<p>and array_contains(map_keys(old),’order_status’)</p>
<p>)oi</p>
<p>on rp.order_id=oi.id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>data.order_id,</p>
<p>data.sku_id,</p>
<p>data.refund_num</p>
<p>from ${APP}.ods_order_refund_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’update’</p>
<p>and data.refund_status=’0705’</p>
<p>and array_contains(map_keys(old),’refund_status’)</p>
<p>)ri</p>
<p>on rp.order_id=ri.order_id</p>
<p>and rp.sku_id=ri.sku_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>dic_code,</p>
<p>dic_name</p>
<p>from ${APP}.ods_base_dic_full</p>
<p>where dt=’$do_date’</p>
<p>and parent_code=’11’</p>
<p>)dic</p>
<p>on rp.payment_type=dic.dic_code;</p>
<p>“</p>
<p>dwd_traffic_action_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_action_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>action_id,</p>
<p>action_item,</p>
<p>action_item_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>action.action_id,</p>
<p>action.item action_item,</p>
<p>action.item_type action_item_type,</p>
<p>action.ts</p>
<p>from ${APP}.ods_log_inc lateral view explode(actions) tmp as action</p>
<p>where dt=’$do_date’</p>
<p>and actions is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_display_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_display_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>during_time,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) display_time,</p>
<p>display_type,</p>
<p>display_item,</p>
<p>display_item_type,</p>
<p>display_order,</p>
<p>display_pos_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>display.display_type,</p>
<p>display.item display_item,</p>
<p>display.item_type display_item_type,</p>
<p>display.\`order\` display_order,</p>
<p>display.pos_id display_pos_id,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc lateral view explode(displays) tmp as display</p>
<p>where dt=’$do_date’</p>
<p>and displays is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_error_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>set hive.execution.engine=mr;</p>
<p>insert overwrite table ${APP}.dwd_traffic_error_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>entry,</p>
<p>loading_time,</p>
<p>open_ad_id,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) error_time,</p>
<p>error_code,</p>
<p>error_msg</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>\`start\`.entry,</p>
<p>\`start\`.loading_time,</p>
<p>\`start\`.open_ad_id,</p>
<p>\`start\`.open_ad_ms,</p>
<p>\`start\`.open_ad_skip_ms,</p>
<p>actions,</p>
<p>displays,</p>
<p>err.error_code,</p>
<p>err.msg error_msg,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and err is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>set hive.execution.engine=spark;</p>
<p>“</p>
<p>dwd_traffic_page_view_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_page_view_inc partition<br>(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>page_item,</p>
<p>page_item_type,</p>
<p>last_page_id,</p>
<p>page_id,</p>
<p>source_type,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) view_time,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over (partition by mid_id<br>order by ts)) session_id,</p>
<p>during_time</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>page.during_time,</p>
<p>page.item page_item,</p>
<p>page.item_type page_item_type,</p>
<p>page.last_page_id,</p>
<p>page.page_id,</p>
<p>page.source_type,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_traffic_start_inc=”</p>
<p>set hive.cbo.enable=false;</p>
<p>insert overwrite table ${APP}.dwd_traffic_start_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>brand,</p>
<p>channel,</p>
<p>is_new,</p>
<p>model,</p>
<p>mid_id,</p>
<p>operate_system,</p>
<p>user_id,</p>
<p>version_code,</p>
<p>entry,</p>
<p>open_ad_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) action_time,</p>
<p>loading_time,</p>
<p>open_ad_ms,</p>
<p>open_ad_skip_ms</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.is_new,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code,</p>
<p>\`start\`.entry,</p>
<p>\`start\`.loading_time,</p>
<p>\`start\`.open_ad_id,</p>
<p>\`start\`.open_ad_ms,</p>
<p>\`start\`.open_ad_skip_ms,</p>
<p>ts</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and \`start\` is not null</p>
<p>)log</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_user_login_inc=”</p>
<p>insert overwrite table ${APP}.dwd_user_login_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd’) date_id,</p>
<p>date_format(from_utc_timestamp(ts,’GMT+8’),’yyyy-MM-dd HH:mm:ss’) login_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>row_number() over (partition by session_id order by ts) rn</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>channel,</p>
<p>area_code,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>ts,</p>
<p>concat(mid_id,’-‘,last_value(session_start_point,true) over(partition by mid_id<br>order by ts)) session_id</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>common.uid user_id,</p>
<p>common.ch channel,</p>
<p>common.ar area_code,</p>
<p>common.vc version_code,</p>
<p>common.mid mid_id,</p>
<p>common.ba brand,</p>
<p>common.md model,</p>
<p>common.os operate_system,</p>
<p>ts,</p>
<p>if(page.last_page_id is null,ts,null) session_start_point</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page is not null</p>
<p>)t1</p>
<p>)t2</p>
<p>where user_id is not null</p>
<p>)t3</p>
<p>where rn=1</p>
<p>)t4</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on t4.area_code=bp.area_code;</p>
<p>“</p>
<p>dwd_user_register_inc=”</p>
<p>insert overwrite table ${APP}.dwd_user_register_inc partition(dt=’$do_date’)</p>
<p>select</p>
<p>ui.user_id,</p>
<p>date_format(create_time,’yyyy-MM-dd’) date_id,</p>
<p>create_time,</p>
<p>channel,</p>
<p>province_id,</p>
<p>version_code,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>data.id user_id,</p>
<p>data.create_time</p>
<p>from ${APP}.ods_user_info_inc</p>
<p>where dt=’$do_date’</p>
<p>and type=’insert’</p>
<p>)ui</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>common.ar area_code,</p>
<p>common.ba brand,</p>
<p>common.ch channel,</p>
<p>common.md model,</p>
<p>common.mid mid_id,</p>
<p>common.os operate_system,</p>
<p>common.uid user_id,</p>
<p>common.vc version_code</p>
<p>from ${APP}.ods_log_inc</p>
<p>where dt=’$do_date’</p>
<p>and page.page_id=’register’</p>
<p>and common.uid is not null</p>
<p>)log</p>
<p>on ui.user_id=log.user_id</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id province_id,</p>
<p>area_code</p>
<p>from ${APP}.ods_base_province_full</p>
<p>where dt=’$do_date’</p>
<p>)bp</p>
<p>on log.area_code=bp.area_code;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dwd_interaction_comment_inc” )</p>
<p>hive -e “$dwd_interaction_comment_inc”</p>
<p>;;</p>
<p>“dwd_interaction_favor_add_inc” )</p>
<p>hive -e “$dwd_interaction_favor_add_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_get_inc” )</p>
<p>hive -e “$dwd_tool_coupon_get_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_order_inc” )</p>
<p>hive -e “$dwd_tool_coupon_order_inc”</p>
<p>;;</p>
<p>“dwd_tool_coupon_pay_inc” )</p>
<p>hive -e “$dwd_tool_coupon_pay_inc”</p>
<p>;;</p>
<p>“dwd_trade_cancel_detail_inc” )</p>
<p>hive -e “$dwd_trade_cancel_detail_inc”</p>
<p>;;</p>
<p>“dwd_trade_cart_add_inc” )</p>
<p>hive -e “$dwd_trade_cart_add_inc”</p>
<p>;;</p>
<p>“dwd_trade_cart_full” )</p>
<p>hive -e “$dwd_trade_cart_full”</p>
<p>;;</p>
<p>“dwd_trade_order_detail_inc” )</p>
<p>hive -e “$dwd_trade_order_detail_inc”</p>
<p>;;</p>
<p>“dwd_trade_order_refund_inc” )</p>
<p>hive -e “$dwd_trade_order_refund_inc”</p>
<p>;;</p>
<p>“dwd_trade_pay_detail_suc_inc” )</p>
<p>hive -e “$dwd_trade_pay_detail_suc_inc”</p>
<p>;;</p>
<p>“dwd_trade_refund_pay_suc_inc” )</p>
<p>hive -e “$dwd_trade_refund_pay_suc_inc”</p>
<p>;;</p>
<p>“dwd_traffic_action_inc” )</p>
<p>hive -e “$dwd_traffic_action_inc”</p>
<p>;;</p>
<p>“dwd_traffic_display_inc” )</p>
<p>hive -e “$dwd_traffic_display_inc”</p>
<p>;;</p>
<p>“dwd_traffic_error_inc” )</p>
<p>hive -e “$dwd_traffic_error_inc”</p>
<p>;;</p>
<p>“dwd_traffic_page_view_inc” )</p>
<p>hive -e “$dwd_traffic_page_view_inc”</p>
<p>;;</p>
<p>“dwd_traffic_start_inc” )</p>
<p>hive -e “$dwd_traffic_start_inc”</p>
<p>;;</p>
<p>“dwd_user_login_inc” )</p>
<p>hive -e “$dwd_user_login_inc”</p>
<p>;;</p>
<p>“dwd_user_register_inc” )</p>
<p>hive -e “$dwd_user_register_inc”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dwd_interaction_comment_inc$dwd_interaction_favor_add_inc$dwd_tool_coupon_get_inc$dwd_tool_coupon_order_inc$dwd_tool_coupon_pay_inc$dwd_trade_cancel_detail_inc$dwd_trade_cart_add_inc$dwd_trade_cart_full$dwd_trade_order_detail_inc$dwd_trade_order_refund_inc$dwd_trade_pay_detail_suc_inc$dwd_trade_refund_pay_suc_inc$dwd_traffic_action_inc$dwd_traffic_display_inc$dwd_traffic_error_inc$dwd_traffic_page_view_inc$dwd_traffic_start_inc$dwd_user_login_inc$dwd_user_register_inc”</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x ods_to_dwd.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ ods_to_dwd.sh all 2020-06-14</p>
<h2 id="第10章-数仓开发之DWS层"><a href="#第10章-数仓开发之DWS层" class="headerlink" title="第10章 数仓开发之DWS层"></a>第10章 数仓开发之DWS层</h2><p>设计要点：</p>
<p>1）DWS层的设计参考指标体系。</p>
<p>2）DWS层的数据存储格式为orc列式存储+snappy压缩。</p>
<p>3）DWS层表名的命名规范为dws_数据域_统计粒度_业务过程_统计周期（1d/nd/td）</p>
<p>注：1d表示最近1日，nd表示最近n日，td表示历史至今。</p>
<h3 id="最近1日汇总表"><a href="#最近1日汇总表" class="headerlink" title="最近1日汇总表"></a>最近1日汇总表</h3><h4 id="交易域用户商品粒度订单最近1日汇总表"><a href="#交易域用户商品粒度订单最近1日汇总表" class="headerlink" title="交易域用户商品粒度订单最近1日汇总表"></a>交易域用户商品粒度订单最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_sku_order_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_sku_order_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`sku_name` STRING COMMENT ‘sku名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_count_1d` BIGINT COMMENT ‘最近1日下单次数’,</p>
<p>`order_num_1d` BIGINT COMMENT ‘最近1日下单件数’,</p>
<p>`order_original_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单原始金额’,</p>
<p>`activity_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日活动优惠金额’,</p>
<p>`coupon_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日优惠券优惠金额’,</p>
<p>`order_total_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单最终金额’</p>
<p>) COMMENT ‘交易域用户商品粒度订单最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_sku_order_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dws_trade_user_sku_order_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_count_1d,</p>
<p>order_num_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>dt,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_count_1d,</p>
<p>sum(sku_num) order_num_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0.0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0.0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d</p>
<p>from dwd_trade_order_detail_inc</p>
<p>group by dt,user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from dim_sku_full</p>
<p>where dt=’2020-06-14’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_sku_order_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_count,</p>
<p>order_num,</p>
<p>order_original_amount,</p>
<p>activity_reduce_amount,</p>
<p>coupon_reduce_amount,</p>
<p>order_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_count,</p>
<p>sum(sku_num) order_num,</p>
<p>sum(split_original_amount) order_original_amount,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount,</p>
<p>sum(split_total_amount) order_total_amount</p>
<p>from dwd_trade_order_detail_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from dim_sku_full</p>
<p>where dt=’2020-06-15’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<h4 id="交易域用户商品粒度退单最近1日汇总表"><a href="#交易域用户商品粒度退单最近1日汇总表" class="headerlink" title="交易域用户商品粒度退单最近1日汇总表"></a>交易域用户商品粒度退单最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_sku_order_refund_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_sku_order_refund_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`sku_name` STRING COMMENT ‘sku名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_refund_count_1d` BIGINT COMMENT ‘最近1日退单次数’,</p>
<p>`order_refund_num_1d` BIGINT COMMENT ‘最近1日退单件数’,</p>
<p>`order_refund_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日退单金额’</p>
<p>) COMMENT ‘交易域用户商品粒度退单最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_sku_order_refund_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dws_trade_user_sku_order_refund_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_refund_count,</p>
<p>order_refund_num,</p>
<p>order_refund_amount,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>dt,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount</p>
<p>from dwd_trade_order_refund_inc</p>
<p>group by dt,user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from dim_sku_full</p>
<p>where dt=’2020-06-14’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_sku_order_refund_1d<br>partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_refund_count,</p>
<p>order_refund_num,</p>
<p>order_refund_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount</p>
<p>from dwd_trade_order_refund_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from dim_sku_full</p>
<p>where dt=’2020-06-15’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<h4 id="交易域用户粒度订单最近1日汇总表"><a href="#交易域用户粒度订单最近1日汇总表" class="headerlink" title="交易域用户粒度订单最近1日汇总表"></a>交易域用户粒度订单最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_order_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_order_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`order_count_1d` BIGINT COMMENT ‘最近1日下单次数’,</p>
<p>`order_num_1d` BIGINT COMMENT ‘最近1日下单商品件数’,</p>
<p>`order_original_amount_1d` DECIMAL(16, 2) COMMENT<br>‘最近1日最近1日下单原始金额’,</p>
<p>`activity_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘下单优惠券优惠金额’,</p>
<p>`order_total_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单最终金额’</p>
<p>) COMMENT ‘交易域用户粒度订单最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_order_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_trade_user_order_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_original_amount),</p>
<p>sum(nvl(split_activity_amount,0)),</p>
<p>sum(nvl(split_coupon_amount,0)),</p>
<p>sum(split_total_amount),</p>
<p>dt</p>
<p>from dwd_trade_order_detail_inc</p>
<p>group by user_id,dt;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_order_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_original_amount),</p>
<p>sum(nvl(split_activity_amount,0)),</p>
<p>sum(nvl(split_coupon_amount,0)),</p>
<p>sum(split_total_amount)</p>
<p>from dwd_trade_order_detail_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id;</p>
<h4 id="交易域用户粒度加购最近1日汇总表"><a href="#交易域用户粒度加购最近1日汇总表" class="headerlink" title="交易域用户粒度加购最近1日汇总表"></a>交易域用户粒度加购最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_cart_add_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_cart_add_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`cart_add_count_1d` BIGINT COMMENT ‘最近1日加购次数’,</p>
<p>`cart_add_num_1d` BIGINT COMMENT ‘最近1日加购商品件数’</p>
<p>) COMMENT ‘交易域用户粒度加购最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_cart_add_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_trade_user_cart_add_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(sku_num),</p>
<p>dt</p>
<p>from dwd_trade_cart_add_inc</p>
<p>group by user_id,dt;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_cart_add_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(sku_num)</p>
<p>from dwd_trade_cart_add_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id;</p>
<h4 id="交易域用户粒度支付最近1日汇总表"><a href="#交易域用户粒度支付最近1日汇总表" class="headerlink" title="交易域用户粒度支付最近1日汇总表"></a>交易域用户粒度支付最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_payment_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_payment_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`payment_count_1d` BIGINT COMMENT ‘最近1日支付次数’,</p>
<p>`payment_num_1d` BIGINT COMMENT ‘最近1日支付商品件数’,</p>
<p>`payment_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日支付金额’</p>
<p>) COMMENT ‘交易域用户粒度支付最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_payment_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_trade_user_payment_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_payment_amount),</p>
<p>dt</p>
<p>from dwd_trade_pay_detail_suc_inc</p>
<p>group by user_id,dt;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_payment_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_payment_amount)</p>
<p>from dwd_trade_pay_detail_suc_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id;</p>
<h4 id="交易域省份粒度订单最近1日汇总表"><a href="#交易域省份粒度订单最近1日汇总表" class="headerlink" title="交易域省份粒度订单最近1日汇总表"></a>交易域省份粒度订单最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_province_order_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_province_order_1d</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘用户id’,</p>
<p>`province_name` STRING COMMENT ‘省份名称’,</p>
<p>`area_code` STRING COMMENT ‘地区编码’,</p>
<p>`iso_code` STRING COMMENT ‘旧版ISO-3166-2编码’,</p>
<p>`iso_3166_2` STRING COMMENT ‘新版版ISO-3166-2编码’,</p>
<p>`order_count_1d` BIGINT COMMENT ‘最近1日下单次数’,</p>
<p>`order_original_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单原始金额’,</p>
<p>`activity_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单优惠券优惠金额’,</p>
<p>`order_total_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日下单最终金额’</p>
<p>) COMMENT ‘交易域省份粒度订单最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_province_order_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dws_trade_province_order_1d partition(dt)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>province_id,</p>
<p>count(distinct(order_id)) order_count_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d,</p>
<p>dt</p>
<p>from dwd_trade_order_detail_inc</p>
<p>group by province_id,dt</p>
<p>)o</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from dim_province_full</p>
<p>where dt=’2020-06-14’</p>
<p>)p</p>
<p>on o.province_id=p.id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_province_order_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>province_id,</p>
<p>count(distinct(order_id)) order_count_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d</p>
<p>from dwd_trade_order_detail_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by province_id</p>
<p>)o</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from dim_province_full</p>
<p>where dt=’2020-06-15’</p>
<p>)p</p>
<p>on o.province_id=p.id;</p>
<h4 id="交易域用户粒度退单最近1日汇总表"><a href="#交易域用户粒度退单最近1日汇总表" class="headerlink" title="交易域用户粒度退单最近1日汇总表"></a>交易域用户粒度退单最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_order_refund_1d;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_order_refund_1d</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`order_refund_count_1d` BIGINT COMMENT ‘最近1日退单次数’,</p>
<p>`order_refund_num_1d` BIGINT COMMENT ‘最近1日退单商品件数’,</p>
<p>`order_refund_amount_1d` DECIMAL(16, 2) COMMENT ‘最近1日退单金额’</p>
<p>) COMMENT ‘交易域用户粒度退单最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_order_refund_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>set hive.exec.dynamic.partition.mode=nonstrict;</p>
<p>insert overwrite table dws_trade_user_order_refund_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount,</p>
<p>dt</p>
<p>from dwd_trade_order_refund_inc</p>
<p>group by user_id,dt;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_order_refund_1d partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(refund_num),</p>
<p>sum(refund_amount)</p>
<p>from dwd_trade_order_refund_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id;</p>
<h4 id="流量域会话粒度页面浏览最近1日汇总表"><a href="#流量域会话粒度页面浏览最近1日汇总表" class="headerlink" title="流量域会话粒度页面浏览最近1日汇总表"></a>流量域会话粒度页面浏览最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_traffic_session_page_view_1d;</p>
<p>CREATE EXTERNAL TABLE dws_traffic_session_page_view_1d</p>
<p>(</p>
<p>`session_id` STRING COMMENT ‘会话id’,</p>
<p>`mid_id` string comment ‘设备id’,</p>
<p>`brand` string comment ‘手机品牌’,</p>
<p>`model` string comment ‘手机型号’,</p>
<p>`operate_system` string comment ‘操作系统’,</p>
<p>`version_code` string comment ‘app版本号’,</p>
<p>`channel` string comment ‘渠道’,</p>
<p>`during_time_1d` BIGINT COMMENT ‘最近1日访问时长’,</p>
<p>`page_count_1d` BIGINT COMMENT ‘最近1日访问页面数’</p>
<p>) COMMENT ‘流量域会话粒度页面浏览最近1日汇总表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_traffic_session_page_view_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_traffic_session_page_view_1d<br>partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>session_id,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>version_code,</p>
<p>channel,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from dwd_traffic_page_view_inc</p>
<p>where dt=’2020-06-14’</p>
<p>group by session_id,mid_id,brand,model,operate_system,version_code,channel;</p>
<h4 id="流量域访客页面粒度页面浏览最近1日汇总表"><a href="#流量域访客页面粒度页面浏览最近1日汇总表" class="headerlink" title="流量域访客页面粒度页面浏览最近1日汇总表"></a>流量域访客页面粒度页面浏览最近1日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_traffic_page_visitor_page_view_1d;</p>
<p>CREATE EXTERNAL TABLE dws_traffic_page_visitor_page_view_1d</p>
<p>(</p>
<p>`mid_id` STRING COMMENT ‘访客id’,</p>
<p>`brand` string comment ‘手机品牌’,</p>
<p>`model` string comment ‘手机型号’,</p>
<p>`operate_system` string comment ‘操作系统’,</p>
<p>`page_id` STRING COMMENT ‘页面id’,</p>
<p>`during_time_1d` BIGINT COMMENT ‘最近1日浏览时长’,</p>
<p>`view_count_1d` BIGINT COMMENT ‘最近1日访问次数’</p>
<p>) COMMENT ‘流量域访客页面粒度页面浏览最近1日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_traffic_page_visitor_page_view_1d’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_traffic_page_visitor_page_view_1d<br>partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>page_id,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from dwd_traffic_page_view_inc</p>
<p>where dt=’2020-06-14’</p>
<p>group by mid_id,brand,model,operate_system,page_id;</p>
<h4 id="数据装载脚本-3"><a href="#数据装载脚本-3" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h4><p><strong>1）首日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dwd_to_dws_1d_init.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dwd_to_dws_1d_init.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>echo “请传入日期参数”</p>
<p>exit</p>
<p>fi</p>
<p>dws_trade_province_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_province_order_1d partition(dt)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>province_id,</p>
<p>count(distinct(order_id)) order_count_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d,</p>
<p>dt</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>group by province_id,dt</p>
<p>)o</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from ${APP}.dim_province_full</p>
<p>where dt=’$do_date’</p>
<p>)p</p>
<p>on o.province_id=p.id;</p>
<p>“</p>
<p>dws_trade_user_cart_add_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_cart_add_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(sku_num),</p>
<p>dt</p>
<p>from ${APP}.dwd_trade_cart_add_inc</p>
<p>group by user_id,dt;</p>
<p>“</p>
<p>dws_trade_user_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_original_amount),</p>
<p>sum(nvl(split_activity_amount,0)),</p>
<p>sum(nvl(split_coupon_amount,0)),</p>
<p>sum(split_total_amount),</p>
<p>dt</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>group by user_id,dt;</p>
<p>“</p>
<p>dws_trade_user_order_refund_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_refund_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount,</p>
<p>dt</p>
<p>from ${APP}.dwd_trade_order_refund_inc</p>
<p>group by user_id,dt;</p>
<p>“</p>
<p>dws_trade_user_payment_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_payment_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_payment_amount),</p>
<p>dt</p>
<p>from ${APP}.dwd_trade_pay_detail_suc_inc</p>
<p>group by user_id,dt;</p>
<p>“</p>
<p>dws_trade_user_sku_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_count_1d,</p>
<p>order_num_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>dt,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_count_1d,</p>
<p>sum(sku_num) order_num_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0.0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0.0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>group by dt,user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from ${APP}.dim_sku_full</p>
<p>where dt=’$do_date’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p>“</p>
<p>dws_trade_user_sku_order_refund_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_refund_1d partition(dt)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_refund_count,</p>
<p>order_refund_num,</p>
<p>order_refund_amount,</p>
<p>dt</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>dt,</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount</p>
<p>from ${APP}.dwd_trade_order_refund_inc</p>
<p>group by dt,user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from ${APP}.dim_sku_full</p>
<p>where dt=’$do_date’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p>“</p>
<p>dws_traffic_page_visitor_page_view_1d=”</p>
<p>insert overwrite table ${APP}.dws_traffic_page_visitor_page_view_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>page_id,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from ${APP}.dwd_traffic_page_view_inc</p>
<p>where dt=’$do_date’</p>
<p>group by mid_id,brand,model,operate_system,page_id;</p>
<p>“</p>
<p>dws_traffic_session_page_view_1d=”</p>
<p>insert overwrite table ${APP}.dws_traffic_session_page_view_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>session_id,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>version_code,</p>
<p>channel,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from ${APP}.dwd_traffic_page_view_inc</p>
<p>where dt=’$do_date’</p>
<p>group by session_id,mid_id,brand,model,operate_system,version_code,channel;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dws_trade_province_order_1d” )</p>
<p>hive -e “$dws_trade_province_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_cart_add_1d” )</p>
<p>hive -e “$dws_trade_user_cart_add_1d”</p>
<p>;;</p>
<p>“dws_trade_user_order_1d” )</p>
<p>hive -e “$dws_trade_user_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_order_refund_1d” )</p>
<p>hive -e “$dws_trade_user_order_refund_1d”</p>
<p>;;</p>
<p>“dws_trade_user_payment_1d” )</p>
<p>hive -e “$dws_trade_user_payment_1d”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_1d” )</p>
<p>hive -e “$dws_trade_user_sku_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_refund_1d” )</p>
<p>hive -e “$dws_trade_user_sku_order_refund_1d”</p>
<p>;;</p>
<p>“dws_traffic_page_visitor_page_view_1d” )</p>
<p>hive -e “$dws_traffic_page_visitor_page_view_1d”</p>
<p>;;</p>
<p>“dws_traffic_session_page_view_1d” )</p>
<p>hive -e “$dws_traffic_session_page_view_1d”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dws_trade_province_order_1d$dws_trade_user_cart_add_1d$dws_trade_user_order_1d$dws_trade_user_order_refund_1d$dws_trade_user_payment_1d$dws_trade_user_sku_order_1d$dws_trade_user_sku_order_refund_1d$dws_traffic_page_visitor_page_view_1d$dws_traffic_session_page_view_1d”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dwd_to_dws_1d_init.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dwd_to_dws_1d_init.sh all 2020-06-14</p>
<p><strong>2）每日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dwd_to_dws_1d.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dwd_to_dws_1d.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>dws_trade_province_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_province_order_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>province_id,</p>
<p>count(distinct(order_id)) order_count_1d,</p>
<p>sum(split_original_amount) order_original_amount_1d,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount_1d,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount_1d,</p>
<p>sum(split_total_amount) order_total_amount_1d</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>where dt=’$do_date’</p>
<p>group by province_id</p>
<p>)o</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2</p>
<p>from ${APP}.dim_province_full</p>
<p>where dt=’$do_date’</p>
<p>)p</p>
<p>on o.province_id=p.id;</p>
<p>“</p>
<p>dws_trade_user_cart_add_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_cart_add_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(sku_num)</p>
<p>from ${APP}.dwd_trade_cart_add_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_1d partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_original_amount),</p>
<p>sum(nvl(split_activity_amount,0)),</p>
<p>sum(nvl(split_coupon_amount,0)),</p>
<p>sum(split_total_amount)</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_order_refund_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_refund_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(*),</p>
<p>sum(refund_num),</p>
<p>sum(refund_amount)</p>
<p>from ${APP}.dwd_trade_order_refund_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_payment_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_payment_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>count(distinct(order_id)),</p>
<p>sum(sku_num),</p>
<p>sum(split_payment_amount)</p>
<p>from ${APP}.dwd_trade_pay_detail_suc_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_sku_order_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_count,</p>
<p>order_num,</p>
<p>order_original_amount,</p>
<p>activity_reduce_amount,</p>
<p>coupon_reduce_amount,</p>
<p>order_total_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_count,</p>
<p>sum(sku_num) order_num,</p>
<p>sum(split_original_amount) order_original_amount,</p>
<p>sum(nvl(split_activity_amount,0)) activity_reduce_amount,</p>
<p>sum(nvl(split_coupon_amount,0)) coupon_reduce_amount,</p>
<p>sum(split_total_amount) order_total_amount</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from ${APP}.dim_sku_full</p>
<p>where dt=’$do_date’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p>“</p>
<p>dws_trade_user_sku_order_refund_1d=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_refund_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>order_refund_count,</p>
<p>order_refund_num,</p>
<p>order_refund_amount</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>count(*) order_refund_count,</p>
<p>sum(refund_num) order_refund_num,</p>
<p>sum(refund_amount) order_refund_amount</p>
<p>from ${APP}.dwd_trade_order_refund_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id,sku_id</p>
<p>)od</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name</p>
<p>from ${APP}.dim_sku_full</p>
<p>where dt=’$do_date’</p>
<p>)sku</p>
<p>on od.sku_id=sku.id;</p>
<p>“</p>
<p>dws_traffic_page_visitor_page_view_1d=”</p>
<p>insert overwrite table ${APP}.dws_traffic_page_visitor_page_view_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>page_id,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from ${APP}.dwd_traffic_page_view_inc</p>
<p>where dt=’$do_date’</p>
<p>group by mid_id,brand,model,operate_system,page_id;</p>
<p>“</p>
<p>dws_traffic_session_page_view_1d=”</p>
<p>insert overwrite table ${APP}.dws_traffic_session_page_view_1d<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>session_id,</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>version_code,</p>
<p>channel,</p>
<p>sum(during_time),</p>
<p>count(*)</p>
<p>from ${APP}.dwd_traffic_page_view_inc</p>
<p>where dt=’$do_date’</p>
<p>group by session_id,mid_id,brand,model,operate_system,version_code,channel;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dws_trade_province_order_1d” )</p>
<p>hive -e “$dws_trade_province_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_cart_add_1d” )</p>
<p>hive -e “$dws_trade_user_cart_add_1d”</p>
<p>;;</p>
<p>“dws_trade_user_order_1d” )</p>
<p>hive -e “$dws_trade_user_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_order_refund_1d” )</p>
<p>hive -e “$dws_trade_user_order_refund_1d”</p>
<p>;;</p>
<p>“dws_trade_user_payment_1d” )</p>
<p>hive -e “$dws_trade_user_payment_1d”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_1d” )</p>
<p>hive -e “$dws_trade_user_sku_order_1d”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_refund_1d” )</p>
<p>hive -e “$dws_trade_user_sku_order_refund_1d”</p>
<p>;;</p>
<p>“dws_traffic_page_visitor_page_view_1d” )</p>
<p>hive -e “$dws_traffic_page_visitor_page_view_1d”</p>
<p>;;</p>
<p>“dws_traffic_session_page_view_1d” )</p>
<p>hive -e “$dws_traffic_session_page_view_1d”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dws_trade_province_order_1d$dws_trade_user_cart_add_1d$dws_trade_user_order_1d$dws_trade_user_order_refund_1d$dws_trade_user_payment_1d$dws_trade_user_sku_order_1d$dws_trade_user_sku_order_refund_1d$dws_traffic_page_visitor_page_view_1d$dws_traffic_session_page_view_1d”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dwd_to_dws_1d.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dwd_to_dws_1d.sh all 2020-06-14</p>
<h3 id="最近n日汇总表"><a href="#最近n日汇总表" class="headerlink" title="最近n日汇总表"></a>最近n日汇总表</h3><h4 id="交易域用户商品粒度订单最近n日汇总表"><a href="#交易域用户商品粒度订单最近n日汇总表" class="headerlink" title="交易域用户商品粒度订单最近n日汇总表"></a>交易域用户商品粒度订单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_sku_order_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_sku_order_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`sku_name` STRING COMMENT ‘sku名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_count_7d` STRING COMMENT ‘最近7日下单次数’,</p>
<p>`order_num_7d` BIGINT COMMENT ‘最近7日下单件数’,</p>
<p>`order_original_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单原始金额’,</p>
<p>`activity_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日活动优惠金额’,</p>
<p>`coupon_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日优惠券优惠金额’,</p>
<p>`order_total_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单最终金额’,</p>
<p>`order_count_30d` BIGINT COMMENT ‘最近30日下单次数’,</p>
<p>`order_num_30d` BIGINT COMMENT ‘最近30日下单件数’,</p>
<p>`order_original_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单原始金额’,</p>
<p>`activity_reduce_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日活动优惠金额’,</p>
<p>`coupon_reduce_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日优惠券优惠金额’,</p>
<p>`order_total_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单最终金额’</p>
<p>) COMMENT ‘交易域用户商品粒度订单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_sku_order_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_sku_order_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_num_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from dws_trade_user_sku_order_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>group by<br>user_id,sku_id,sku_name,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name,tm_id,tm_name;</p>
<h4 id="交易域用户商品粒度退单最近n日汇总表"><a href="#交易域用户商品粒度退单最近n日汇总表" class="headerlink" title="交易域用户商品粒度退单最近n日汇总表"></a>交易域用户商品粒度退单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_sku_order_refund_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_sku_order_refund_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`sku_id` STRING COMMENT ‘sku_id’,</p>
<p>`sku_name` STRING COMMENT ‘sku名称’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`tm_id` STRING COMMENT ‘品牌id’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_refund_count_7d` BIGINT COMMENT ‘最近7日退单次数’,</p>
<p>`order_refund_num_7d` BIGINT COMMENT ‘最近7日退单件数’,</p>
<p>`order_refund_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日退单金额’,</p>
<p>`order_refund_count_30d` BIGINT COMMENT ‘最近30日退单次数’,</p>
<p>`order_refund_num_30d` BIGINT COMMENT ‘最近30日退单件数’,</p>
<p>`order_refund_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日退单金额’</p>
<p>) COMMENT ‘交易域用户商品粒度退单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_sku_order_refund_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_sku_order_refund_nd<br>partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_amount_1d,0)),</p>
<p>sum(order_refund_count_1d),</p>
<p>sum(order_refund_num_1d),</p>
<p>sum(order_refund_amount_1d)</p>
<p>from dws_trade_user_sku_order_refund_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by<br>user_id,sku_id,sku_name,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name,tm_id,tm_name;</p>
<h4 id="交易域用户粒度订单最近n日汇总表"><a href="#交易域用户粒度订单最近n日汇总表" class="headerlink" title="交易域用户粒度订单最近n日汇总表"></a>交易域用户粒度订单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_order_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_order_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`order_count_7d` BIGINT COMMENT ‘最近7日下单次数’,</p>
<p>`order_num_7d` BIGINT COMMENT ‘最近7日下单商品件数’,</p>
<p>`order_original_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单原始金额’,</p>
<p>`activity_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单优惠券优惠金额’,</p>
<p>`order_total_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单最终金额’,</p>
<p>`order_count_30d` BIGINT COMMENT ‘最近30日下单次数’,</p>
<p>`order_num_30d` BIGINT COMMENT ‘最近30日下单商品件数’,</p>
<p>`order_original_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单原始金额’,</p>
<p>`activity_reduce_amount_30d` DECIMAL(16, 2) COMMENT<br>‘最近30日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_30d` DECIMAL(16, 2) COMMENT<br>‘最近30日下单优惠券优惠金额’,</p>
<p>`order_total_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单最终金额’</p>
<p>) COMMENT ‘交易域用户粒度订单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_order_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_order_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_num_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from dws_trade_user_order_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by user_id;</p>
<h4 id="交易域用户粒度加购最近n日汇总表"><a href="#交易域用户粒度加购最近n日汇总表" class="headerlink" title="交易域用户粒度加购最近n日汇总表"></a>交易域用户粒度加购最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_cart_add_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_cart_add_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`cart_add_count_7d` BIGINT COMMENT ‘最近7日加购次数’,</p>
<p>`cart_add_num_7d` BIGINT COMMENT ‘最近7日加购商品件数’,</p>
<p>`cart_add_count_30d` BIGINT COMMENT ‘最近30日加购次数’,</p>
<p>`cart_add_num_30d` BIGINT COMMENT ‘最近30日加购商品件数’</p>
<p>) COMMENT ‘交易域用户粒度加购最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_cart_add_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_cart_add_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),cart_add_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),cart_add_num_1d,0)),</p>
<p>sum(cart_add_count_1d),</p>
<p>sum(cart_add_num_1d)</p>
<p>from dws_trade_user_cart_add_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by user_id;</p>
<h4 id="交易域用户粒度支付最近n日汇总表"><a href="#交易域用户粒度支付最近n日汇总表" class="headerlink" title="交易域用户粒度支付最近n日汇总表"></a>交易域用户粒度支付最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_payment_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_payment_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`payment_count_7d` BIGINT COMMENT ‘最近7日支付次数’,</p>
<p>`payment_num_7d` BIGINT COMMENT ‘最近7日支付商品件数’,</p>
<p>`payment_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日支付金额’,</p>
<p>`payment_count_30d` BIGINT COMMENT ‘最近30日支付次数’,</p>
<p>`payment_num_30d` BIGINT COMMENT ‘最近30日支付商品件数’,</p>
<p>`payment_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日支付金额’</p>
<p>) COMMENT ‘交易域用户粒度支付最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_payment_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_payment_nd partition (dt = ‘2020-06-14’)</p>
<p>select user_id,</p>
<p>sum(if(dt &gt;= date_add(‘2020-06-14’, -6), payment_count_1d, 0)),</p>
<p>sum(if(dt &gt;= date_add(‘2020-06-14’, -6), payment_num_1d, 0)),</p>
<p>sum(if(dt &gt;= date_add(‘2020-06-14’, -6), payment_amount_1d, 0)),</p>
<p>sum(payment_count_1d),</p>
<p>sum(payment_num_1d),</p>
<p>sum(payment_amount_1d)</p>
<p>from dws_trade_user_payment_1d</p>
<p>where dt &gt;= date_add(‘2020-06-14’, -29)</p>
<p>and dt &lt;= ‘2020-06-14’</p>
<p>group by user_id;</p>
<h4 id="交易域省份粒度订单最近n日汇总表"><a href="#交易域省份粒度订单最近n日汇总表" class="headerlink" title="交易域省份粒度订单最近n日汇总表"></a>交易域省份粒度订单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_province_order_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_province_order_nd</p>
<p>(</p>
<p>`province_id` STRING COMMENT ‘用户id’,</p>
<p>`province_name` STRING COMMENT ‘省份名称’,</p>
<p>`area_code` STRING COMMENT ‘地区编码’,</p>
<p>`iso_code` STRING COMMENT ‘旧版ISO-3166-2编码’,</p>
<p>`iso_3166_2` STRING COMMENT ‘新版版ISO-3166-2编码’,</p>
<p>`order_count_7d` BIGINT COMMENT ‘最近7日下单次数’,</p>
<p>`order_original_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单原始金额’,</p>
<p>`activity_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单优惠券优惠金额’,</p>
<p>`order_total_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日下单最终金额’,</p>
<p>`order_count_30d` BIGINT COMMENT ‘最近30日下单次数’,</p>
<p>`order_original_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单原始金额’,</p>
<p>`activity_reduce_amount_30d` DECIMAL(16, 2) COMMENT<br>‘最近30日下单活动优惠金额’,</p>
<p>`coupon_reduce_amount_30d` DECIMAL(16, 2) COMMENT<br>‘最近30日下单优惠券优惠金额’,</p>
<p>`order_total_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日下单最终金额’</p>
<p>) COMMENT ‘交易域省份粒度订单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_province_order_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_province_order_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from dws_trade_province_order_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by province_id,province_name,area_code,iso_code,iso_3166_2;</p>
<h4 id="交易域优惠券粒度订单最近n日汇总表"><a href="#交易域优惠券粒度订单最近n日汇总表" class="headerlink" title="交易域优惠券粒度订单最近n日汇总表"></a>交易域优惠券粒度订单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_coupon_order_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_coupon_order_nd</p>
<p>(</p>
<p>`coupon_id` STRING COMMENT ‘优惠券id’,</p>
<p>`coupon_name` STRING COMMENT ‘优惠券名称’,</p>
<p>`coupon_type_code` STRING COMMENT ‘优惠券类型id’,</p>
<p>`coupon_type_name` STRING COMMENT ‘优惠券类型名称’,</p>
<p>`coupon_rule` STRING COMMENT ‘优惠券规则’,</p>
<p>`start_date` STRING COMMENT ‘发布日期’,</p>
<p>`original_amount_30d` DECIMAL(16, 2) COMMENT ‘使用下单原始金额’,</p>
<p>`coupon_reduce_amount_30d` DECIMAL(16, 2) COMMENT ‘使用下单优惠金额’</p>
<p>) COMMENT ‘交易域优惠券粒度订单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_coupon_order_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_coupon_order_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type_code,</p>
<p>coupon_type_name,</p>
<p>benefit_rule,</p>
<p>start_date,</p>
<p>sum(split_original_amount),</p>
<p>sum(split_coupon_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type_code,</p>
<p>coupon_type_name,</p>
<p>benefit_rule,</p>
<p>date_format(start_time,’yyyy-MM-dd’) start_date</p>
<p>from dim_coupon_full</p>
<p>where dt=’2020-06-14’</p>
<p>and date_format(start_time,’yyyy-MM-dd’)&gt;=date_add(‘2020-06-14’,-29)</p>
<p>)cou</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>coupon_id,</p>
<p>order_id,</p>
<p>split_original_amount,</p>
<p>split_coupon_amount</p>
<p>from dwd_trade_order_detail_inc</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>and coupon_id is not null</p>
<p>)od</p>
<p>on cou.id=od.coupon_id</p>
<p>group by<br>id,coupon_name,coupon_type_code,coupon_type_name,benefit_rule,start_date;</p>
<h4 id="交易域活动粒度订单最近n日汇总表"><a href="#交易域活动粒度订单最近n日汇总表" class="headerlink" title="交易域活动粒度订单最近n日汇总表"></a>交易域活动粒度订单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_activity_order_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_activity_order_nd</p>
<p>(</p>
<p>`activity_id` STRING COMMENT ‘活动id’,</p>
<p>`activity_name` STRING COMMENT ‘活动名称’,</p>
<p>`activity_type_code` STRING COMMENT ‘活动类型编码’,</p>
<p>`activity_type_name` STRING COMMENT ‘活动类型名称’,</p>
<p>`start_date` STRING COMMENT ‘发布日期’,</p>
<p>`original_amount_30d` DECIMAL(16, 2) COMMENT ‘参与活动订单原始金额’,</p>
<p>`activity_reduce_amount_30d` DECIMAL(16, 2) COMMENT ‘参与活动订单优惠金额’</p>
<p>) COMMENT ‘交易域活动粒度订单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_activity_order_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_activity_order_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>act.activity_id,</p>
<p>activity_name,</p>
<p>activity_type_code,</p>
<p>activity_type_name,</p>
<p>date_format(start_time,’yyyy-MM-dd’),</p>
<p>sum(split_original_amount),</p>
<p>sum(split_activity_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>activity_id,</p>
<p>activity_name,</p>
<p>activity_type_code,</p>
<p>activity_type_name,</p>
<p>start_time</p>
<p>from dim_activity_full</p>
<p>where dt=’2020-06-14’</p>
<p>and date_format(start_time,’yyyy-MM-dd’)&gt;=date_add(‘2020-06-14’,-29)</p>
<p>group by activity_id, activity_name, activity_type_code,<br>activity_type_name,start_time</p>
<p>)act</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>activity_id,</p>
<p>order_id,</p>
<p>split_original_amount,</p>
<p>split_activity_amount</p>
<p>from dwd_trade_order_detail_inc</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>and activity_id is not null</p>
<p>)od</p>
<p>on act.activity_id=od.activity_id</p>
<p>group by<br>act.activity_id,activity_name,activity_type_code,activity_type_name,start_time;</p>
<h4 id="交易域用户粒度退单最近n日汇总表"><a href="#交易域用户粒度退单最近n日汇总表" class="headerlink" title="交易域用户粒度退单最近n日汇总表"></a>交易域用户粒度退单最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_order_refund_nd;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_order_refund_nd</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`order_refund_count_7d` BIGINT COMMENT ‘最近7日退单次数’,</p>
<p>`order_refund_num_7d` BIGINT COMMENT ‘最近7日退单商品件数’,</p>
<p>`order_refund_amount_7d` DECIMAL(16, 2) COMMENT ‘最近7日退单金额’,</p>
<p>`order_refund_count_30d` BIGINT COMMENT ‘最近30日退单次数’,</p>
<p>`order_refund_num_30d` BIGINT COMMENT ‘最近30日退单商品件数’,</p>
<p>`order_refund_amount_30d` DECIMAL(16, 2) COMMENT ‘最近30日退单金额’</p>
<p>) COMMENT ‘交易域用户粒度退单最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_order_refund_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_trade_user_order_refund_nd partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),order_refund_amount_1d,0)),</p>
<p>sum(order_refund_count_1d),</p>
<p>sum(order_refund_num_1d),</p>
<p>sum(order_refund_amount_1d)</p>
<p>from dws_trade_user_order_refund_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by user_id;</p>
<h4 id="流量域访客页面粒度页面浏览最近n日汇总表"><a href="#流量域访客页面粒度页面浏览最近n日汇总表" class="headerlink" title="流量域访客页面粒度页面浏览最近n日汇总表"></a>流量域访客页面粒度页面浏览最近n日汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_traffic_page_visitor_page_view_nd;</p>
<p>CREATE EXTERNAL TABLE dws_traffic_page_visitor_page_view_nd</p>
<p>(</p>
<p>`mid_id` STRING COMMENT ‘访客id’,</p>
<p>`brand` string comment ‘手机品牌’,</p>
<p>`model` string comment ‘手机型号’,</p>
<p>`operate_system` string comment ‘操作系统’,</p>
<p>`page_id` STRING COMMENT ‘页面id’,</p>
<p>`during_time_7d` BIGINT COMMENT ‘最近7日浏览时长’,</p>
<p>`view_count_7d` BIGINT COMMENT ‘最近7日访问次数’,</p>
<p>`during_time_30d` BIGINT COMMENT ‘最近30日浏览时长’,</p>
<p>`view_count_30d` BIGINT COMMENT ‘最近30日访问次数’</p>
<p>) COMMENT ‘流量域访客页面粒度页面浏览最近n日汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_traffic_page_visitor_page_view_nd’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table dws_traffic_page_visitor_page_view_nd<br>partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>page_id,</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),during_time_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘2020-06-14’,-6),view_count_1d,0)),</p>
<p>sum(during_time_1d),</p>
<p>sum(view_count_1d)</p>
<p>from dws_traffic_page_visitor_page_view_1d</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-29)</p>
<p>and dt&lt;=’2020-06-14’</p>
<p>group by mid_id,brand,model,operate_system,page_id;</p>
<h4 id="数据装载脚本-4"><a href="#数据装载脚本-4" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h4><p><strong>1）每日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dws_1d_to_dws_nd.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dws_1d_to_dws_nd.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>dws_trade_activity_order_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_activity_order_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>act.activity_id,</p>
<p>activity_name,</p>
<p>activity_type_code,</p>
<p>activity_type_name,</p>
<p>date_format(start_time,’yyyy-MM-dd’),</p>
<p>sum(split_original_amount),</p>
<p>sum(split_activity_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>activity_id,</p>
<p>activity_name,</p>
<p>activity_type_code,</p>
<p>activity_type_name,</p>
<p>start_time</p>
<p>from ${APP}.dim_activity_full</p>
<p>where dt=’$do_date’</p>
<p>and date_format(start_time,’yyyy-MM-dd’)&gt;=date_add(‘$do_date’,-29)</p>
<p>group by activity_id, activity_name, activity_type_code,<br>activity_type_name,start_time</p>
<p>)act</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>activity_id,</p>
<p>order_id,</p>
<p>split_original_amount,</p>
<p>split_activity_amount</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>and activity_id is not null</p>
<p>)od</p>
<p>on act.activity_id=od.activity_id</p>
<p>group by<br>act.activity_id,activity_name,activity_type_code,activity_type_name,start_time;</p>
<p>“</p>
<p>dws_trade_coupon_order_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_coupon_order_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type_code,</p>
<p>coupon_type_name,</p>
<p>benefit_rule,</p>
<p>start_date,</p>
<p>sum(split_original_amount),</p>
<p>sum(split_coupon_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>coupon_name,</p>
<p>coupon_type_code,</p>
<p>coupon_type_name,</p>
<p>benefit_rule,</p>
<p>date_format(start_time,’yyyy-MM-dd’) start_date</p>
<p>from ${APP}.dim_coupon_full</p>
<p>where dt=’$do_date’</p>
<p>and date_format(start_time,’yyyy-MM-dd’)&gt;=date_add(‘$do_date’,-29)</p>
<p>)cou</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>coupon_id,</p>
<p>order_id,</p>
<p>split_original_amount,</p>
<p>split_coupon_amount</p>
<p>from ${APP}.dwd_trade_order_detail_inc</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>and coupon_id is not null</p>
<p>)od</p>
<p>on cou.id=od.coupon_id</p>
<p>group by<br>id,coupon_name,coupon_type_code,coupon_type_name,benefit_rule,start_date;</p>
<p>“</p>
<p>dws_trade_province_order_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_province_order_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from ${APP}.dws_trade_province_order_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by province_id,province_name,area_code,iso_code,iso_3166_2;</p>
<p>“</p>
<p>dws_trade_user_cart_add_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_cart_add_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),cart_add_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),cart_add_num_1d,0)),</p>
<p>sum(cart_add_count_1d),</p>
<p>sum(cart_add_num_1d)</p>
<p>from ${APP}.dws_trade_user_cart_add_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_order_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_nd partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_num_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from ${APP}.dws_trade_user_order_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_order_refund_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_refund_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_amount_1d,0)),</p>
<p>sum(order_refund_count_1d),</p>
<p>sum(order_refund_num_1d),</p>
<p>sum(order_refund_amount_1d)</p>
<p>from ${APP}.dws_trade_user_order_refund_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_payment_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_payment_nd partition (dt =<br>‘$do_date’)</p>
<p>select user_id,</p>
<p>sum(if(dt &gt;= date_add(‘$do_date’, -6), payment_count_1d, 0)),</p>
<p>sum(if(dt &gt;= date_add(‘$do_date’, -6), payment_num_1d, 0)),</p>
<p>sum(if(dt &gt;= date_add(‘$do_date’, -6), payment_amount_1d, 0)),</p>
<p>sum(payment_count_1d),</p>
<p>sum(payment_num_1d),</p>
<p>sum(payment_amount_1d)</p>
<p>from ${APP}.dws_trade_user_payment_1d</p>
<p>where dt &gt;= date_add(‘$do_date’, -29)</p>
<p>and dt &lt;= ‘$do_date’</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_sku_order_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_original_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),activity_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),coupon_reduce_amount_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_total_amount_1d,0)),</p>
<p>sum(order_count_1d),</p>
<p>sum(order_num_1d),</p>
<p>sum(order_original_amount_1d),</p>
<p>sum(activity_reduce_amount_1d),</p>
<p>sum(coupon_reduce_amount_1d),</p>
<p>sum(order_total_amount_1d)</p>
<p>from ${APP}.dws_trade_user_sku_order_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-30)</p>
<p>group by<br>user_id,sku_id,sku_name,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name,tm_id,tm_name;</p>
<p>“</p>
<p>dws_trade_user_sku_order_refund_nd=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_sku_order_refund_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_count_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_num_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),order_refund_amount_1d,0)),</p>
<p>sum(order_refund_count_1d),</p>
<p>sum(order_refund_num_1d),</p>
<p>sum(order_refund_amount_1d)</p>
<p>from ${APP}.dws_trade_user_sku_order_refund_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by<br>user_id,sku_id,sku_name,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name,tm_id,tm_name;</p>
<p>“</p>
<p>dws_traffic_page_visitor_page_view_nd=”</p>
<p>insert overwrite table ${APP}.dws_traffic_page_visitor_page_view_nd<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>mid_id,</p>
<p>brand,</p>
<p>model,</p>
<p>operate_system,</p>
<p>page_id,</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),during_time_1d,0)),</p>
<p>sum(if(dt&gt;=date_add(‘$do_date’,-6),view_count_1d,0)),</p>
<p>sum(during_time_1d),</p>
<p>sum(view_count_1d)</p>
<p>from ${APP}.dws_traffic_page_visitor_page_view_1d</p>
<p>where dt&gt;=date_add(‘$do_date’,-29)</p>
<p>and dt&lt;=’$do_date’</p>
<p>group by mid_id,brand,model,operate_system,page_id;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dws_trade_activity_order_nd” )</p>
<p>hive -e “$dws_trade_activity_order_nd”</p>
<p>;;</p>
<p>“dws_trade_coupon_order_nd” )</p>
<p>hive -e “$dws_trade_coupon_order_nd”</p>
<p>;;</p>
<p>“dws_trade_province_order_nd” )</p>
<p>hive -e “$dws_trade_province_order_nd”</p>
<p>;;</p>
<p>“dws_trade_user_cart_add_nd” )</p>
<p>hive -e “$dws_trade_user_cart_add_nd”</p>
<p>;;</p>
<p>“dws_trade_user_order_nd” )</p>
<p>hive -e “$dws_trade_user_order_nd”</p>
<p>;;</p>
<p>“dws_trade_user_order_refund_nd” )</p>
<p>hive -e “$dws_trade_user_order_refund_nd”</p>
<p>;;</p>
<p>“dws_trade_user_payment_nd” )</p>
<p>hive -e “$dws_trade_user_payment_nd”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_nd” )</p>
<p>hive -e “$dws_trade_user_sku_order_nd”</p>
<p>;;</p>
<p>“dws_trade_user_sku_order_refund_nd” )</p>
<p>hive -e “$dws_trade_user_sku_order_refund_nd”</p>
<p>;;</p>
<p>“dws_traffic_page_visitor_page_view_nd” )</p>
<p>hive -e “$dws_traffic_page_visitor_page_view_nd”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dws_trade_activity_order_nd$dws_trade_coupon_order_nd$dws_trade_province_order_nd$dws_trade_user_cart_add_nd$dws_trade_user_order_nd$dws_trade_user_order_refund_nd$dws_trade_user_payment_nd$dws_trade_user_sku_order_nd$dws_trade_user_sku_order_refund_nd$dws_traffic_page_visitor_page_view_nd”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dws_1d_to_dws_nd.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dws_1d_to_dws_nd.sh all 2020-06-14</p>
<h3 id="历史至今汇总表"><a href="#历史至今汇总表" class="headerlink" title="历史至今汇总表"></a>历史至今汇总表</h3><h4 id="交易域用户粒度订单历史至今汇总表"><a href="#交易域用户粒度订单历史至今汇总表" class="headerlink" title="交易域用户粒度订单历史至今汇总表"></a>交易域用户粒度订单历史至今汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_order_td;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_order_td</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`order_date_first` STRING COMMENT ‘首次下单日期’,</p>
<p>`order_date_last` STRING COMMENT ‘末次下单日期’,</p>
<p>`order_count_td` BIGINT COMMENT ‘下单次数’,</p>
<p>`order_num_td` BIGINT COMMENT ‘购买商品件数’,</p>
<p>`original_amount_td` DECIMAL(16, 2) COMMENT ‘原始金额’,</p>
<p>`activity_reduce_amount_td` DECIMAL(16, 2) COMMENT ‘活动优惠金额’,</p>
<p>`coupon_reduce_amount_td` DECIMAL(16, 2) COMMENT ‘优惠券优惠金额’,</p>
<p>`total_amount_td` DECIMAL(16, 2) COMMENT ‘最终金额’</p>
<p>) COMMENT ‘交易域用户粒度订单历史至今汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_order_td’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_trade_user_order_td partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>min(dt) login_date_first,</p>
<p>max(dt) login_date_last,</p>
<p>sum(order_count_1d) order_count,</p>
<p>sum(order_num_1d) order_num,</p>
<p>sum(order_original_amount_1d) original_amount,</p>
<p>sum(activity_reduce_amount_1d) activity_reduce_amount,</p>
<p>sum(coupon_reduce_amount_1d) coupon_reduce_amount,</p>
<p>sum(order_total_amount_1d) total_amount</p>
<p>from dws_trade_user_order_1d</p>
<p>group by user_id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_order_td partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(new.user_id is not null and old.user_id is<br>null,’2020-06-15’,old.order_date_first),</p>
<p>if(new.user_id is not null,’2020-06-15’,old.order_date_last),</p>
<p>nvl(old.order_count_td,0)+nvl(new.order_count_1d,0),</p>
<p>nvl(old.order_num_td,0)+nvl(new.order_num_1d,0),</p>
<p>nvl(old.original_amount_td,0)+nvl(new.order_original_amount_1d,0),</p>
<p>nvl(old.activity_reduce_amount_td,0)+nvl(new.activity_reduce_amount_1d,0),</p>
<p>nvl(old.coupon_reduce_amount_td,0)+nvl(new.coupon_reduce_amount_1d,0),</p>
<p>nvl(old.total_amount_td,0)+nvl(new.order_total_amount_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>order_date_first,</p>
<p>order_date_last,</p>
<p>order_count_td,</p>
<p>order_num_td,</p>
<p>original_amount_td,</p>
<p>activity_reduce_amount_td,</p>
<p>coupon_reduce_amount_td,</p>
<p>total_amount_td</p>
<p>from dws_trade_user_order_td</p>
<p>where dt=date_add(‘2020-06-15’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>order_count_1d,</p>
<p>order_num_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d</p>
<p>from dws_trade_user_order_1d</p>
<p>where dt=’2020-06-15’</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<h4 id="交易域用户粒度支付历史至今汇总表"><a href="#交易域用户粒度支付历史至今汇总表" class="headerlink" title="交易域用户粒度支付历史至今汇总表"></a>交易域用户粒度支付历史至今汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_trade_user_payment_td;</p>
<p>CREATE EXTERNAL TABLE dws_trade_user_payment_td</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`payment_date_first` STRING COMMENT ‘首次支付日期’,</p>
<p>`payment_date_last` STRING COMMENT ‘末次支付日期’,</p>
<p>`payment_count_td` BIGINT COMMENT ‘最近7日支付次数’,</p>
<p>`payment_num_td` BIGINT COMMENT ‘最近7日支付商品件数’,</p>
<p>`payment_amount_td` DECIMAL(16, 2) COMMENT ‘最近7日支付金额’</p>
<p>) COMMENT ‘交易域用户粒度支付历史至今汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_trade_user_payment_td’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_trade_user_payment_td partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>user_id,</p>
<p>min(dt) payment_date_first,</p>
<p>max(dt) payment_date_last,</p>
<p>sum(payment_count_1d) payment_count,</p>
<p>sum(payment_num_1d) payment_num,</p>
<p>sum(payment_amount_1d) payment_amount</p>
<p>from dws_trade_user_payment_1d</p>
<p>group by user_id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_trade_user_payment_td partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(old.user_id is null and new.user_id is not<br>null,’2020-06-15’,old.payment_date_first),</p>
<p>if(new.user_id is not null,’2020-06-15’,old.payment_date_last),</p>
<p>nvl(old.payment_count_td,0)+nvl(new.payment_count_1d,0),</p>
<p>nvl(old.payment_num_td,0)+nvl(new.payment_num_1d,0),</p>
<p>nvl(old.payment_amount_td,0)+nvl(new.payment_amount_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>payment_date_first,</p>
<p>payment_date_last,</p>
<p>payment_count_td,</p>
<p>payment_num_td,</p>
<p>payment_amount_td</p>
<p>from dws_trade_user_payment_td</p>
<p>where dt=date_add(‘2020-06-15’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>payment_count_1d,</p>
<p>payment_num_1d,</p>
<p>payment_amount_1d</p>
<p>from dws_trade_user_payment_1d</p>
<p>where dt=’2020-06-15’</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<h4 id="用户域用户粒度登录历史至今汇总表"><a href="#用户域用户粒度登录历史至今汇总表" class="headerlink" title="用户域用户粒度登录历史至今汇总表"></a>用户域用户粒度登录历史至今汇总表</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS dws_user_user_login_td;</p>
<p>CREATE EXTERNAL TABLE dws_user_user_login_td</p>
<p>(</p>
<p>`user_id` STRING COMMENT ‘用户id’,</p>
<p>`login_date_last` STRING COMMENT ‘末次登录日期’,</p>
<p>`login_count_td` BIGINT COMMENT ‘累计登录次数’</p>
<p>) COMMENT ‘用户域用户粒度登录历史至今汇总事实表’</p>
<p>PARTITIONED BY (`dt` STRING)</p>
<p>STORED AS ORC</p>
<p>LOCATION ‘/warehouse/gmall/dws/dws_user_user_login_td’</p>
<p>TBLPROPERTIES (‘orc.compress’ = ‘snappy’);</p>
<p><strong>2）数据装载</strong></p>
<p><strong>（1）首日装载</strong></p>
<p>insert overwrite table dws_user_user_login_td partition(dt=’2020-06-14’)</p>
<p>select</p>
<p>u.id,</p>
<p>nvl(login_date_last,date_format(create_time,’yyyy-MM-dd’)),</p>
<p>nvl(login_count_td,1)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>create_time</p>
<p>from dim_user_zip</p>
<p>where dt=’9999-12-31’</p>
<p>)u</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>max(dt) login_date_last,</p>
<p>count(*) login_count_td</p>
<p>from dwd_user_login_inc</p>
<p>group by user_id</p>
<p>)l</p>
<p>on u.id=l.user_id;</p>
<p><strong>（2）每日装载</strong></p>
<p>insert overwrite table dws_user_user_login_td partition(dt=’2020-06-15’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(new.user_id is null,old.login_date_last,’2020-06-15’),</p>
<p>nvl(old.login_count_td,0)+nvl(new.login_count_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last,</p>
<p>login_count_td</p>
<p>from dws_user_user_login_td</p>
<p>where dt=date_add(‘2020-06-15’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>count(*) login_count_1d</p>
<p>from dwd_user_login_inc</p>
<p>where dt=’2020-06-15’</p>
<p>group by user_id</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<h4 id="数据装载脚本-5"><a href="#数据装载脚本-5" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h4><p><strong>1）首日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dws_1d_to_dws_td_init.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dws_1d_to_dws_td_init.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>echo “请传入日期参数”</p>
<p>exit</p>
<p>fi</p>
<p>dws_trade_user_order_td=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_td partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>min(dt) login_date_first,</p>
<p>max(dt) login_date_last,</p>
<p>sum(order_count_1d) order_count,</p>
<p>sum(order_num_1d) order_num,</p>
<p>sum(order_original_amount_1d) original_amount,</p>
<p>sum(activity_reduce_amount_1d) activity_reduce_amount,</p>
<p>sum(coupon_reduce_amount_1d) coupon_reduce_amount,</p>
<p>sum(order_total_amount_1d) total_amount</p>
<p>from ${APP}.dws_trade_user_order_1d</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_trade_user_payment_td=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_payment_td<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>user_id,</p>
<p>min(dt) payment_date_first,</p>
<p>max(dt) payment_date_last,</p>
<p>sum(payment_count_1d) payment_count,</p>
<p>sum(payment_num_1d) payment_num,</p>
<p>sum(payment_amount_1d) payment_amount</p>
<p>from ${APP}.dws_trade_user_payment_1d</p>
<p>group by user_id;</p>
<p>“</p>
<p>dws_user_user_login_td=”</p>
<p>insert overwrite table ${APP}.dws_user_user_login_td partition(dt=’$do_date’)</p>
<p>select</p>
<p>u.id,</p>
<p>nvl(login_date_last,date_format(create_time,’yyyy-MM-dd’)),</p>
<p>nvl(login_count_td,1)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>create_time</p>
<p>from ${APP}.dim_user_zip</p>
<p>where dt=’9999-12-31’</p>
<p>)u</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>max(dt) login_date_last,</p>
<p>count(*) login_count_td</p>
<p>from ${APP}.dwd_user_login_inc</p>
<p>group by user_id</p>
<p>)l</p>
<p>on u.id=l.user_id;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dws_trade_user_order_td” )</p>
<p>hive -e “$dws_trade_user_order_td”</p>
<p>;;</p>
<p>“dws_trade_user_payment_td” )</p>
<p>hive -e “$dws_trade_user_payment_td”</p>
<p>;;</p>
<p>“dws_user_user_login_td” )</p>
<p>hive -e “$dws_user_user_login_td”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dws_trade_user_order_td$dws_trade_user_payment_td$dws_user_user_login_td”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dws_1d_to_dws_td_init.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dws_1d_to_dws_td_init.sh all 2020-06-14</p>
<p><strong>2）每日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dws_1d_to_dws_td.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dws_1d_to_dws_td.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>dws_trade_user_order_td=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_order_td partition(dt=’$do_date’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(new.user_id is not null and old.user_id is<br>null,’$do_date’,old.order_date_first),</p>
<p>if(new.user_id is not null,’$do_date’,old.order_date_last),</p>
<p>nvl(old.order_count_td,0)+nvl(new.order_count_1d,0),</p>
<p>nvl(old.order_num_td,0)+nvl(new.order_num_1d,0),</p>
<p>nvl(old.original_amount_td,0)+nvl(new.order_original_amount_1d,0),</p>
<p>nvl(old.activity_reduce_amount_td,0)+nvl(new.activity_reduce_amount_1d,0),</p>
<p>nvl(old.coupon_reduce_amount_td,0)+nvl(new.coupon_reduce_amount_1d,0),</p>
<p>nvl(old.total_amount_td,0)+nvl(new.order_total_amount_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>order_date_first,</p>
<p>order_date_last,</p>
<p>order_count_td,</p>
<p>order_num_td,</p>
<p>original_amount_td,</p>
<p>activity_reduce_amount_td,</p>
<p>coupon_reduce_amount_td,</p>
<p>total_amount_td</p>
<p>from ${APP}.dws_trade_user_order_td</p>
<p>where dt=date_add(‘$do_date’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>order_count_1d,</p>
<p>order_num_1d,</p>
<p>order_original_amount_1d,</p>
<p>activity_reduce_amount_1d,</p>
<p>coupon_reduce_amount_1d,</p>
<p>order_total_amount_1d</p>
<p>from ${APP}.dws_trade_user_order_1d</p>
<p>where dt=’$do_date’</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<p>“</p>
<p>dws_trade_user_payment_td=”</p>
<p>insert overwrite table ${APP}.dws_trade_user_payment_td<br>partition(dt=’$do_date’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(old.user_id is null and new.user_id is not<br>null,’$do_date’,old.payment_date_first),</p>
<p>if(new.user_id is not null,’$do_date’,old.payment_date_last),</p>
<p>nvl(old.payment_count_td,0)+nvl(new.payment_count_1d,0),</p>
<p>nvl(old.payment_num_td,0)+nvl(new.payment_num_1d,0),</p>
<p>nvl(old.payment_amount_td,0)+nvl(new.payment_amount_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>payment_date_first,</p>
<p>payment_date_last,</p>
<p>payment_count_td,</p>
<p>payment_num_td,</p>
<p>payment_amount_td</p>
<p>from ${APP}.dws_trade_user_payment_td</p>
<p>where dt=date_add(‘$do_date’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>payment_count_1d,</p>
<p>payment_num_1d,</p>
<p>payment_amount_1d</p>
<p>from ${APP}.dws_trade_user_payment_1d</p>
<p>where dt=’$do_date’</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<p>“</p>
<p>dws_user_user_login_td=”</p>
<p>insert overwrite table ${APP}.dws_user_user_login_td partition(dt=’$do_date’)</p>
<p>select</p>
<p>nvl(old.user_id,new.user_id),</p>
<p>if(new.user_id is null,old.login_date_last,’$do_date’),</p>
<p>nvl(old.login_count_td,0)+nvl(new.login_count_1d,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last,</p>
<p>login_count_td</p>
<p>from ${APP}.dws_user_user_login_td</p>
<p>where dt=date_add(‘$do_date’,-1)</p>
<p>)old</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>count(*) login_count_1d</p>
<p>from ${APP}.dwd_user_login_inc</p>
<p>where dt=’$do_date’</p>
<p>group by user_id</p>
<p>)new</p>
<p>on old.user_id=new.user_id;</p>
<p>“</p>
<p>case $1 in</p>
<p>“dws_trade_user_order_td” )</p>
<p>hive -e “$dws_trade_user_order_td”</p>
<p>;;</p>
<p>“dws_trade_user_payment_td” )</p>
<p>hive -e “$dws_trade_user_payment_td”</p>
<p>;;</p>
<p>“dws_user_user_login_td” )</p>
<p>hive -e “$dws_user_user_login_td”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$dws_trade_user_order_td$dws_trade_user_payment_td$dws_user_user_login_td”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dws_1d_to_dws_td.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dws_1d_to_dws_td.sh all 2020-06-14</p>
<h2 id="第11章-数仓开发之ADS层"><a href="#第11章-数仓开发之ADS层" class="headerlink" title="第11章 数仓开发之ADS层"></a>第11章 数仓开发之ADS层</h2><h3 id="流量主题"><a href="#流量主题" class="headerlink" title="流量主题"></a>流量主题</h3><h4 id="各渠道流量统计"><a href="#各渠道流量统计" class="headerlink" title="各渠道流量统计"></a>各渠道流量统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1/7/30日</td>
<td>渠道</td>
<td>访客数</td>
<td>统计访问人数</td>
</tr>
<tr>
<td>最近1/7/30日</td>
<td>渠道</td>
<td>会话平均停留时长</td>
<td>统计每个会话平均停留时长</td>
</tr>
<tr>
<td>最近1/7/30日</td>
<td>渠道</td>
<td>会话平均浏览页面数</td>
<td>统计每个会话平均浏览页面数</td>
</tr>
<tr>
<td>最近1/7/30日</td>
<td>渠道</td>
<td>会话总数</td>
<td>统计会话总数</td>
</tr>
<tr>
<td>最近1/7/30日</td>
<td>渠道</td>
<td>跳出率</td>
<td>只有一个页面的会话的比例</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_traffic_stats_by_channel;</p>
<p>CREATE EXTERNAL TABLE ads_traffic_stats_by_channel</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`channel` STRING COMMENT ‘渠道’,</p>
<p>`uv_count` BIGINT COMMENT ‘访客人数’,</p>
<p>`avg_duration_sec` BIGINT COMMENT ‘会话平均停留时长，单位为秒’,</p>
<p>`avg_page_count` BIGINT COMMENT ‘会话平均浏览页面数’,</p>
<p>`sv_count` BIGINT COMMENT ‘会话数’,</p>
<p>`bounce_rate` DECIMAL(16, 2) COMMENT ‘跳出率’</p>
<p>) COMMENT ‘各渠道流量统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_traffic_stats_by_channel/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_traffic_stats_by_channel</p>
<p>select * from ads_traffic_stats_by_channel</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>recent_days,</p>
<p>channel,</p>
<p>cast(count(distinct(mid_id)) as bigint) uv_count,</p>
<p>cast(avg(during_time_1d)/1000 as bigint) avg_duration_sec,</p>
<p>cast(avg(page_count_1d) as bigint) avg_page_count,</p>
<p>cast(count(*) as bigint) sv_count,</p>
<p>cast(sum(if(page_count_1d=1,1,0))/count(*) as decimal(16,2)) bounce_rate</p>
<p>from dws_traffic_session_page_view_1d lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-recent_days+1)</p>
<p>group by recent_days,channel;</p>
<h4 id="路径分析"><a href="#路径分析" class="headerlink" title="路径分析"></a>路径分析</h4><p>用户路径分析，顾名思义，就是指用户在APP或网站中的访问路径。为了衡量网站优化的效果或营销推广的效果，以及了解用户行为偏好，时常要对访问路径进行分析。</p>
<p>用户访问路径的可视化通常使用桑基图。如下图所示，该图可真实还原用户的访问路径，包括页面跳转和页面访问次序。</p>
<p>桑基图需要我们提供每种页面跳转的次数，每个跳转由source/target表示，source指跳转起始页面，target表示跳转终到页面。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/c8def23c91792b9acc5726ffaef85605.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_page_path;</p>
<p>CREATE EXTERNAL TABLE ads_page_path</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`source` STRING COMMENT ‘跳转起始页面ID’,</p>
<p>`target` STRING COMMENT ‘跳转终到页面ID’,</p>
<p>`path_count` BIGINT COMMENT ‘跳转次数’</p>
<p>) COMMENT ‘页面浏览路径分析’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_page_path/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_page_path</p>
<p>select * from ads_page_path</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>recent_days,</p>
<p>source,</p>
<p>nvl(target,’null’),</p>
<p>count(*) path_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>concat(‘step-‘,rn,’:’,page_id) source,</p>
<p>concat(‘step-‘,rn+1,’:’,next_page_id) target</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>page_id,</p>
<p>lead(page_id,1,null) over(partition by session_id,recent_days) next_page_id,</p>
<p>row_number() over (partition by session_id,recent_days order by view_time) rn</p>
<p>from dwd_traffic_page_view_inc lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-recent_days+1)</p>
<p>)t1</p>
<p>)t2</p>
<p>group by recent_days,source,target;</p>
<h3 id="用户主题"><a href="#用户主题" class="headerlink" title="用户主题"></a>用户主题</h3><h4 id="用户变动统计"><a href="#用户变动统计" class="headerlink" title="用户变动统计"></a>用户变动统计</h4><p>该需求包括两个指标，分别为流失用户数和回流用户数，以下为对两个指标的解释说明。</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1日</td>
<td>流失用户数</td>
<td>之前活跃过的用户，最近一段时间未活跃，就称为流失用户。此处要求统计7日前（只包含7日前当天）活跃，但最近7日未活跃的用户总数。</td>
</tr>
<tr>
<td>最近1日</td>
<td>回流用户数</td>
<td>之前的活跃用户，一段时间未活跃（流失），今日又活跃了，就称为回流用户。此处要求统计回流用户总数。</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_user_change;</p>
<p>CREATE EXTERNAL TABLE ads_user_change</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`user_churn_count` BIGINT COMMENT ‘流失用户数’,</p>
<p>`user_back_count` BIGINT COMMENT ‘回流用户数’</p>
<p>) COMMENT ‘用户变动统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_user_change/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_user_change</p>
<p>select * from ads_user_change</p>
<p>union</p>
<p>select</p>
<p>churn.dt,</p>
<p>user_churn_count,</p>
<p>user_back_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>count(*) user_churn_count</p>
<p>from dws_user_user_login_td</p>
<p>where dt=’2020-06-14’</p>
<p>and login_date_last=date_add(‘2020-06-14’,-7)</p>
<p>)churn</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>count(*) user_back_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last</p>
<p>from dws_user_user_login_td</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last login_date_previous</p>
<p>from dws_user_user_login_td</p>
<p>where dt=date_add(‘2020-06-14’,-1)</p>
<p>)t2</p>
<p>on t1.user_id=t2.user_id</p>
<p>where datediff(login_date_last,login_date_previous)&gt;=8</p>
<p>)back</p>
<p>on churn.dt=back.dt;</p>
<h4 id="用户留存率"><a href="#用户留存率" class="headerlink" title="用户留存率"></a>用户留存率</h4><p>留存分析一般包含新增留存和活跃留存分析。</p>
<p>新增留存分析是分析某天的新增用户中，有多少人有后续的活跃行为。活跃留存分析是分析某天的活跃用户中，有多少人有后续的活跃行为。</p>
<p>留存分析是衡量产品对用户价值高低的重要指标。</p>
<p>此处要求统计新增留存率，新增留存率具体是指留存用户数与新增用户数的比值，例如2020-06-14新增100个用户，1日之后（2020-06-15）这100人中有80个人活跃了，那2020-06-14的1日留存数则为80，2020-06-14的1日留存率则为80%。</p>
<p>要求统计每天的1至7日留存率，如下图所示。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/287a3644e35375f85f48b751bb6a16f8.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_user_retention;</p>
<p>CREATE EXTERNAL TABLE ads_user_retention</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`create_date` STRING COMMENT ‘用户新增日期’,</p>
<p>`retention_day` INT COMMENT ‘截至当前日期留存天数’,</p>
<p>`retention_count` BIGINT COMMENT ‘留存用户数量’,</p>
<p>`new_user_count` BIGINT COMMENT ‘新增用户数量’,</p>
<p>`retention_rate` DECIMAL(16, 2) COMMENT ‘留存率’</p>
<p>) COMMENT ‘用户留存率’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_user_retention/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_user_retention</p>
<p>select * from ads_user_retention</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>login_date_first create_date,</p>
<p>datediff(‘2020-06-14’,login_date_first) retention_day,</p>
<p>sum(if(login_date_last=’2020-06-14’,1,0)) retention_count,</p>
<p>count(*) new_user_count,</p>
<p>cast(sum(if(login_date_last=’2020-06-14’,1,0))/count(*)*100 as decimal(16,2))<br>retention_rate</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>date_id login_date_first</p>
<p>from dwd_user_register_inc</p>
<p>where dt&gt;=date_add(‘2020-06-14’,-7)</p>
<p>and dt&lt;‘2020-06-14’</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last</p>
<p>from dws_user_user_login_td</p>
<p>where dt=’2020-06-14’</p>
<p>)t2</p>
<p>on t1.user_id=t2.user_id</p>
<p>group by login_date_first;</p>
<h4 id="用户新增活跃统计"><a href="#用户新增活跃统计" class="headerlink" title="用户新增活跃统计"></a>用户新增活跃统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>指标</th>
<th>指标说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>新增用户数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>活跃用户数</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_user_stats;</p>
<p>CREATE EXTERNAL TABLE ads_user_stats</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近n日,1:最近1日,7:最近7日,30:最近30日’,</p>
<p>`new_user_count` BIGINT COMMENT ‘新增用户数’,</p>
<p>`active_user_count` BIGINT COMMENT ‘活跃用户数’</p>
<p>) COMMENT ‘用户新增活跃统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_user_stats/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_user_stats</p>
<p>select * from ads_user_stats</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>t1.recent_days,</p>
<p>new_user_count,</p>
<p>active_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(login_date_last&gt;=date_add(‘2020-06-14’,-recent_days+1),1,0))<br>new_user_count</p>
<p>from dws_user_user_login_td lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>group by recent_days</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(date_id&gt;=date_add(‘2020-06-14’,-recent_days+1),1,0)) active_user_count</p>
<p>from dwd_user_register_inc lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>group by recent_days</p>
<p>)t2</p>
<p>on t1.recent_days=t2.recent_days;</p>
<h4 id="用户行为漏斗分析"><a href="#用户行为漏斗分析" class="headerlink" title="用户行为漏斗分析"></a>用户行为漏斗分析</h4><p>漏斗分析是一个数据分析模型，它能够科学反映一个业务过程从起点到终点各阶段用户转化情况。由于其能将各阶段环节都展示出来，故哪个阶段存在问题，就能一目了然。</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/f0bc0e0694859a6902469b238252b58a.png" alt="图表, 漏斗图 描述已自动生成"></p>
<p>该需求要求统计一个完整的购物流程各个阶段的人数，具体说明如下：</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>首页浏览人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>商品详情页浏览人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>加购人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>下单人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>支付人数</td>
<td>支付成功人数</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_user_action;</p>
<p>CREATE EXTERNAL TABLE ads_user_action</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`home_count` BIGINT COMMENT ‘浏览首页人数’,</p>
<p>`good_detail_count` BIGINT COMMENT ‘浏览商品详情页人数’,</p>
<p>`cart_count` BIGINT COMMENT ‘加入购物车人数’,</p>
<p>`order_count` BIGINT COMMENT ‘下单人数’,</p>
<p>`payment_count` BIGINT COMMENT ‘支付人数’</p>
<p>) COMMENT ‘漏斗分析’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_user_action/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_user_action</p>
<p>select * from ads_user_action</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>page.recent_days,</p>
<p>home_count,</p>
<p>good_detail_count,</p>
<p>cart_count,</p>
<p>order_count,</p>
<p>payment_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(if(page_id=’home’,1,0)) home_count,</p>
<p>sum(if(page_id=’good_detail’,1,0)) good_detail_count</p>
<p>from dws_traffic_page_visitor_page_view_1d</p>
<p>where dt=’2020-06-14’</p>
<p>and page_id in (‘home’,’good_detail’)</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(page_id=’home’ and view_count&gt;0,1,0)),</p>
<p>sum(if(page_id=’good_detail’ and view_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>page_id,</p>
<p>case recent_days</p>
<p>when 7 then view_count_7d</p>
<p>when 30 then view_count_30d</p>
<p>end view_count</p>
<p>from dws_traffic_page_visitor_page_view_nd lateral view explode(array(7,30)) tmp<br>as recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>and page_id in (‘home’,’good_detail’)</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)page</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) cart_count</p>
<p>from dws_trade_user_cart_add_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(cart_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then cart_add_count_7d</p>
<p>when 30 then cart_add_count_30d</p>
<p>end cart_count</p>
<p>from dws_trade_user_cart_add_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)cart</p>
<p>on page.recent_days=cart.recent_days</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) order_count</p>
<p>from dws_trade_user_order_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)ord</p>
<p>on page.recent_days=ord.recent_days</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) payment_count</p>
<p>from dws_trade_user_payment_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then payment_count_7d</p>
<p>when 30 then payment_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_payment_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)pay</p>
<p>on page.recent_days=pay.recent_days;</p>
<h4 id="新增交易用户统计"><a href="#新增交易用户统计" class="headerlink" title="新增交易用户统计"></a>新增交易用户统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>新增下单人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>新增支付人数</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_new_buyer_stats;</p>
<p>CREATE EXTERNAL TABLE ads_new_buyer_stats</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`new_order_user_count` BIGINT COMMENT ‘新增下单人数’,</p>
<p>`new_payment_user_count` BIGINT COMMENT ‘新增支付人数’</p>
<p>) COMMENT ‘新增交易用户统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_new_buyer_stats/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_new_buyer_stats</p>
<p>select * from ads_new_buyer_stats</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’,</p>
<p>odr.recent_days,</p>
<p>new_order_user_count,</p>
<p>new_payment_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_date_first&gt;=date_add(‘2020-06-14’,-recent_days+1),1,0))<br>new_order_user_count</p>
<p>from dws_trade_user_order_td lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>group by recent_days</p>
<p>)odr</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(payment_date_first&gt;=date_add(‘2020-06-14’,-recent_days+1),1,0))<br>new_payment_user_count</p>
<p>from dws_trade_user_payment_td lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>group by recent_days</p>
<p>)pay</p>
<p>on odr.recent_days=pay.recent_days;</p>
<h3 id="商品主题"><a href="#商品主题" class="headerlink" title="商品主题"></a>商品主题</h3><h4 id="最近7-30日各品牌复购率"><a href="#最近7-30日各品牌复购率" class="headerlink" title="最近7/30日各品牌复购率"></a>最近7/30日各品牌复购率</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近7、30日</td>
<td>品牌</td>
<td>复购率</td>
<td>重复购买人数占购买人数比例</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_repeat_purchase_by_tm;</p>
<p>CREATE EXTERNAL TABLE ads_repeat_purchase_by_tm</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,7:最近7天,30:最近30天’,</p>
<p>`tm_id` STRING COMMENT ‘品牌ID’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_repeat_rate` DECIMAL(16, 2) COMMENT ‘复购率’</p>
<p>) COMMENT ‘各品牌复购率统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_repeat_purchase_by_tm/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_repeat_purchase_by_tm</p>
<p>select * from ads_repeat_purchase_by_tm</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>cast(sum(if(order_count&gt;=2,1,0))/sum(if(order_count&gt;=1,1,0)) as decimal(16,2))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count) order_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days,user_id,tm_id,tm_name</p>
<p>)t2</p>
<p>group by recent_days,tm_id,tm_name;</p>
<h4 id="各品牌商品交易统计"><a href="#各品牌商品交易统计" class="headerlink" title="各品牌商品交易统计"></a>各品牌商品交易统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>品牌</td>
<td>订单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品牌</td>
<td>订单人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品牌</td>
<td>退单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品牌</td>
<td>退单人数</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_trade_stats_by_tm;</p>
<p>CREATE EXTERNAL TABLE ads_trade_stats_by_tm</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`tm_id` STRING COMMENT ‘品牌ID’,</p>
<p>`tm_name` STRING COMMENT ‘品牌名称’,</p>
<p>`order_count` BIGINT COMMENT ‘订单数’,</p>
<p>`order_user_count` BIGINT COMMENT ‘订单人数’,</p>
<p>`order_refund_count` BIGINT COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` BIGINT COMMENT ‘退单人数’</p>
<p>) COMMENT ‘各品牌商品交易统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_trade_stats_by_tm/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_trade_stats_by_tm</p>
<p>select * from ads_trade_stats_by_tm</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>nvl(odr.recent_days,refund.recent_days),</p>
<p>nvl(odr.tm_id,refund.tm_id),</p>
<p>nvl(odr.tm_name,refund.tm_name),</p>
<p>nvl(order_count,0),</p>
<p>nvl(order_user_count,0),</p>
<p>nvl(order_refund_count,0),</p>
<p>nvl(order_refund_user_count,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(distinct(user_id)) order_user_count</p>
<p>from dws_trade_user_sku_order_1d</p>
<p>where dt=’2020-06-14’</p>
<p>group by tm_id,tm_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count),</p>
<p>count(distinct(if(order_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days,tm_id,tm_name</p>
<p>)odr</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(distinct(user_id)) order_refund_user_count</p>
<p>from dws_trade_user_sku_order_refund_1d</p>
<p>where dt=’2020-06-14’</p>
<p>group by tm_id,tm_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_refund_count),</p>
<p>count(if(order_refund_count&gt;0,user_id,null))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from dws_trade_user_sku_order_refund_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days,tm_id,tm_name</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days</p>
<p>and odr.tm_id=refund.tm_id</p>
<p>and odr.tm_name=refund.tm_name;</p>
<h4 id="各品类商品交易统计"><a href="#各品类商品交易统计" class="headerlink" title="各品类商品交易统计"></a>各品类商品交易统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>品类</td>
<td>订单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品类</td>
<td>订单人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品类</td>
<td>退单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>品类</td>
<td>退单人数</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_trade_stats_by_cate;</p>
<p>CREATE EXTERNAL TABLE ads_trade_stats_by_cate</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类id’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘二级分类id’,</p>
<p>`category2_name` STRING COMMENT ‘二级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘三级分类id’,</p>
<p>`category3_name` STRING COMMENT ‘三级分类名称’,</p>
<p>`order_count` BIGINT COMMENT ‘订单数’,</p>
<p>`order_user_count` BIGINT COMMENT ‘订单人数’,</p>
<p>`order_refund_count` BIGINT COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` BIGINT COMMENT ‘退单人数’</p>
<p>) COMMENT ‘各分类商品交易统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_trade_stats_by_cate/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_trade_stats_by_cate</p>
<p>select * from ads_trade_stats_by_cate</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>nvl(odr.recent_days,refund.recent_days),</p>
<p>nvl(odr.category1_id,refund.category1_id),</p>
<p>nvl(odr.category1_name,refund.category1_name),</p>
<p>nvl(odr.category2_id,refund.category2_id),</p>
<p>nvl(odr.category2_name,refund.category2_name),</p>
<p>nvl(odr.category3_id,refund.category3_id),</p>
<p>nvl(odr.category3_name,refund.category3_name),</p>
<p>nvl(order_count,0),</p>
<p>nvl(order_user_count,0),</p>
<p>nvl(order_refund_count,0),</p>
<p>nvl(order_refund_user_count,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(distinct(user_id)) order_user_count</p>
<p>from dws_trade_user_sku_order_1d</p>
<p>where dt=’2020-06-14’</p>
<p>group by<br>category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_count),</p>
<p>count(distinct(if(order_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by<br>recent_days,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>)odr</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(distinct(user_id)) order_refund_user_count</p>
<p>from dws_trade_user_sku_order_refund_1d</p>
<p>where dt=’2020-06-14’</p>
<p>group by<br>category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_refund_count),</p>
<p>count(distinct(if(order_refund_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from dws_trade_user_sku_order_refund_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by<br>recent_days,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days</p>
<p>and odr.category1_id=refund.category1_id</p>
<p>and odr.category1_name=refund.category1_name</p>
<p>and odr.category2_id=refund.category2_id</p>
<p>and odr.category2_name=refund.category2_name</p>
<p>and odr.category3_id=refund.category3_id</p>
<p>and odr.category3_name=refund.category3_name;</p>
<h4 id="各分类商品购物车存量Top10"><a href="#各分类商品购物车存量Top10" class="headerlink" title="各分类商品购物车存量Top10"></a>各分类商品购物车存量Top10</h4><p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_sku_cart_num_top3_by_cate;</p>
<p>CREATE EXTERNAL TABLE ads_sku_cart_num_top3_by_cate</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`category1_id` STRING COMMENT ‘一级分类ID’,</p>
<p>`category1_name` STRING COMMENT ‘一级分类名称’,</p>
<p>`category2_id` STRING COMMENT ‘二级分类ID’,</p>
<p>`category2_name` STRING COMMENT ‘二级分类名称’,</p>
<p>`category3_id` STRING COMMENT ‘三级分类ID’,</p>
<p>`category3_name` STRING COMMENT ‘三级分类名称’,</p>
<p>`sku_id` STRING COMMENT ‘商品id’,</p>
<p>`sku_name` STRING COMMENT ‘商品名称’,</p>
<p>`cart_num` BIGINT COMMENT ‘购物车中商品数量’,</p>
<p>`rk` BIGINT COMMENT ‘排名’</p>
<p>) COMMENT ‘各分类商品购物车存量Top10’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_sku_cart_num_top3_by_cate/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_sku_cart_num_top3_by_cate</p>
<p>select * from ads_sku_cart_num_top3_by_cate</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>cart_num,</p>
<p>rk</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>cart_num,</p>
<p>rank() over (partition by category1_id,category2_id,category3_id order by<br>cart_num desc) rk</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>sum(sku_num) cart_num</p>
<p>from dwd_trade_cart_full</p>
<p>where dt=’2020-06-14’</p>
<p>group by sku_id</p>
<p>)cart</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name</p>
<p>from dim_sku_full</p>
<p>where dt=’2020-06-14’</p>
<p>)sku</p>
<p>on cart.sku_id=sku.id</p>
<p>)t1</p>
<p>where rk&lt;=3;</p>
<h3 id="交易主题"><a href="#交易主题" class="headerlink" title="交易主题"></a>交易主题</h3><h4 id="交易综合统计"><a href="#交易综合统计" class="headerlink" title="交易综合统计"></a>交易综合统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>订单总额</td>
<td>订单最终金额</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>订单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>订单人数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>退单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>退单人数</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_trade_stats;</p>
<p>CREATE EXTERNAL TABLE ads_trade_stats</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1日,7:最近7天,30:最近30天’,</p>
<p>`order_total_amount` DECIMAL(16, 2) COMMENT ‘订单总额,GMV’,</p>
<p>`order_count` BIGINT COMMENT ‘订单数’,</p>
<p>`order_user_count` BIGINT COMMENT ‘下单人数’,</p>
<p>`order_refund_count` BIGINT COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` BIGINT COMMENT ‘退单人数’</p>
<p>) COMMENT ‘交易统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_trade_stats/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_trade_stats</p>
<p>select * from ads_trade_stats</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’,</p>
<p>odr.recent_days,</p>
<p>order_total_amount,</p>
<p>order_count,</p>
<p>order_user_count,</p>
<p>order_refund_count,</p>
<p>order_refund_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(order_total_amount_1d) order_total_amount,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(*) order_user_count</p>
<p>from dws_trade_user_order_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(order_total_amount),</p>
<p>sum(order_count),</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_total_amount_7d</p>
<p>when 30 then order_total_amount_30d</p>
<p>end order_total_amount,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from dws_trade_user_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)odr</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(*) order_refund_user_count</p>
<p>from dws_trade_user_order_refund_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(order_refund_count),</p>
<p>sum(if(order_refund_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from dws_trade_user_order_refund_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days;</p>
<h4 id="各省份交易统计"><a href="#各省份交易统计" class="headerlink" title="各省份交易统计"></a>各省份交易统计</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计周期</th>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>最近1、7、30日</td>
<td>省份</td>
<td>订单数</td>
<td>略</td>
</tr>
<tr>
<td>最近1、7、30日</td>
<td>省份</td>
<td>订单金额</td>
<td>略</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_order_by_province;</p>
<p>CREATE EXTERNAL TABLE ads_order_by_province</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`recent_days` BIGINT COMMENT ‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`province_id` STRING COMMENT ‘省份ID’,</p>
<p>`province_name` STRING COMMENT ‘省份名称’,</p>
<p>`area_code` STRING COMMENT ‘地区编码’,</p>
<p>`iso_code` STRING COMMENT ‘国际标准地区编码’,</p>
<p>`iso_code_3166_2` STRING COMMENT ‘国际标准地区编码’,</p>
<p>`order_count` BIGINT COMMENT ‘订单数’,</p>
<p>`order_total_amount` DECIMAL(16, 2) COMMENT ‘订单金额’</p>
<p>) COMMENT ‘各地区订单统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_order_by_province/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_order_by_province</p>
<p>select * from ads_order_by_province</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>1 recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_total_amount_1d</p>
<p>from dws_trade_province_order_1d</p>
<p>where dt=’2020-06-14’</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>sum(order_count),</p>
<p>sum(order_total_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count,</p>
<p>case recent_days</p>
<p>when 7 then order_total_amount_7d</p>
<p>when 30 then order_total_amount_30d</p>
<p>end order_total_amount</p>
<p>from dws_trade_province_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’2020-06-14’</p>
<p>)t1</p>
<p>group by recent_days,province_id,province_name,area_code,iso_code,iso_3166_2;</p>
<h3 id="优惠券主题"><a href="#优惠券主题" class="headerlink" title="优惠券主题"></a>优惠券主题</h3><h4 id="最近30天发布的优惠券的补贴率"><a href="#最近30天发布的优惠券的补贴率" class="headerlink" title="最近30天发布的优惠券的补贴率"></a>最近30天发布的优惠券的补贴率</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>优惠券</td>
<td>补贴率</td>
<td>用券的订单明细优惠券减免金额总和/原始金额总和</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_coupon_stats;</p>
<p>CREATE EXTERNAL TABLE ads_coupon_stats</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`coupon_id` STRING COMMENT ‘优惠券ID’,</p>
<p>`coupon_name` STRING COMMENT ‘优惠券名称’,</p>
<p>`start_date` STRING COMMENT ‘发布日期’,</p>
<p>`rule_name` STRING COMMENT ‘优惠规则，例如满100元减10元’,</p>
<p>`reduce_rate` DECIMAL(16, 2) COMMENT ‘补贴率’</p>
<p>) COMMENT ‘优惠券统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_coupon_stats/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_coupon_stats</p>
<p>select * from ads_coupon_stats</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>coupon_id,</p>
<p>coupon_name,</p>
<p>start_date,</p>
<p>coupon_rule,</p>
<p>cast(coupon_reduce_amount_30d/original_amount_30d as decimal(16,2))</p>
<p>from dws_trade_coupon_order_nd</p>
<p>where dt=’2020-06-14’;</p>
<h3 id="活动主题"><a href="#活动主题" class="headerlink" title="活动主题"></a>活动主题</h3><h4 id="最近30天发布的活动的补贴率"><a href="#最近30天发布的活动的补贴率" class="headerlink" title="最近30天发布的活动的补贴率"></a>最近30天发布的活动的补贴率</h4><p>需求说明如下</p>
<table>
<thead>
<tr>
<th>统计粒度</th>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>活动</td>
<td>补贴率</td>
<td>参与促销活动的订单明细活动减免金额总和/原始金额总和</td>
</tr>
</tbody></table>
<p><strong>1）建表语句</strong></p>
<p>DROP TABLE IF EXISTS ads_activity_stats;</p>
<p>CREATE EXTERNAL TABLE ads_activity_stats</p>
<p>(</p>
<p>`dt` STRING COMMENT ‘统计日期’,</p>
<p>`activity_id` STRING COMMENT ‘活动ID’,</p>
<p>`activity_name` STRING COMMENT ‘活动名称’,</p>
<p>`start_date` STRING COMMENT ‘活动开始日期’,</p>
<p>`reduce_rate` DECIMAL(16, 2) COMMENT ‘补贴率’</p>
<p>) COMMENT ‘活动统计’</p>
<p>ROW FORMAT DELIMITED FIELDS TERMINATED BY ‘\t’</p>
<p>LOCATION ‘/warehouse/gmall/ads/ads_activity_stats/‘;</p>
<p><strong>2）数据装载</strong></p>
<p>insert overwrite table ads_activity_stats</p>
<p>select * from ads_activity_stats</p>
<p>union</p>
<p>select</p>
<p>‘2020-06-14’ dt,</p>
<p>activity_id,</p>
<p>activity_name,</p>
<p>start_date,</p>
<p>cast(activity_reduce_amount_30d/original_amount_30d as decimal(16,2))</p>
<p>from dws_trade_activity_order_nd</p>
<p>where dt=’2020-06-14’;</p>
<h3 id="数据装载脚本-6"><a href="#数据装载脚本-6" class="headerlink" title="数据装载脚本"></a>数据装载脚本</h3><p><strong>1）每日数据装载脚本</strong></p>
<p>（1）在hadoop102的/home/atguigu/bin目录下创建dws_to_ads.sh</p>
<p>[atguigu@hadoop102 bin]$ vim dws_to_ads.sh</p>
<p>（2）编写如下内容</p>
<p>##!/bin/bash</p>
<p>APP=gmall</p>
<p>## 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</p>
<p>if [ -n “$2” ] ;then</p>
<p>do_date=$2</p>
<p>else</p>
<p>do_date=`date -d “-1 day” +%F`</p>
<p>fi</p>
<p>ads_activity_stats=”</p>
<p>insert overwrite table ${APP}.ads_activity_stats</p>
<p>select * from ${APP}.ads_activity_stats</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>activity_id,</p>
<p>activity_name,</p>
<p>start_date,</p>
<p>cast(activity_reduce_amount_30d/original_amount_30d as decimal(16,2))</p>
<p>from ${APP}.dws_trade_activity_order_nd</p>
<p>where dt=’$do_date’;</p>
<p>“</p>
<p>ads_coupon_stats=”</p>
<p>insert overwrite table ${APP}.ads_coupon_stats</p>
<p>select * from ${APP}.ads_coupon_stats</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>coupon_id,</p>
<p>coupon_name,</p>
<p>start_date,</p>
<p>coupon_rule,</p>
<p>cast(coupon_reduce_amount_30d/original_amount_30d as decimal(16,2))</p>
<p>from ${APP}.dws_trade_coupon_order_nd</p>
<p>where dt=’$do_date’;</p>
<p>“</p>
<p>ads_new_buyer_stats=”</p>
<p>insert overwrite table ${APP}.ads_new_buyer_stats</p>
<p>select * from ${APP}.ads_new_buyer_stats</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’,</p>
<p>odr.recent_days,</p>
<p>new_order_user_count,</p>
<p>new_payment_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_date_first&gt;=date_add(‘$do_date’,-recent_days+1),1,0))<br>new_order_user_count</p>
<p>from ${APP}.dws_trade_user_order_td lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>group by recent_days</p>
<p>)odr</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(payment_date_first&gt;=date_add(‘$do_date’,-recent_days+1),1,0))<br>new_payment_user_count</p>
<p>from ${APP}.dws_trade_user_payment_td lateral view explode(array(1,7,30)) tmp<br>as recent_days</p>
<p>where dt=’$do_date’</p>
<p>group by recent_days</p>
<p>)pay</p>
<p>on odr.recent_days=pay.recent_days;</p>
<p>“</p>
<p>ads_order_by_province=”</p>
<p>insert overwrite table ${APP}.ads_order_by_province</p>
<p>select * from ${APP}.ads_order_by_province</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>1 recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>order_count_1d,</p>
<p>order_total_amount_1d</p>
<p>from ${APP}.dws_trade_province_order_1d</p>
<p>where dt=’$do_date’</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>sum(order_count),</p>
<p>sum(order_total_amount)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>province_id,</p>
<p>province_name,</p>
<p>area_code,</p>
<p>iso_code,</p>
<p>iso_3166_2,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count,</p>
<p>case recent_days</p>
<p>when 7 then order_total_amount_7d</p>
<p>when 30 then order_total_amount_30d</p>
<p>end order_total_amount</p>
<p>from ${APP}.dws_trade_province_order_nd lateral view explode(array(7,30)) tmp<br>as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days,province_id,province_name,area_code,iso_code,iso_3166_2;</p>
<p>“</p>
<p>ads_page_path=”</p>
<p>insert overwrite table ${APP}.ads_page_path</p>
<p>select * from ${APP}.ads_page_path</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>recent_days,</p>
<p>source,</p>
<p>nvl(target,’null’),</p>
<p>count(*) path_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>concat(‘step-‘,rn,’:’,page_id) source,</p>
<p>concat(‘step-‘,rn+1,’:’,next_page_id) target</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>page_id,</p>
<p>lead(page_id,1,null) over(partition by session_id,recent_days) next_page_id,</p>
<p>row_number() over (partition by session_id,recent_days order by view_time) rn</p>
<p>from ${APP}.dwd_traffic_page_view_inc lateral view explode(array(1,7,30)) tmp<br>as recent_days</p>
<p>where dt&gt;=date_add(‘$do_date’,-recent_days+1)</p>
<p>)t1</p>
<p>)t2</p>
<p>group by recent_days,source,target;</p>
<p>“</p>
<p>ads_repeat_purchase_by_tm=”</p>
<p>insert overwrite table ${APP}.ads_repeat_purchase_by_tm</p>
<p>select * from ${APP}.ads_repeat_purchase_by_tm</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>cast(sum(if(order_count&gt;=2,1,0))/sum(if(order_count&gt;=1,1,0)) as decimal(16,2))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count) order_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp<br>as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days,user_id,tm_id,tm_name</p>
<p>)t2</p>
<p>group by recent_days,tm_id,tm_name;</p>
<p>“</p>
<p>ads_sku_cart_num_top3_by_cate=”</p>
<p>insert overwrite table ${APP}.ads_sku_cart_num_top3_by_cate</p>
<p>select * from ${APP}.ads_sku_cart_num_top3_by_cate</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>cart_num,</p>
<p>rk</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>cart_num,</p>
<p>rank() over (partition by category1_id,category2_id,category3_id order by<br>cart_num desc) rk</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>sku_id,</p>
<p>sum(sku_num) cart_num</p>
<p>from ${APP}.dwd_trade_cart_full</p>
<p>where dt=’$do_date’</p>
<p>group by sku_id</p>
<p>)cart</p>
<p>left join</p>
<p>(</p>
<p>select</p>
<p>id,</p>
<p>sku_name,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name</p>
<p>from ${APP}.dim_sku_full</p>
<p>where dt=’$do_date’</p>
<p>)sku</p>
<p>on cart.sku_id=sku.id</p>
<p>)t1</p>
<p>where rk&lt;=3;</p>
<p>“</p>
<p>ads_trade_stats=”</p>
<p>insert overwrite table ${APP}.ads_trade_stats</p>
<p>select * from ${APP}.ads_trade_stats</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’,</p>
<p>odr.recent_days,</p>
<p>order_total_amount,</p>
<p>order_count,</p>
<p>order_user_count,</p>
<p>order_refund_count,</p>
<p>order_refund_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(order_total_amount_1d) order_total_amount,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(*) order_user_count</p>
<p>from ${APP}.dws_trade_user_order_1d</p>
<p>where dt=’$do_date’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(order_total_amount),</p>
<p>sum(order_count),</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_total_amount_7d</p>
<p>when 30 then order_total_amount_30d</p>
<p>end order_total_amount,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)odr</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(*) order_refund_user_count</p>
<p>from ${APP}.dws_trade_user_order_refund_1d</p>
<p>where dt=’$do_date’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(order_refund_count),</p>
<p>sum(if(order_refund_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from ${APP}.dws_trade_user_order_refund_nd lateral view explode(array(7,30))<br>tmp as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days;</p>
<p>“</p>
<p>ads_trade_stats_by_cate=”</p>
<p>insert overwrite table ${APP}.ads_trade_stats_by_cate</p>
<p>select * from ${APP}.ads_trade_stats_by_cate</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>nvl(odr.recent_days,refund.recent_days),</p>
<p>nvl(odr.category1_id,refund.category1_id),</p>
<p>nvl(odr.category1_name,refund.category1_name),</p>
<p>nvl(odr.category2_id,refund.category2_id),</p>
<p>nvl(odr.category2_name,refund.category2_name),</p>
<p>nvl(odr.category3_id,refund.category3_id),</p>
<p>nvl(odr.category3_name,refund.category3_name),</p>
<p>nvl(order_count,0),</p>
<p>nvl(order_user_count,0),</p>
<p>nvl(order_refund_count,0),</p>
<p>nvl(order_refund_user_count,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(distinct(user_id)) order_user_count</p>
<p>from ${APP}.dws_trade_user_sku_order_1d</p>
<p>where dt=’$do_date’</p>
<p>group by<br>category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_count),</p>
<p>count(distinct(if(order_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp<br>as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by<br>recent_days,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>)odr</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(distinct(user_id)) order_refund_user_count</p>
<p>from ${APP}.dws_trade_user_sku_order_refund_1d</p>
<p>where dt=’$do_date’</p>
<p>group by<br>category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>sum(order_refund_count),</p>
<p>count(distinct(if(order_refund_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>category1_id,</p>
<p>category1_name,</p>
<p>category2_id,</p>
<p>category2_name,</p>
<p>category3_id,</p>
<p>category3_name,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from ${APP}.dws_trade_user_sku_order_refund_nd lateral view<br>explode(array(7,30)) tmp as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by<br>recent_days,category1_id,category1_name,category2_id,category2_name,category3_id,category3_name</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days</p>
<p>and odr.category1_id=refund.category1_id</p>
<p>and odr.category1_name=refund.category1_name</p>
<p>and odr.category2_id=refund.category2_id</p>
<p>and odr.category2_name=refund.category2_name</p>
<p>and odr.category3_id=refund.category3_id</p>
<p>and odr.category3_name=refund.category3_name;</p>
<p>“</p>
<p>ads_trade_stats_by_tm=”</p>
<p>insert overwrite table ${APP}.ads_trade_stats_by_tm</p>
<p>select * from ${APP}.ads_trade_stats_by_tm</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>nvl(odr.recent_days,refund.recent_days),</p>
<p>nvl(odr.tm_id,refund.tm_id),</p>
<p>nvl(odr.tm_name,refund.tm_name),</p>
<p>nvl(order_count,0),</p>
<p>nvl(order_user_count,0),</p>
<p>nvl(order_refund_count,0),</p>
<p>nvl(order_refund_user_count,0)</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count_1d) order_count,</p>
<p>count(distinct(user_id)) order_user_count</p>
<p>from ${APP}.dws_trade_user_sku_order_1d</p>
<p>where dt=’$do_date’</p>
<p>group by tm_id,tm_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_count),</p>
<p>count(distinct(if(order_count&gt;0,user_id,null)))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_sku_order_nd lateral view explode(array(7,30)) tmp<br>as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days,tm_id,tm_name</p>
<p>)odr</p>
<p>full outer join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_refund_count_1d) order_refund_count,</p>
<p>count(distinct(user_id)) order_refund_user_count</p>
<p>from ${APP}.dws_trade_user_sku_order_refund_1d</p>
<p>where dt=’$do_date’</p>
<p>group by tm_id,tm_name</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>sum(order_refund_count),</p>
<p>count(if(order_refund_count&gt;0,user_id,null))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>user_id,</p>
<p>tm_id,</p>
<p>tm_name,</p>
<p>case recent_days</p>
<p>when 7 then order_refund_count_7d</p>
<p>when 30 then order_refund_count_30d</p>
<p>end order_refund_count</p>
<p>from ${APP}.dws_trade_user_sku_order_refund_nd lateral view<br>explode(array(7,30)) tmp as recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days,tm_id,tm_name</p>
<p>)refund</p>
<p>on odr.recent_days=refund.recent_days</p>
<p>and odr.tm_id=refund.tm_id</p>
<p>and odr.tm_name=refund.tm_name;</p>
<p>“</p>
<p>ads_traffic_stats_by_channel=”</p>
<p>insert overwrite table ${APP}.ads_traffic_stats_by_channel</p>
<p>select * from ${APP}.ads_traffic_stats_by_channel</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>recent_days,</p>
<p>channel,</p>
<p>cast(count(distinct(mid_id)) as bigint) uv_count,</p>
<p>cast(avg(during_time_1d)/1000 as bigint) avg_duration_sec,</p>
<p>cast(avg(page_count_1d) as bigint) avg_page_count,</p>
<p>cast(count(*) as bigint) sv_count,</p>
<p>cast(sum(if(page_count_1d=1,1,0))/count(*) as decimal(16,2)) bounce_rate</p>
<p>from ${APP}.dws_traffic_session_page_view_1d lateral view<br>explode(array(1,7,30)) tmp as recent_days</p>
<p>where dt&gt;=date_add(‘$do_date’,-recent_days+1)</p>
<p>group by recent_days,channel;</p>
<p>“</p>
<p>ads_user_action=”</p>
<p>insert overwrite table ${APP}.ads_user_action</p>
<p>select * from ${APP}.ads_user_action</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>page.recent_days,</p>
<p>home_count,</p>
<p>good_detail_count,</p>
<p>cart_count,</p>
<p>order_count,</p>
<p>payment_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>sum(if(page_id=’home’,1,0)) home_count,</p>
<p>sum(if(page_id=’good_detail’,1,0)) good_detail_count</p>
<p>from ${APP}.dws_traffic_page_visitor_page_view_1d</p>
<p>where dt=’$do_date’</p>
<p>and page_id in (‘home’,’good_detail’)</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(page_id=’home’ and view_count&gt;0,1,0)),</p>
<p>sum(if(page_id=’good_detail’ and view_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>page_id,</p>
<p>case recent_days</p>
<p>when 7 then view_count_7d</p>
<p>when 30 then view_count_30d</p>
<p>end view_count</p>
<p>from ${APP}.dws_traffic_page_visitor_page_view_nd lateral view<br>explode(array(7,30)) tmp as recent_days</p>
<p>where dt=’$do_date’</p>
<p>and page_id in (‘home’,’good_detail’)</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)page</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) cart_count</p>
<p>from ${APP}.dws_trade_user_cart_add_1d</p>
<p>where dt=’$do_date’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(cart_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then cart_add_count_7d</p>
<p>when 30 then cart_add_count_30d</p>
<p>end cart_count</p>
<p>from ${APP}.dws_trade_user_cart_add_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)cart</p>
<p>on page.recent_days=cart.recent_days</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) order_count</p>
<p>from ${APP}.dws_trade_user_order_1d</p>
<p>where dt=’$do_date’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then order_count_7d</p>
<p>when 30 then order_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_order_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)ord</p>
<p>on page.recent_days=ord.recent_days</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>1 recent_days,</p>
<p>count(*) payment_count</p>
<p>from ${APP}.dws_trade_user_payment_1d</p>
<p>where dt=’$do_date’</p>
<p>union all</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(order_count&gt;0,1,0))</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>case recent_days</p>
<p>when 7 then payment_count_7d</p>
<p>when 30 then payment_count_30d</p>
<p>end order_count</p>
<p>from ${APP}.dws_trade_user_payment_nd lateral view explode(array(7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>group by recent_days</p>
<p>)pay</p>
<p>on page.recent_days=pay.recent_days;</p>
<p>“</p>
<p>ads_user_change=”</p>
<p>insert overwrite table ${APP}.ads_user_change</p>
<p>select * from ${APP}.ads_user_change</p>
<p>union</p>
<p>select</p>
<p>churn.dt,</p>
<p>user_churn_count,</p>
<p>user_back_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>count(*) user_churn_count</p>
<p>from ${APP}.dws_user_user_login_td</p>
<p>where dt=’$do_date’</p>
<p>and login_date_last=date_add(‘$do_date’,-7)</p>
<p>)churn</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>count(*) user_back_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last</p>
<p>from ${APP}.dws_user_user_login_td</p>
<p>where dt=’$do_date’</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last login_date_previous</p>
<p>from ${APP}.dws_user_user_login_td</p>
<p>where dt=date_add(‘$do_date’,-1)</p>
<p>)t2</p>
<p>on t1.user_id=t2.user_id</p>
<p>where datediff(login_date_last,login_date_previous)&gt;=8</p>
<p>)back</p>
<p>on churn.dt=back.dt;</p>
<p>“</p>
<p>ads_user_retention=”</p>
<p>insert overwrite table ${APP}.ads_user_retention</p>
<p>select * from ${APP}.ads_user_retention</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>login_date_first create_date,</p>
<p>datediff(‘$do_date’,login_date_first) retention_day,</p>
<p>sum(if(login_date_last=’$do_date’,1,0)) retention_count,</p>
<p>count(*) new_user_count,</p>
<p>cast(sum(if(login_date_last=’$do_date’,1,0))/count(*)*100 as decimal(16,2))<br>retention_rate</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>date_id login_date_first</p>
<p>from ${APP}.dwd_user_register_inc</p>
<p>where dt&gt;=date_add(‘$do_date’,-7)</p>
<p>and dt&lt;‘$do_date’</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>user_id,</p>
<p>login_date_last</p>
<p>from ${APP}.dws_user_user_login_td</p>
<p>where dt=’$do_date’</p>
<p>)t2</p>
<p>on t1.user_id=t2.user_id</p>
<p>group by login_date_first;</p>
<p>“</p>
<p>ads_user_stats=”</p>
<p>insert overwrite table ${APP}.ads_user_stats</p>
<p>select * from ${APP}.ads_user_stats</p>
<p>union</p>
<p>select</p>
<p>‘$do_date’ dt,</p>
<p>t1.recent_days,</p>
<p>new_user_count,</p>
<p>active_user_count</p>
<p>from</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(login_date_last&gt;=date_add(‘$do_date’,-recent_days+1),1,0))<br>new_user_count</p>
<p>from ${APP}.dws_user_user_login_td lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>where dt=’$do_date’</p>
<p>group by recent_days</p>
<p>)t1</p>
<p>join</p>
<p>(</p>
<p>select</p>
<p>recent_days,</p>
<p>sum(if(date_id&gt;=date_add(‘$do_date’,-recent_days+1),1,0)) active_user_count</p>
<p>from ${APP}.dwd_user_register_inc lateral view explode(array(1,7,30)) tmp as<br>recent_days</p>
<p>group by recent_days</p>
<p>)t2</p>
<p>on t1.recent_days=t2.recent_days;</p>
<p>“</p>
<p>case $1 in</p>
<p>“ads_activity_stats” )</p>
<p>hive -e “$ads_activity_stats”</p>
<p>;;</p>
<p>“ads_coupon_stats” )</p>
<p>hive -e “$ads_coupon_stats”</p>
<p>;;</p>
<p>“ads_new_buyer_stats” )</p>
<p>hive -e “$ads_new_buyer_stats”</p>
<p>;;</p>
<p>“ads_order_by_province” )</p>
<p>hive -e “$ads_order_by_province”</p>
<p>;;</p>
<p>“ads_page_path” )</p>
<p>hive -e “$ads_page_path”</p>
<p>;;</p>
<p>“ads_repeat_purchase_by_tm” )</p>
<p>hive -e “$ads_repeat_purchase_by_tm”</p>
<p>;;</p>
<p>“ads_sku_cart_num_top3_by_cate” )</p>
<p>hive -e “$ads_sku_cart_num_top3_by_cate”</p>
<p>;;</p>
<p>“ads_trade_stats” )</p>
<p>hive -e “$ads_trade_stats”</p>
<p>;;</p>
<p>“ads_trade_stats_by_cate” )</p>
<p>hive -e “$ads_trade_stats_by_cate”</p>
<p>;;</p>
<p>“ads_trade_stats_by_tm” )</p>
<p>hive -e “$ads_trade_stats_by_tm”</p>
<p>;;</p>
<p>“ads_traffic_stats_by_channel” )</p>
<p>hive -e “$ads_traffic_stats_by_channel”</p>
<p>;;</p>
<p>“ads_user_action” )</p>
<p>hive -e “$ads_user_action”</p>
<p>;;</p>
<p>“ads_user_change” )</p>
<p>hive -e “$ads_user_change”</p>
<p>;;</p>
<p>“ads_user_retention” )</p>
<p>hive -e “$ads_user_retention”</p>
<p>;;</p>
<p>“ads_user_stats” )</p>
<p>hive -e “$ads_user_stats”</p>
<p>;;</p>
<p>“all” )</p>
<p>hive -e<br>“$ads_activity_stats$ads_coupon_stats$ads_new_buyer_stats$ads_order_by_province$ads_page_path$ads_repeat_purchase_by_tm$ads_sku_cart_num_top3_by_cate$ads_trade_stats$ads_trade_stats_by_cate$ads_trade_stats_by_tm$ads_traffic_stats_by_channel$ads_user_action$ads_user_change$ads_user_retention$ads_user_stats”</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x dws_to_ads.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ dws_to_ads.sh all 2020-06-14</p>
<h2 id="第12章-报表数据导出"><a href="#第12章-报表数据导出" class="headerlink" title="第12章 报表数据导出"></a>第12章 报表数据导出</h2><p>为方便报表应用使用数据，需将ads各指标的统计结果导出到MySQL数据库中。</p>
<h3 id="MySQL建库建表"><a href="#MySQL建库建表" class="headerlink" title="MySQL建库建表"></a>MySQL建库建表</h3><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>CREATE DATABASE IF NOT EXISTS gmall_report DEFAULT CHARSET utf8 COLLATE<br>utf8_general_ci;</p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><p><strong>1）各活动补贴率</strong></p>
<p>DROP TABLE IF EXISTS `ads_activity_stats`;</p>
<p>CREATE TABLE `ads_activity_stats` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`activity_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘活动ID’,</p>
<p>`activity_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘活动名称’,</p>
<p>`start_date` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘活动开始日期’,</p>
<p>`reduce_rate` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘补贴率’,</p>
<p>PRIMARY KEY (`dt`, `activity_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘活动统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>2）各优惠券补贴率</strong></p>
<p>DROP TABLE IF EXISTS `ads_coupon_stats`;</p>
<p>CREATE TABLE `ads_coupon_stats` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`coupon_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘优惠券ID’,</p>
<p>`coupon_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘优惠券名称’,</p>
<p>`start_date` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘发布日期’,</p>
<p>`rule_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘优惠规则，例如满100元减10元’,</p>
<p>`reduce_rate` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘补贴率’,</p>
<p>PRIMARY KEY (`dt`, `coupon_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘优惠券统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>3）新增交易用户统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_new_buyer_stats`;</p>
<p>CREATE TABLE `ads_new_buyer_stats` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`new_order_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘新增下单人数’,</p>
<p>`new_payment_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘新增支付人数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘新增交易用户统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>4）各省份订单统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_order_by_province`;</p>
<p>CREATE TABLE `ads_order_by_province` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`province_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘省份ID’,</p>
<p>`province_name` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘省份名称’,</p>
<p>`area_code` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘地区编码’,</p>
<p>`iso_code` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT<br>NULL COMMENT ‘国际标准地区编码’,</p>
<p>`iso_code_3166_2` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘国际标准地区编码’,</p>
<p>`order_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单数’,</p>
<p>`order_total_amount` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘订单金额’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `province_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各地区订单统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>5）用户路径分析</strong></p>
<p>DROP TABLE IF EXISTS `ads_page_path`;</p>
<p>CREATE TABLE `ads_page_path` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`source` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘跳转起始页面ID’,</p>
<p>`target` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘跳转终到页面ID’,</p>
<p>`path_count` bigint(20) NULL DEFAULT NULL COMMENT ‘跳转次数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `source`, `target`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘页面浏览路径分析’ ROW_FORMAT = Dynamic;</p>
<p><strong>6）各品牌复购率</strong></p>
<p>DROP TABLE IF EXISTS `ads_repeat_purchase_by_tm`;</p>
<p>CREATE TABLE `ads_repeat_purchase_by_tm` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT ‘最近天数,7:最近7天,30:最近30天’,</p>
<p>`tm_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘品牌ID’,</p>
<p>`tm_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT<br>NULL COMMENT ‘品牌名称’,</p>
<p>`order_repeat_rate` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘复购率’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `tm_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各品牌复购率统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>7）各品类商品购物车存量topN</strong></p>
<p>DROP TABLE IF EXISTS `ads_sku_cart_num_top3_by_cate`;</p>
<p>CREATE TABLE `ads_sku_cart_num_top3_by_cate` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`category1_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘一级分类ID’,</p>
<p>`category1_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘一级分类名称’,</p>
<p>`category2_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘二级分类ID’,</p>
<p>`category2_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘二级分类名称’,</p>
<p>`category3_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘三级分类ID’,</p>
<p>`category3_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘三级分类名称’,</p>
<p>`sku_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘商品id’,</p>
<p>`sku_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘商品名称’,</p>
<p>`cart_num` bigint(20) NULL DEFAULT NULL COMMENT ‘购物车中商品数量’,</p>
<p>`rk` bigint(20) NULL DEFAULT NULL COMMENT ‘排名’,</p>
<p>PRIMARY KEY (`dt`, `sku_id`, `category1_id`, `category2_id`,<br>`category3_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各分类商品购物车存量Top10’ ROW_FORMAT = Dynamic;</p>
<p><strong>8）交易综合统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_trade_stats`;</p>
<p>CREATE TABLE `ads_trade_stats` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(255) NOT NULL COMMENT<br>‘最近天数,1:最近1日,7:最近7天,30:最近30天’,</p>
<p>`order_total_amount` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘订单总额,GMV’,</p>
<p>`order_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单数’,</p>
<p>`order_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘下单人数’,</p>
<p>`order_refund_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单人数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘交易统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>9）各品类商品交易统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_trade_stats_by_cate`;</p>
<p>CREATE TABLE `ads_trade_stats_by_cate` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`category1_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘一级分类id’,</p>
<p>`category1_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘一级分类名称’,</p>
<p>`category2_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘二级分类id’,</p>
<p>`category2_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘二级分类名称’,</p>
<p>`category3_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘三级分类id’,</p>
<p>`category3_name` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘三级分类名称’,</p>
<p>`order_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单数’,</p>
<p>`order_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单人数’,</p>
<p>`order_refund_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单人数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `category1_id`, `category2_id`,<br>`category3_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各分类商品交易统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>10）各品牌商品交易统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_trade_stats_by_tm`;</p>
<p>CREATE TABLE `ads_trade_stats_by_tm` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`tm_id` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘品牌ID’,</p>
<p>`tm_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT<br>NULL COMMENT ‘品牌名称’,</p>
<p>`order_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单数’,</p>
<p>`order_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘订单人数’,</p>
<p>`order_refund_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单数’,</p>
<p>`order_refund_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘退单人数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `tm_id`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各品牌商品交易统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>11）各渠道流量统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_traffic_stats_by_channel`;</p>
<p>CREATE TABLE `ads_traffic_stats_by_channel` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`channel` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘渠道’,</p>
<p>`uv_count` bigint(20) NULL DEFAULT NULL COMMENT ‘访客人数’,</p>
<p>`avg_duration_sec` bigint(20) NULL DEFAULT NULL COMMENT<br>‘会话平均停留时长，单位为秒’,</p>
<p>`avg_page_count` bigint(20) NULL DEFAULT NULL COMMENT ‘会话平均浏览页面数’,</p>
<p>`sv_count` bigint(20) NULL DEFAULT NULL COMMENT ‘会话数’,</p>
<p>`bounce_rate` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘跳出率’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`, `channel`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘各渠道流量统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>12）用户行为漏斗分析</strong></p>
<p>DROP TABLE IF EXISTS `ads_user_action`;</p>
<p>CREATE TABLE `ads_user_action` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近天数,1:最近1天,7:最近7天,30:最近30天’,</p>
<p>`home_count` bigint(20) NULL DEFAULT NULL COMMENT ‘浏览首页人数’,</p>
<p>`good_detail_count` bigint(20) NULL DEFAULT NULL COMMENT ‘浏览商品详情页人数’,</p>
<p>`cart_count` bigint(20) NULL DEFAULT NULL COMMENT ‘加入购物车人数’,</p>
<p>`order_count` bigint(20) NULL DEFAULT NULL COMMENT ‘下单人数’,</p>
<p>`payment_count` bigint(20) NULL DEFAULT NULL COMMENT ‘支付人数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘漏斗分析’ ROW_FORMAT = Dynamic;</p>
<p><strong>13）用户变动统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_user_change`;</p>
<p>CREATE TABLE `ads_user_change` (</p>
<p>`dt` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT<br>‘统计日期’,</p>
<p>`user_churn_count` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘流失用户数’,</p>
<p>`user_back_count` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br>DEFAULT NULL COMMENT ‘回流用户数’,</p>
<p>PRIMARY KEY (`dt`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘用户变动统计’ ROW_FORMAT = Dynamic;</p>
<p><strong>14）用户留存率</strong></p>
<p>DROP TABLE IF EXISTS `ads_user_retention`;</p>
<p>CREATE TABLE `ads_user_retention` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`create_date` varchar(16) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL<br>COMMENT ‘用户新增日期’,</p>
<p>`retention_day` int(20) NOT NULL COMMENT ‘截至当前日期留存天数’,</p>
<p>`retention_count` bigint(20) NULL DEFAULT NULL COMMENT ‘留存用户数量’,</p>
<p>`new_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘新增用户数量’,</p>
<p>`retention_rate` decimal(16, 2) NULL DEFAULT NULL COMMENT ‘留存率’,</p>
<p>PRIMARY KEY (`dt`, `create_date`, `retention_day`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘留存率’ ROW_FORMAT = Dynamic;</p>
<p><strong>15）用户新增活跃统计</strong></p>
<p>DROP TABLE IF EXISTS `ads_user_stats`;</p>
<p>CREATE TABLE `ads_user_stats` (</p>
<p>`dt` date NOT NULL COMMENT ‘统计日期’,</p>
<p>`recent_days` bigint(20) NOT NULL COMMENT<br>‘最近n日,1:最近1日,7:最近7日,30:最近30日’,</p>
<p>`new_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘新增用户数’,</p>
<p>`active_user_count` bigint(20) NULL DEFAULT NULL COMMENT ‘活跃用户数’,</p>
<p>PRIMARY KEY (`dt`, `recent_days`) USING BTREE</p>
<p>) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT =<br>‘用户新增活跃统计’ ROW_FORMAT = Dynamic;</p>
<h3 id="数据导出"><a href="#数据导出" class="headerlink" title="数据导出"></a>数据导出</h3><p>数据导出工具选用DataX，选用HDFSReader和MySQLWriter。</p>
<h4 id="编写DataX配置文件"><a href="#编写DataX配置文件" class="headerlink" title="编写DataX配置文件"></a>编写DataX配置文件</h4><p>我们需要为每个张表编写一个DataX配置文件，此处以ads_traffic_stats_by_channel为例，配置文件内容如下：</p>
<p>{</p>
<p>“job”: {</p>
<p>“content”: [</p>
<p>{</p>
<p>“reader”: {</p>
<p>“name”: “hdfsreader”,</p>
<p>“parameter”: {</p>
<p>“column”: [</p>
<p>“*“</p>
<p>],</p>
<p>“defaultFS”: “hdfs://hadoop102:8020”,</p>
<p>“encoding”: “UTF-8”,</p>
<p>“fieldDelimiter”: “\t”,</p>
<p>“fileType”: “text”,</p>
<p>“nullFormat”: “\\N”,</p>
<p>“path”: “<strong>${exportdir}</strong>“</p>
<p>}</p>
<p>},</p>
<p>“writer”: {</p>
<p>“name”: “mysqlwriter”,</p>
<p>“parameter”: {</p>
<p>“column”: [</p>
<p>“dt”,</p>
<p>“recent_days”,</p>
<p>“channel”,</p>
<p>“uv_count”,</p>
<p>“avg_duration_sec”,</p>
<p>“avg_page_count”,</p>
<p>“sv_count”,</p>
<p>“bounce_rate”</p>
<p>],</p>
<p>“connection”: [</p>
<p>{</p>
<p>“jdbcUrl”:<br>“jdbc:mysql://hadoop102:3306/gmall_report?useUnicode=true&amp;characterEncoding=utf-8”,</p>
<p>“table”: [</p>
<p>“ads_traffic_stats_by_channel”</p>
<p>]</p>
<p>}</p>
<p>],</p>
<p>“password”: “000000”,</p>
<p>“username”: “root”,</p>
<p>“writeMode”: “replace”</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>“setting”: {</p>
<p>“errorLimit”: {</p>
<p>“percentage”: 0.02,</p>
<p>“record”: 0</p>
<p>},</p>
<p>“speed”: {</p>
<p>“channel”: 3</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>注：导出路径path参数并未写死，需在提交任务时通过参数动态传入，参数名称为exportdir。</p>
<h4 id="DataX配置文件生成脚本"><a href="#DataX配置文件生成脚本" class="headerlink" title="DataX配置文件生成脚本"></a>DataX配置文件生成脚本</h4><p>方便起见，此处提供了DataX配置文件批量生成脚本，脚本内容及使用方式如下。</p>
<p><strong>1）在~/bin目录下创建gen_export_config.py脚本</strong></p>
<p>[atguigu@hadoop102 bin]$ vim ~/bin/gen_export_config.py</p>
<p>脚本内容如下</p>
<p>## coding=utf-8</p>
<p>import json</p>
<p>import getopt</p>
<p>import os</p>
<p>import sys</p>
<p>import MySQLdb</p>
<p>##MySQL相关配置，需根据实际情况作出修改</p>
<p>mysql_host = “hadoop102”</p>
<p>mysql_port = “3306”</p>
<p>mysql_user = “root”</p>
<p>mysql_passwd = “000000”</p>
<p>##HDFS NameNode相关配置，需根据实际情况作出修改</p>
<p>hdfs_nn_host = “hadoop102”</p>
<p>hdfs_nn_port = “8020”</p>
<p>##生成配置文件的目标路径，可根据实际情况作出修改</p>
<p>output_path = “/opt/module/datax/job/export”</p>
<p>def get_connection():</p>
<p>return MySQLdb.connect(host=mysql_host, port=int(mysql_port), user=mysql_user,<br>passwd=mysql_passwd)</p>
<p>def get_mysql_meta(database, table):</p>
<p>connection = get_connection()</p>
<p>cursor = connection.cursor()</p>
<p>sql = “SELECT COLUMN_NAME,DATA_TYPE from information_schema.COLUMNS WHERE<br>TABLE_SCHEMA=%s AND TABLE_NAME=%s ORDER BY ORDINAL_POSITION”</p>
<p>cursor.execute(sql, [database, table])</p>
<p>fetchall = cursor.fetchall()</p>
<p>cursor.close()</p>
<p>connection.close()</p>
<p>return fetchall</p>
<p>def get_mysql_columns(database, table):</p>
<p>return map(lambda x: x[0], get_mysql_meta(database, table))</p>
<p>def generate_json(target_database, target_table):</p>
<p>job = {</p>
<p>“job”: {</p>
<p>“setting”: {</p>
<p>“speed”: {</p>
<p>“channel”: 3</p>
<p>},</p>
<p>“errorLimit”: {</p>
<p>“record”: 0,</p>
<p>“percentage”: 0.02</p>
<p>}</p>
<p>},</p>
<p>“content”: [{</p>
<p>“reader”: {</p>
<p>“name”: “hdfsreader”,</p>
<p>“parameter”: {</p>
<p>“path”: “${exportdir}”,</p>
<p>“defaultFS”: “hdfs://“ + hdfs_nn_host + “:” + hdfs_nn_port,</p>
<p>“column”: [“*“],</p>
<p>“fileType”: “text”,</p>
<p>“encoding”: “UTF-8”,</p>
<p>“fieldDelimiter”: “\t”,</p>
<p>“nullFormat”: “\\N”</p>
<p>}</p>
<p>},</p>
<p>“writer”: {</p>
<p>“name”: “mysqlwriter”,</p>
<p>“parameter”: {</p>
<p>“writeMode”: “replace”,</p>
<p>“username”: mysql_user,</p>
<p>“password”: mysql_passwd,</p>
<p>“column”: get_mysql_columns(target_database, target_table),</p>
<p>“connection”: [</p>
<p>{</p>
<p>“jdbcUrl”:</p>
<p>“jdbc:mysql://“ + mysql_host + “:” + mysql_port + “/“ + target_database +<br>“?useUnicode=true&amp;characterEncoding=utf-8”,</p>
<p>“table”: [target_table]</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>}</p>
<p>}]</p>
<p>}</p>
<p>}</p>
<p>if not os.path.exists(output_path):</p>
<p>os.makedirs(output_path)</p>
<p>with open(os.path.join(output_path, “.”.join([target_database, target_table,<br>“json”])), “w”) as f:</p>
<p>json.dump(job, f)</p>
<p>def main(args):</p>
<p>target_database = “”</p>
<p>target_table = “”</p>
<p>options, arguments = getopt.getopt(args, ‘-d:-t:’, [‘targetdb=’, ‘targettbl=’])</p>
<p>for opt_name, opt_value in options:</p>
<p>if opt_name in (‘-d’, ‘–targetdb’):</p>
<p>target_database = opt_value</p>
<p>if opt_name in (‘-t’, ‘–targettbl’):</p>
<p>target_table = opt_value</p>
<p>generate_json(target_database, target_table)</p>
<p>if _<em>name</em>_ == ‘<strong>main</strong>‘:</p>
<p>main(sys.argv[1:])</p>
<p><strong>注：</strong></p>
<p><strong>（1）安装Python Mysql驱动</strong></p>
<p><strong>由于需要使用Python访问Mysql数据库，故需安装驱动，命令如下：</strong></p>
<p>[atguigu@hadoop102 bin]$ sudo yum install -y MySQL-python</p>
<p><strong>（2）脚本使用说明</strong></p>
<p>python gen_export_config.py <strong>-d</strong> database <strong>-t</strong> table</p>
<p>通过-d传入MySQL数据库名，-t传入MySQL表名，执行上述命令即可生成该表的DataX同步配置文件。</p>
<p><strong>2）在~/bin目录下创建gen_export_config.sh脚本</strong></p>
<p>[atguigu@hadoop102 bin]$ vim ~/bin/gen_export_config.sh</p>
<p>脚本内容如下</p>
<p>##!/bin/bash</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_activity_stats</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_coupon_stats</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_new_buyer_stats</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_order_by_province</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_page_path</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_repeat_purchase_by_tm</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t<br>ads_sku_cart_num_top3_by_cate</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_trade_stats</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_trade_stats_by_cate</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_trade_stats_by_tm</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t<br>ads_traffic_stats_by_channel</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_user_action</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_user_change</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_user_retention</p>
<p>python ~/bin/gen_export_config.py -d gmall_report -t ads_user_stats</p>
<p><strong>3）为gen_export_config.sh脚本增加执行权限</strong></p>
<p>[atguigu@hadoop102 bin]$ chmod +x ~/bin/gen_export_config.sh</p>
<p><strong>4）执行gen_export_config.sh脚本，生成配置文件</strong></p>
<p>[atguigu@hadoop102 bin]$ gen_export_config.sh</p>
<p><strong>5）观察生成的配置文件</strong></p>
<p>[atguigu@hadoop102 bin]$ ls /opt/module/datax/job/export/</p>
<p>总用量 64</p>
<p>gmall_report.ads_activity_stats.json gmall_report.ads_trade_stats_by_cate.json</p>
<p>gmall_report.ads_coupon_stats.json gmall_report.ads_trade_stats_by_tm.json</p>
<p>gmall_report.ads_new_buyer_stats.json gmall_report.ads_trade_stats.json</p>
<p>gmall_report.ads_order_by_province.json<br>gmall_report.ads_traffic_stats_by_channel.json</p>
<p>gmall_report.ads_user_action.json</p>
<p>gmall_report.ads_page_path.json gmall_report.ads_user_change.json</p>
<p>gmall_report.ads_repeat_purchase_by_tm.json gmall_report.ads_user_retention.json</p>
<p>gmall_report.ads_sku_cart_num_top3_by_cate.json gmall_report.ads_user_stats.json</p>
<h4 id="测试生成的DataX配置文件"><a href="#测试生成的DataX配置文件" class="headerlink" title="测试生成的DataX配置文件"></a>测试生成的DataX配置文件</h4><p>以ads_traffic_stats_by_channel为例，测试用脚本生成的配置文件是否可用。</p>
<p><strong>1）执行DataX同步命令</strong></p>
<p>[atguigu@hadoop102 bin]$ python /opt/module/datax/bin/datax.py<br>-p”-Dexportdir=/warehouse/gmall/ads/ads_traffic_stats_by_channel”<br>/opt/module/datax/job/export/gmall_report.ads_traffic_stats_by_channel.json</p>
<p><strong>2）观察同步结果</strong></p>
<p>观察MySQL目标表是否出现数据。</p>
<h4 id="编写每日导出脚本"><a href="#编写每日导出脚本" class="headerlink" title="编写每日导出脚本"></a>编写每日导出脚本</h4><p>（1）在hadoop102的/home/atguigu/bin目录下创建hdfs_to_mysql.sh</p>
<p>[atguigu@hadoop102 bin]$ vim hdfs_to_mysql.sh</p>
<p>（2）编写如下内容</p>
<p>##! /bin/bash</p>
<p>DATAX_HOME=/opt/module/datax</p>
<p>##DataX导出路径不允许存在空文件，该函数作用为清理空文件</p>
<p>handle_export_path(){</p>
<p>for i in `hadoop fs -ls -R $1 | awk ‘{print $8}’`; do</p>
<p>hadoop fs -test -z $i</p>
<p>if [[ $? -eq 0 ]]; then</p>
<p>echo “$i文件大小为0，正在删除”</p>
<p>hadoop fs -rm -r -f $i</p>
<p>fi</p>
<p>done</p>
<p>}</p>
<p>##数据导出</p>
<p>export_data() {</p>
<p>datax_config=$1</p>
<p>export_dir=$2</p>
<p>handle_export_path $export_dir</p>
<p>$DATAX_HOME/bin/datax.py -p”-Dexportdir=$export_dir” $datax_config</p>
<p>}</p>
<p>case $1 in</p>
<p>“ads_new_buyer_stats”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_new_buyer_stats.json<br>/warehouse/gmall/ads/ads_new_buyer_stats</p>
<p>;;</p>
<p>“ads_order_by_province”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_order_by_province.json<br>/warehouse/gmall/ads/ads_order_by_province</p>
<p>;;</p>
<p>“ads_page_path”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_page_path.json<br>/warehouse/gmall/ads/ads_page_path</p>
<p>;;</p>
<p>“ads_repeat_purchase_by_tm”)</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_repeat_purchase_by_tm.json<br>/warehouse/gmall/ads/ads_repeat_purchase_by_tm</p>
<p>;;</p>
<p>“ads_trade_stats”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_trade_stats.json<br>/warehouse/gmall/ads/ads_trade_stats</p>
<p>;;</p>
<p>“ads_trade_stats_by_cate”)</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_trade_stats_by_cate.json<br>/warehouse/gmall/ads/ads_trade_stats_by_cate</p>
<p>;;</p>
<p>“ads_trade_stats_by_tm”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_trade_stats_by_tm.json<br>/warehouse/gmall/ads/ads_trade_stats_by_tm</p>
<p>;;</p>
<p>“ads_traffic_stats_by_channel”)</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_traffic_stats_by_channel.json<br>/warehouse/gmall/ads/ads_traffic_stats_by_channel</p>
<p>;;</p>
<p>“ads_user_action”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_action.json<br>/warehouse/gmall/ads/ads_user_action</p>
<p>;;</p>
<p>“ads_user_change”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_change.json<br>/warehouse/gmall/ads/ads_user_change</p>
<p>;;</p>
<p>“ads_user_retention”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_retention.json<br>/warehouse/gmall/ads/ads_user_retention</p>
<p>;;</p>
<p>“ads_user_stats”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_stats.json<br>/warehouse/gmall/ads/ads_user_stats</p>
<p>;;</p>
<p>“ads_activity_stats”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_activity_stats.json<br>/warehouse/gmall/ads/ads_activity_stats</p>
<p>;;</p>
<p>“ads_coupon_stats”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_coupon_stats.json<br>/warehouse/gmall/ads/ads_coupon_stats</p>
<p>;;</p>
<p>“ads_sku_cart_num_top3_by_cate”)</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_sku_cart_num_top3_by_cate.json<br>/warehouse/gmall/ads/ads_sku_cart_num_top3_by_cate</p>
<p>;;</p>
<p>“all”)</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_new_buyer_stats.json<br>/warehouse/gmall/ads/ads_new_buyer_stats</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_order_by_province.json<br>/warehouse/gmall/ads/ads_order_by_province</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_page_path.json<br>/warehouse/gmall/ads/ads_page_path</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_repeat_purchase_by_tm.json<br>/warehouse/gmall/ads/ads_repeat_purchase_by_tm</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_trade_stats.json<br>/warehouse/gmall/ads/ads_trade_stats</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_trade_stats_by_cate.json<br>/warehouse/gmall/ads/ads_trade_stats_by_cate</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_trade_stats_by_tm.json<br>/warehouse/gmall/ads/ads_trade_stats_by_tm</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_traffic_stats_by_channel.json<br>/warehouse/gmall/ads/ads_traffic_stats_by_channel</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_action.json<br>/warehouse/gmall/ads/ads_user_action</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_change.json<br>/warehouse/gmall/ads/ads_user_change</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_retention.json<br>/warehouse/gmall/ads/ads_user_retention</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_user_stats.json<br>/warehouse/gmall/ads/ads_user_stats</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_activity_stats.json<br>/warehouse/gmall/ads/ads_activity_stats</p>
<p>export_data /opt/module/datax/job/export/gmall_report.ads_coupon_stats.json<br>/warehouse/gmall/ads/ads_coupon_stats</p>
<p>export_data<br>/opt/module/datax/job/export/gmall_report.ads_sku_cart_num_top3_by_cate.json<br>/warehouse/gmall/ads/ads_sku_cart_num_top3_by_cate</p>
<p>;;</p>
<p>esac</p>
<p>（3）增加脚本执行权限</p>
<p>[atguigu@hadoop102 bin]$ chmod +x hdfs_to_mysql.sh</p>
<p>（4）脚本用法</p>
<p>[atguigu@hadoop102 bin]$ hdfs_to_mysql.sh all</p>
<h2 id="第13章-数据仓库工作流调度"><a href="#第13章-数据仓库工作流调度" class="headerlink" title="第13章 数据仓库工作流调度"></a>第13章 数据仓库工作流调度</h2><h3 id="调度工具部署"><a href="#调度工具部署" class="headerlink" title="调度工具部署"></a>调度工具部署</h3><h3 id="新数据生成"><a href="#新数据生成" class="headerlink" title="新数据生成"></a>新数据生成</h3><h4 id="用户行为日志"><a href="#用户行为日志" class="headerlink" title="用户行为日志"></a>用户行为日志</h4><p><strong>1）启动日志采集通道，包括Kafka、Flume等</strong></p>
<p><strong>（1）启动Zookeeper</strong></p>
<p>[atguigu@hadoop102 ~]$ zk.sh start</p>
<p><strong>（2）启动Kafka</strong></p>
<p>[atguigu@hadoop102 ~]$ kf.sh start</p>
<p><strong>（3）启动Flume</strong></p>
<p>[atguigu@hadoop102 ~]$ f1.sh start</p>
<p>[atguigu@hadoop102 ~]$ f2.sh start</p>
<p><strong>2）修改日志模拟器配置文件</strong></p>
<p>修改hadoop102和hadoop103两台节点中的/opt/module/applog/application.yml文件，修改mock.date参数如下</p>
<p>mock.date: “2020-06-15”</p>
<p><strong>3）执行日志生成脚本</strong></p>
<p>[atguigu@hadoop102 ~]$ lg.sh</p>
<p><strong>4）观察HDFS上是否有2020-06-15的日志数据生成</strong></p>
<h4 id="业务数据"><a href="#业务数据" class="headerlink" title="业务数据"></a>业务数据</h4><p><strong>1）修改Maxwell配置文件</strong></p>
<p><strong>（1）修改/opt/module/maxwell/config.properties文件</strong></p>
<p>[atguigu@hadoop102 maxwell]$ vim /opt/module/maxwell/config.properties</p>
<p><strong>（2）修改mock_date参数设置如下</strong></p>
<p>mock_date=2020-06-15</p>
<p><strong>2）启动增量表采集通道，包括Maxwel、Kafka、Flume等</strong></p>
<p><strong>（1）启动Maxwell</strong></p>
<p>[atguigu@hadoop102 ~]$ mxw.sh start</p>
<p><strong>注：若Maxwell当前正在运行，为确保上述mock参数生效，需重启Maxwell。</strong></p>
<p><strong>（2）启动Flume</strong></p>
<p>[atguigu@hadoop102 ~]$ f3.sh start</p>
<p><strong>3）修改业务数据模拟器配置文件中的mock_date参数</strong></p>
<p>mock.date=2020-06-15</p>
<p><strong>4）执行业务数据生成命令</strong></p>
<p>[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2021-10-10.jar</p>
<p><strong>5）观察HDFS上增量表是否有2020-06-15的数据生成</strong></p>
<h3 id="工作流调度实操"><a href="#工作流调度实操" class="headerlink" title="工作流调度实操"></a>工作流调度实操</h3><p>由于DolphinScheduler集群模式启动进程较多，对虚拟机内存要求较高。故下面提供两种方式，可根据虚拟机内存情况进行选择。</p>
<h4 id="DolphinScheduler集群模式"><a href="#DolphinScheduler集群模式" class="headerlink" title="DolphinScheduler集群模式"></a>DolphinScheduler集群模式</h4><p><strong>1）启动DolphinScheduler</strong></p>
<p>[atguigu@hadoop102 dolphinscheduler]$ bin/start-all.sh</p>
<p><strong>2）使用普通用户登录</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/1481d8f1ba008676e566cbdc2500fd15.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>3）向DolphinScheduler资源中心上传工作流所需脚本</strong></p>
<p><strong>（1）创建文件夹</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/a60dc4b0a470a68579f0bda2ccd3a72a.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>（2）上传工作流所需脚本</strong></p>
<p>将工作流所需的所有脚本上传到资源中心scripts路径下，结果如下</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/e6a8173a7ca62fe509ba8b7fe07bc45e.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>4）向DolphinScheduler的WorkerServer节点分发脚本依赖的组件</strong></p>
<p>由于工作流要执行的脚本需要调用Hive、DataX等组件，故在DolphinScheduler的集群模式下，需要确保每个WorkerServer节点都有脚本所依赖的组件。</p>
<p>[atguigu@hadoop102 ~]$ xsync /opt/module/hive/</p>
<p>[atguigu@hadoop102 ~]$ xsync /opt/module/spark/</p>
<p>[atguigu@hadoop102 ~]$ xsync /opt/module/datax/</p>
<p><strong>5）修改DolphinScheduler环境变量配置文件并分发</strong></p>
<p><strong>（1）修改/opt/module/dolphinscheduler/conf/env/dolphinscheduler_env.sh文件</strong></p>
<p>[atguigu@hadoop102 ~]$ vim<br>/opt/module/dolphinscheduler/conf/env/dolphinscheduler_env.sh</p>
<p><strong>（2）修改内容如下</strong></p>
<p><strong>export HADOOP_HOME=/opt/module/hadoop-3.1.3</strong></p>
<p><strong>export HADOOP_CONF_DIR=/opt/module/hadoop-3.1.3/etc/hadoop</strong></p>
<p><strong>export SPARK_HOME=/opt/module/spark</strong></p>
<p>export SPARK_HOME2=/opt/soft/spark2</p>
<p>export PYTHON_HOME=/opt/soft/python</p>
<p><strong>export JAVA_HOME=/opt/module/jdk1.8.0_212</strong></p>
<p><strong>export HIVE_HOME=/opt/module/hive</strong></p>
<p>export FLINK_HOME=/opt/soft/flink</p>
<p><strong>export DATAX_HOME=/opt/module/datax</strong></p>
<p>export<br>PATH=$HADOOP_HOME/bin:$SPARK_HOME1/bin:$SPARK_HOME2/bin:$PYTHON_HOME:$JAVA_HOME/bin:$HIVE_HOME/bin:$FLINK_HOME/bin:$DATAX_HOME/bin:$PATH</p>
<p><strong>（3）分发文件</strong></p>
<p>[atguigu@hadoop102 ~]$ xsync<br>/opt/module/dolphinscheduler/conf/env/dolphinscheduler_env.sh</p>
<p><strong>6）创建工作流</strong></p>
<p><strong>（1）在gmall项目下创建工作流</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/d9fc3d70a9ffeb2779c9ddf2606ec9c6.png" alt="图形用户界面, 文本, 应用程序, 电子邮件
描述已自动生成"></p>
<p><strong>（2）各任务节点配置如下</strong></p>
<p>mysql_to_hdfs_full</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/69e0cb43ad0c3fb4a489714786c83698.png" alt="图形用户界面 描述已自动生成"></p>
<p>hdfs_to_ods_db</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/83911dcf800a2eb193f3065fbf1b9b34.png" alt="图形用户界面, 网站 描述已自动生成"></p>
<p>hdfs_to_ods_log</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/8bb4060781485c522894d2ebc62f1635.png" alt="图形用户界面 描述已自动生成"></p>
<p>ods_to_dwd</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/b4e4a357d08b7bab51f62e65ff38be78.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p>ods_to_dim</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/cf3545948699c57f70046ea24e7624fb.png"></p>
<p>dwd_to_dws_1d</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/7b73a75923f13e3f26143924e2d2c855.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p>dws_1d_to_dws_nd</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/3a75dd2406a506dce545ffd66d2edbf6.png" alt="图形用户界面 描述已自动生成"></p>
<p>dws_1d_to_dws_td</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/f55099f34de24da6434f1b64abc7284d.png" alt="图形用户界面 描述已自动生成"></p>
<p>dws_to_ads</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/48e17699e7ca2b90fedbdff780114ef2.png" alt="图形用户界面 描述已自动生成"></p>
<p>hdfs_to_mysql</p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/b836f074cb3cd97aea4180eba5dacc43.png" alt="图形用户界面 描述已自动生成"></p>
<p><strong>（3）各节点依赖关系如下</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/939d849431ec54a97b617843bcd93c95.png" alt="图片包含 图形用户界面
描述已自动生成"></p>
<p><strong>（4）保存工作流</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/af6fdf3719f3d409433799762e1b7303.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>注：定时调度时，全局参数值应设置为$[yyyy-MM-dd-1]或者空值。</strong></p>
<p><strong>7）上线工作流</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/a9955ba5c3df2b063d8887cc3e7533e7.png" alt="图形用户界面, 文本, 应用程序, 电子邮件
描述已自动生成"></p>
<p><strong>8）执行工作流</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/676ee75ef892f2de4bebaa09a8f68562.png" alt="图形用户界面, 文本, 应用程序, 电子邮件
描述已自动生成"></p>
<h4 id="DolphinScheduler单机模式"><a href="#DolphinScheduler单机模式" class="headerlink" title="DolphinScheduler单机模式"></a>DolphinScheduler单机模式</h4><p><strong>1）启动DolphinScheduler</strong></p>
<p>[atguigu@hadoop102 dolphinscheduler]$ bin/dolphinscheduler-daemon.sh start<br>standalone-server</p>
<p><strong>2）安全中心配置</strong></p>
<p>由于DolphinScheduler的单机模式使用的是内置的ZK和数据库，故在集群模式下所做的相关配置在单机模式下并不可见，所以需要重新配置，必要的配置为创建租户和创建用户。</p>
<p><strong>（1）使用管理员用户登录</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/1481d8f1ba008676e566cbdc2500fd15.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>（2）创建租户</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/0a674653cabbac1345075a5875dd95f7.png" alt="图形用户界面 描述已自动生成"></p>
<p><strong>（3）创建用户</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/bda9944d222b47200b691e3cf2657388.png" alt="手机屏幕截图 描述已自动生成"></p>
<p><strong>3）切换普通用户登录</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/1481d8f1ba008676e566cbdc2500fd15.png" alt="图形用户界面, 应用程序
描述已自动生成"></p>
<p><strong>4）创建项目</strong></p>
<p><img src="https://snowgo.top/medias/medias/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%935.0/ab622546c77763b07184f0dcbf1afc28.png" alt="图形用户界面, 网站 描述已自动生成"></p>
<p><strong>5）其余操作</strong></p>
<p>其余操作与集群模式基本一致，其中分发Hive、Spark、DataX这一步可以省略。</p>

      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" class="">
              数据仓库
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>author:  </strong>snowgo</a>
    </li>
    <li class="post-copyright-link">
    <strong>link:  </strong>
    <a href="/2022/01/22/电商数仓V5.0/" target="_blank" title="电商数仓V5.0">https://snowgo.live/2022/01/22/电商数仓V5.0/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright notice:   </strong>
      All articles on this website, unless otherwise stated, adopt <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      reprint policy. If reproduced, please indicate source!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload" src="https://images4.alphacoders.com/822/thumb-1920-822927.jpg" alt="">
    </div>
    <a href="/2022/01/22/%E5%B0%9A%E7%A1%85%E8%B0%B7%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%A1%B9%E7%9B%AE%E4%B9%8B%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%B9%B3%E5%8F%B0%EF%BC%89V5.0/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> Prev:
        <div class="title-text">尚硅谷大数据项目之电商数仓（业务数据采集平台）V5.0</div>
      </div>
      
      <!-- <div class="content">
        尚硅谷大数据项目之电商数仓（业务数据采集平台）
(作者：尚硅谷大数据研发部)
版本：V5.0
第1章 电商业务简介电商业
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload" src="https://images2.alphacoders.com/119/thumb-1920-1191962.jpg" src="" alt="">
    </div>
    <a href="/2021/12/21/Log4j%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90/" class="post-nav-link">
      <div class="title">
        Next: <i class="fas fa-angle-right"></i>
        <div class="title-text">Log4j漏洞解析</div>
      </div>
      <!-- <div class="content">
        相信大家都知道这两天 log4j 一个超大漏洞闹得全网都沸沸扬扬，大多数跟 Java 有关的服务目前基本都处于维护状态。
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <!-- 文章详情页右侧目录 -->

  <div class="toc-aside">
    <div class="toc-main">
      <div class="toc-aside-title">
        <i class="fas fa-list-ul" aria-hidden="true"></i><span>catalog</span>
        
          <div class="toc-open-close">catalog</div>
        
      </div>
      <div class="toc-content">
        <div class="toc"></div>
      </div>
    </div>
  </div>

  <!-- 手机端目录按钮 -->
  <div id="toc-mobile-btn">
    <i class="fas fa-list-ul" aria-hidden="true"></i>
  </div>


<script>
  function closeToc(init) {
    $(".toc-aside").css({'width': 0, 'padding': 0, 'transition': init ?  'noe' : 'width 0.3s' });
    $(".toc-content").css({'width': 0});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'none'});
    $(".main-content").css({'width': '75%', 'margin-left': 'auto', 'margin-right': 'auto',});
  };
  function openToc() {
    $(".main-content").css({'width': '65%', 'margin-right': '10px', 'margin-left': 'calc(35% - 350px)'});
    $(".toc-aside").css({'width': '300px', 'padding': '0 10px', 'transition': 'width 0.3s'});
    $(".toc-content").css({'width': '300px'});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'inline-block'});
  }
  function openBtnClickFn () {
    let openOrCloseBtn = $('.toc-aside .toc-aside-title .toc-open-close');
    let open = eval('' || 'true');
    openOrCloseBtn.click(function() {
      if (open) {
        closeToc();
        open = false;
      } else {
        openToc();
        open = true;
      }
    });
  };
  openBtnClickFn();
  initCloseTocWidth(true);

  function initCloseTocWidth(init) {
    if (window.innerWidth >= 992) {
      let isClose = false;
      isClose && closeToc(init)
    }
  }

  document.addEventListener('pjax:complete', function () {
    $(".toc-aside").css({'transition': 'no'});
  })
  document.addEventListener('pjax:complete', function () {
    openBtnClickFn();
  })
  
</script>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '5000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = 'https://images2.alphacoders.com/176/thumb-1920-176292.jpg' || 'https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/1.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/2.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/3.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/4.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/5.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/6.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/7.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/8.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/9.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/10.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/11.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/12.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/13.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/14.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/15.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/16.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/17.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/18.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/19.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/20.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/21.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/22.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/23.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/24.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/25.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/26.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/27.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/28.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/29.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/30.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/31.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/32.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/33.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/34.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/35.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/36.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/37.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/38.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/39.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/40.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/41.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/42.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/43.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/44.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/45.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/46.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/47.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/48.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/49.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/50.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/51.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/52.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/53.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/54.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/55.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/56.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/57.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/58.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/59.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/60.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/61.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/62.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/63.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/64.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/65.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/66.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/67.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/68.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/69.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/70.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/71.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/72.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/73.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/74.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/75.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/76.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/77.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/78.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/79.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/80.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/81.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/82.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/83.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/84.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/85.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/86.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/87.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/88.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/89.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/90.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/91.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/92.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/93.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/94.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/95.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/96.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/97.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/98.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/99.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/100.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/101.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/102.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/103.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/104.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/105.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/106.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/107.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/108.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/109.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/110.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/111.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/112.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/113.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/114.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/115.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/116.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/117.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/118.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/119.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/120.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/121.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/122.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/123.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/124.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/125.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/126.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/127.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/128.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/129.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/130.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/131.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/132.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/133.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/134.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/135.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/136.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/137.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/138.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/139.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/140.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/141.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/142.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/143.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/144.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/145.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/146.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/147.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/148.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/149.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/150.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/151.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/152.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/153.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/154.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/155.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/156.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/157.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/158.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/159.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/160.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/161.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/162.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/163.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/164.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/165.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/166.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/167.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/168.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/169.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/170.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/171.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/172.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/173.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/174.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/175.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/176.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/177.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/178.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/179.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/180.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/181.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/182.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/183.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/184.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/185.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/186.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/187.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/188.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/189.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/190.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/191.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/192.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/193.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/194.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/195.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/196.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/197.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/198.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/199.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/200.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/201.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/202.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/203.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/204.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/205.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/206.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/207.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/208.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/209.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/210.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/211.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/212.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/213.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/214.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/215.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/216.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/217.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/218.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/219.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/220.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/221.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/222.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/223.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/224.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/225.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/226.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/227.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/228.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/229.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/230.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/231.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/232.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/233.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/234.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/235.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/236.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/237.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/238.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/239.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/240.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/241.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/242.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/243.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/244.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/245.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/246.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/247.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/248.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/249.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/250.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/251.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/252.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/253.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/254.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/255.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/256.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/257.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/258.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/259.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/260.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/261.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/262.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/263.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/264.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/265.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/266.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/267.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/268.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/269.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/270.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/271.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/272.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/273.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/274.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/275.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/276.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/277.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/278.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/279.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/280.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/281.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/282.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/283.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/284.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/285.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/286.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/287.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/288.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/289.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/290.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/291.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/292.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/293.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/294.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/295.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/296.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/297.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/298.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/299.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/300.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/301.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/302.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/303.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/304.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/305.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/306.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/307.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/308.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/309.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/310.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/311.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/312.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/313.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/314.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/315.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/316.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/317.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/318.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/319.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/320.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/321.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/322.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/323.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/324.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/325.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/326.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/327.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/328.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/329.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/330.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/331.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/332.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/333.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/334.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/335.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/336.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/337.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/338.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/339.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/340.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/341.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/342.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/343.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/344.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/345.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/346.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/347.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/348.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/349.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/350.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/351.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/352.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/353.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/354.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/355.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/356.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/357.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/358.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/359.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/360.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/361.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/362.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/363.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/364.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/365.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/366.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/367.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/368.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/369.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/370.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/371.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/372.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/373.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/374.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/375.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/376.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/377.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/378.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/379.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/380.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/381.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/382.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/383.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/384.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/385.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/386.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/387.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/388.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/389.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/390.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/391.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/392.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/393.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/394.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/395.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/396.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/397.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/398.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/399.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/400.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/401.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/402.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/403.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/404.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/405.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/406.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/407.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/408.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/409.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/410.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/411.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/412.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/413.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/414.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/415.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/416.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/417.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/418.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/419.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/420.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/421.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/422.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/423.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/424.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/425.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/426.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/427.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/428.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/429.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/430.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/431.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/432.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/433.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/434.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/435.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/436.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/437.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/438.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/439.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/440.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/441.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/442.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/443.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/444.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/445.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/446.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/447.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/448.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/449.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/450.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/451.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/452.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/453.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/454.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/455.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/456.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/457.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/458.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/459.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/460.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/461.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/462.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/463.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/464.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/465.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/466.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/467.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/468.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/469.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/470.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/471.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/472.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/473.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/474.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/475.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/476.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/477.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/478.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/479.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/480.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/481.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/482.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/483.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/484.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/485.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/486.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/487.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/488.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/489.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/490.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/491.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/492.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/493.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/494.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/495.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/496.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/497.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/498.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/499.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/500.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/501.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/502.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/503.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/504.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/505.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/506.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/507.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/508.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/509.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/510.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/511.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/512.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/513.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/514.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/515.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/516.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/517.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/518.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/519.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/520.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/521.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/522.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/523.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/524.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/525.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/526.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/527.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/528.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/529.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/530.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/531.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/532.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/533.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/534.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/535.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/536.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/537.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/538.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/539.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/540.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/541.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/542.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/543.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/544.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/545.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/546.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/547.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/548.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/549.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/550.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/551.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/552.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/553.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/554.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/555.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/556.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/557.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/558.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/559.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/560.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/561.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/562.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/563.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/564.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/565.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/566.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/567.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/568.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/569.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/570.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/571.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/572.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/573.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/574.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/575.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/576.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/577.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/578.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/579.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/580.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/581.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/582.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/583.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/584.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/585.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/586.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/587.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/588.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/589.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/590.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/591.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/592.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/593.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/594.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/595.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/596.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/597.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/598.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/599.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/600.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/601.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/602.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/603.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/604.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/605.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/606.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/607.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/608.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/609.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/610.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/611.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/612.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/613.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/614.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/615.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/616.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/617.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/618.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/619.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/620.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/621.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/622.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/623.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/624.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/625.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/626.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/627.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/628.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/629.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/630.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/631.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/632.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/633.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/634.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/635.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/636.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/637.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/638.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/639.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/640.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/641.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/642.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/643.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/644.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/645.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/646.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/647.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/648.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/649.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/650.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/651.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/652.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/653.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/654.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/655.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/656.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/657.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/658.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/659.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/660.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/661.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/662.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/663.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/664.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/665.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/666.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/667.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/668.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/669.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/670.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/671.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/672.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/673.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/674.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/675.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/676.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/677.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/678.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/679.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/680.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/681.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/682.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/683.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/684.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/685.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/686.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/687.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/688.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/689.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/690.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/691.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/692.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/693.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/694.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/695.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/696.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/697.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/698.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/699.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/700.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/701.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/702.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/703.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/704.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/705.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/706.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/707.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/708.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/709.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/710.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/711.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/712.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/713.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/714.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/715.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/716.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/717.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/718.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/719.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/720.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/721.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/722.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/723.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/724.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/725.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/726.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/727.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/728.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/729.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/730.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/731.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/732.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/733.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/734.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/735.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/736.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/737.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/738.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/739.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/740.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/741.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/742.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/743.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/744.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/745.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/746.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/747.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/748.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/749.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/750.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/751.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/752.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/753.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/754.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/755.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/756.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/757.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/758.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/759.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/760.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/761.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/762.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/763.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/764.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/765.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/766.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/767.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/768.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/769.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/770.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/771.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/772.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/773.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/774.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/775.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/776.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/777.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/778.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/779.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/780.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/781.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/782.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/783.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/784.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/785.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/786.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/787.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/788.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/789.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/790.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/791.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/792.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/793.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/794.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/795.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/796.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/797.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/798.jpg,https://snowgo.top/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/799.jpg';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




      </main>
    </div>

    <!-- 页脚 -->
    
  
  
    <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = 'rgba(0, 0, 0, 0.5)' || '#272727';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2020 - 2022 <a target="_blank" rel="noopener" href="https://github.com/snowgo">snowgo</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a> | <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">鲁ICP备2022021620号-1</a> </p>

          </div>
        
      
        
          
        
      
        
          <div class="footer-custom">
            
              <div><div style="width:300px;margin:0 auto; padding:20px 0;"> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=37140202001145" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="https://snowgo.top/medias/1.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">鲁公网安备 37140202001145号</p></a></div></div>
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  display: none;
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  display: none;
  
  font-size: 15px;
  color: #010202;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="netease"
  type="playlist"
  id="7133935892"
  fixed='true'
  autoplay='false'
  theme='#010202'
  loop='all'
  order='random'
  preload='auto'
  volume='0.7'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    

    <!-- 图片放大 -->
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <!-- 背景彩带 -->
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script>

<script>
  var headerEl = 'h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -80,
    headingsOffset: -($(window).height() * 0.4 - 45),
    positionFixedSelector: '.toc-main',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 100) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('toc-aside')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  }
</style> 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const headerMenuTransparent = true;
    if (!headerMenuTransparent) { return; }
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.css">
  <script src="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = 'copy';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = '';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', 'snowgo/juicesea')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <script src="/js/cursor/fireworks.js"></script>
  





    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <div id="loading-bar-wrapper"><script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>