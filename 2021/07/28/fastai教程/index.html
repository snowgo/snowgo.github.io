<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>fastai教程 | snowgo</title>

  <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://cdn.jsdelivr.net/gh/inkss/fontawesome@5.15.3/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
    <script>
        var themeModelId = '';
        if (themeModelId) {
            localStorage.setItem('modelId', themeModelId);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/gh/yuang01/live2d-widget@latest/autoload.js"></script>
    <script>
        var live2dOpen = eval('true') || false;
        if (!live2dOpen) {
            localStorage.setItem('waifu-display', 1609323474481);
        }
    </script>
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

</head>

  
  <!-- 依赖于jquery和vue -->
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

  

  
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>

  
  
  <body>
    <!-- 预加载动画 -->
    <!-- 页面预加载动画 -->

    
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (href, before, media, attributes) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header   " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo" src="http://106.12.125.218/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/logo.png" alt="logo">
      <h3 class="drawer-box-head_title">snowgo</h3>
      <h5 class="drawer-box-head_desc"></h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">主页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">时间轴</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">类别</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/about" class="drawer-menu-item-link">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于我</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                    <i class="fas fa-book" aria-hidden="true"></i>
                  
                  <span class="name">友人帐</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/bangumis" class="drawer-menu-item-link">
                  
                    <i class="fas fa-video-camera" aria-hidden="true"></i>
                  
                  <span class="name">追番</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="javascript:;" class="drawer-menu-item-link has-children" @click="openOrCloseMenu(7)">
                  <span>
                    
                      <i class="fas fa-link"></i>
                    
                    <span class="name">更多</span>
                  </span>
                  <i class="fas fa-chevron-left arrow " :class="{'icon-rotate': isOpen(7)}" aria-hidden="true"></i>
                </a>
                <ul class="drawer-sub-menu" v-if="isOpen(7)">
                  
                  <li>
                    <a href="/gallery">
                      
                      <i class="fas fa-music" style="margin-top: -20px;"></i>
                      
                      <span>图库</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="http://baidu.com">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>百度</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://github.com/snowgo/">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="http://106.12.125.218/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/mangojuice/pic/logo.png" alt="logo">
        </div>
      
      <a href="/" class="logo">snowgo</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="主页">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">主页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="时间轴">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">时间轴</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="标签">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="类别">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">类别</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/about" class="menu-item-link" title="关于我">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于我</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link" title="友人帐">
                  
                    <i class="fas fa-book" aria-hidden="true"></i>
                  
                  <span class="name">友人帐</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/bangumis" class="menu-item-link" title="追番">
                  
                    <i class="fas fa-video-camera" aria-hidden="true"></i>
                  
                  <span class="name">追番</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="javascript:;" class="menu-item-link" title="更多">
                  
                    <i class="fas fa-link"></i>
                  
                  <span class="name">更多</span>
                  <i class="fas fa-chevron-down arrow" aria-hidden="true"></i>
                </a>
                <ul class="sub-menu">
                  
                  <li>
                    <a href="/gallery">
                      
                      <i class="fas fa-music" style="margin-top: -20px;"></i>
                      
                      <span>图库</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="http://baidu.com">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>百度</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">Search</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="Please enter keywords"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://github.com/snowgo/" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    
</header>
        <!-- 内容区域 -->
        
 <!-- prismjs 代码高亮 -->
 


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('http://106.12.125.218/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/otherpic/905289.png')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        fastai教程
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> Published in：2021-07-28 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> category：
          
            <a href="/categories/DL/" class="post-detail-header_category">
              DL
            </a>
          
        </span>
      

      
        <div class="post-detail-header_wordcount">
          <span class="totalcount">
            <i class="fas fa-file-text-o"></i> Words: 9.7k |
          </span>
  
          <span class="min2read">
            <i class="fas fa-clock"></i> Reading time: 34min |
          </span>
  
          
        </div>
      
    
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>





<div class="row justify-position" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <h2 id="快速预览应用"><a href="#快速预览应用" class="headerlink" title="快速预览应用"></a>快速预览应用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##默认是抓取图像中心进行裁剪</span></span><br><span class="line">item tfms=Resize(<span class="number">128</span>)</span><br><span class="line"><span class="comment">##改为将图像进行拉伸</span></span><br><span class="line">Resize(<span class="number">128</span>, ResizeMethod.Squish)</span><br><span class="line"><span class="comment">##改为将不足的区域进行填充（这里zero可以改成reflect）</span></span><br><span class="line">bears  bears.new(item_tfms=Resize(<span class="number">128</span>, ResizeMethod.Pad, pad_mode=<span class="string">&#x27;zeros&#x27;</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##对Datablock进行处理：用原来的block创建新的block</span></span><br><span class="line">bears = bears. new(item_tfms=Resize(<span class="number">128</span>, ResizeMethod. Squish)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">或者是用RandomResizedCrop</span><br><span class="line">bears = bears.new(item _tfms=RandomRes izedCrop(<span class="number">128</span>, min_scale=<span class="number">0.3</span>))</span><br><span class="line">这样在每一轮训练中网络看到的图片都是不同的</span><br><span class="line">min_scale=<span class="number">0.3</span>：每次至少裁剪<span class="number">30</span>%</span><br><span class="line">以上也是最常用的数据扩增方法</span><br></pre></td></tr></table></figure>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/0.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">上图中，首先CPU执行item_tfms,把图像统一大小，再用GPU执行batch_tfms做数据扩增，这样执行速度快</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：fastai中数据增强只对训练集有效，除了randomresizedcrop之外，他对训练集会抓取随机位置的局部来裁剪，对验证集他会抓取他能抓取的正方形中心位置</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在建立了一个模型之后再进行数据清洗会方便，因为可以用下图这个函数挑选</span><br></pre></td></tr></table></figure>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/1.png"></p>
<h3 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h3><h4 id="使用Bing-image-search-api"><a href="#使用Bing-image-search-api" class="headerlink" title="使用Bing image search api"></a>使用Bing image search api</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/2.png"></p>
<h4 id="分类下载图片到各个文件夹"><a href="#分类下载图片到各个文件夹" class="headerlink" title="分类下载图片到各个文件夹"></a>分类下载图片到各个文件夹</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/3.png"></p>
<h4 id="删除下载失败的图片"><a href="#删除下载失败的图片" class="headerlink" title="删除下载失败的图片"></a>删除下载失败的图片</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/4.png"></p>
<h4 id="创建一个Dataloader模板-DataBlock"><a href="#创建一个Dataloader模板-DataBlock" class="headerlink" title="创建一个Dataloader模板-DataBlock"></a>创建一个Dataloader模板-DataBlock</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/5.png"></p>
<h3 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/6.png"></p>
<h3 id="创建混淆矩阵"><a href="#创建混淆矩阵" class="headerlink" title="创建混淆矩阵"></a>创建混淆矩阵</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/7.png"></p>
<h3 id="查看预测错误的和置信度最低的5个图"><a href="#查看预测错误的和置信度最低的5个图" class="headerlink" title="查看预测错误的和置信度最低的5个图"></a>查看预测错误的和置信度最低的5个图</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/8.png"></p>
<h3 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/9.png">​</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##之后再重新训练</span></span><br></pre></td></tr></table></figure>
<h3 id="加载训练好的模型"><a href="#加载训练好的模型" class="headerlink" title="加载训练好的模型"></a>加载训练好的模型</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/10.png"></p>
<h3 id="查看输出tensor的映射关系"><a href="#查看输出tensor的映射关系" class="headerlink" title="查看输出tensor的映射关系"></a>查看输出tensor的映射关系</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/11.png"></p>
<h3 id="使用notebook创建应用"><a href="#使用notebook创建应用" class="headerlink" title="使用notebook创建应用"></a>使用notebook创建应用</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/12.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/13.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/14.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/15.png"></p>
<h4 id="Turning-your-notebook-into-a-real-app"><a href="#Turning-your-notebook-into-a-real-app" class="headerlink" title="Turning your notebook into a real app"></a>Turning your notebook into a real app</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/16.png"><br>把需要的代码拷贝到新的notebook文件里<br>把网址里的notebooks换成volla<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/17.png"><br>再使用binder即可发布<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/18.png"></p>
<h2 id="再来看个更具体的例子——手写数字识别"><a href="#再来看个更具体的例子——手写数字识别" class="headerlink" title="再来看个更具体的例子——手写数字识别"></a>再来看个更具体的例子——手写数字识别</h2><h3 id="首先获取path"><a href="#首先获取path" class="headerlink" title="首先获取path"></a>首先获取path</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/19.png"></p>
<h3 id="为了方便显示，隐藏父文件夹"><a href="#为了方便显示，隐藏父文件夹" class="headerlink" title="为了方便显示，隐藏父文件夹"></a>为了方便显示，隐藏父文件夹</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/20.png"></p>
<h3 id="查看路径下文件"><a href="#查看路径下文件" class="headerlink" title="查看路径下文件"></a>查看路径下文件</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/21.png"></p>
<h3 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/22.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/23.png"><br>打两个？可以获得source code<br>还可以doc（path.ls)查看官方文档</p>
<h3 id="继续查看"><a href="#继续查看" class="headerlink" title="继续查看"></a>继续查看</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/24.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/25.png"></p>
<h3 id="转换成numpy数组和pytorch数组"><a href="#转换成numpy数组和pytorch数组" class="headerlink" title="转换成numpy数组和pytorch数组"></a>转换成numpy数组和pytorch数组</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/26.png"><br>这两个的区别就在于tensor可以用GPU并行计算</p>
<h3 id="转换成pd查看背景梯度"><a href="#转换成pd查看背景梯度" class="headerlink" title="转换成pd查看背景梯度"></a>转换成pd查看背景梯度</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/27.png"></p>
<h3 id="Baseline-用每张3和7的均值和需要预测的图作比较，看哪个更接近"><a href="#Baseline-用每张3和7的均值和需要预测的图作比较，看哪个更接近" class="headerlink" title="Baseline-用每张3和7的均值和需要预测的图作比较，看哪个更接近"></a>Baseline-用每张3和7的均值和需要预测的图作比较，看哪个更接近</h3><h4 id="图转换成tensor"><a href="#图转换成tensor" class="headerlink" title="图转换成tensor"></a>图转换成tensor</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/28.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/29.png"></p>
<h4 id="把列表里的元素堆叠起来"><a href="#把列表里的元素堆叠起来" class="headerlink" title="把列表里的元素堆叠起来"></a>把列表里的元素堆叠起来</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/30.png"><br>这里要/255做标准化</p>
<h4 id="查看维度"><a href="#查看维度" class="headerlink" title="查看维度"></a>查看维度</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/31.png"><br>shape就是一个包含张量在每个坐标方向上尺寸的列表<br>阶就是张量忠坐标轴或者维度的数量</p>
<h4 id="沿着一个维度取均值"><a href="#沿着一个维度取均值" class="headerlink" title="沿着一个维度取均值"></a>沿着一个维度取均值</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/32.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/33.png"></p>
<h4 id="用L1或L2范数求差异"><a href="#用L1或L2范数求差异" class="headerlink" title="用L1或L2范数求差异"></a>用L1或L2范数求差异</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/34.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/35.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/36.png"><br>或者是<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/37.png"></p>
<h4 id="查看pytorch中tensor的type"><a href="#查看pytorch中tensor的type" class="headerlink" title="查看pytorch中tensor的type"></a>查看pytorch中tensor的type</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/38.png"></p>
<h4 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/39.png"></p>
<h5 id="定义损失函数"><a href="#定义损失函数" class="headerlink" title="定义损失函数"></a>定义损失函数</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/40.png"></p>
<h5 id="对验证集中的每个元素都求L1范数（广播机制）"><a href="#对验证集中的每个元素都求L1范数（广播机制）" class="headerlink" title="对验证集中的每个元素都求L1范数（广播机制）"></a>对验证集中的每个元素都求L1范数（广播机制）</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/41.png"></p>
<h5 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/42.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/43.png"></p>
<h5 id="准确率"><a href="#准确率" class="headerlink" title="准确率"></a>准确率</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/44.png"></p>
<h3 id="SGD"><a href="#SGD" class="headerlink" title="SGD"></a>SGD</h3><h4 id="计算梯度"><a href="#计算梯度" class="headerlink" title="计算梯度"></a>计算梯度</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/45.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/46.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/47.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/48.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/49.png"></p>
<h4 id="使用学习率"><a href="#使用学习率" class="headerlink" title="使用学习率"></a>使用学习率</h4><p>The learning rate is often a number between 0.001 and 0.1, although it could be anything.<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/50.png"></p>
<h4 id="An-End-to-End-SGD-Example"><a href="#An-End-to-End-SGD-Example" class="headerlink" title="An End-to-End SGD Example"></a>An End-to-End SGD Example</h4><h5 id="生成数据"><a href="#生成数据" class="headerlink" title="生成数据"></a>生成数据</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/51.png"></p>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/52.png"></p>
<h5 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/53.png"></p>
<h5 id="Initialize-the-parameters"><a href="#Initialize-the-parameters" class="headerlink" title="Initialize the parameters"></a>Initialize the parameters</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/54.png"></p>
<h5 id="Calculate-the-predictions"><a href="#Calculate-the-predictions" class="headerlink" title="Calculate the predictions"></a>Calculate the predictions</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/55.png"></p>
<h5 id="Calculate-the-loss"><a href="#Calculate-the-loss" class="headerlink" title="Calculate the loss"></a>Calculate the loss</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/56.png"></p>
<h5 id="Calculate-the-gradients"><a href="#Calculate-the-gradients" class="headerlink" title="Calculate the gradients"></a>Calculate the gradients</h5><h5 id=""><a href="#" class="headerlink" title=""></a><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/57.png"></h5><h5 id="Step-the-weights"><a href="#Step-the-weights" class="headerlink" title="Step the weights."></a>Step the weights.</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/58.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/59.png"></p>
<h5 id="Repeat-the-process"><a href="#Repeat-the-process" class="headerlink" title="Repeat the process"></a>Repeat the process</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/60.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/61.png"></p>
<h5 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h5><p>We just decided to stop after 10 epochs arbitrarily. In practice, we would watch the training and validation losses and our metrics to decide when to stop, as we’ve discussed.</p>
<h3 id="The-MNIST-Loss-Function"><a href="#The-MNIST-Loss-Function" class="headerlink" title="The MNIST Loss Function"></a>The MNIST Loss Function</h3><h4 id="查看准确率的梯度"><a href="#查看准确率的梯度" class="headerlink" title="查看准确率的梯度"></a>查看准确率的梯度</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/62.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/63.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/64.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">view(-<span class="number">1</span>,<span class="number">28</span>*<span class="number">28</span>)</span><br><span class="line">-<span class="number">1</span>表示自动适应</span><br><span class="line"></span><br><span class="line">unsqueeze(<span class="number">1</span>)</span><br><span class="line">表示在第二个维度上扩展一维</span><br></pre></td></tr></table></figure>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/65.png"><br>注意这里实际上是<br>definit_params(size, std=1.0):return(torch.randn(size)*std).requires_grad_()，也就是要保留权重的梯度<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/66.png"></p>
<h4 id="矩阵乘法"><a href="#矩阵乘法" class="headerlink" title="矩阵乘法"></a>矩阵乘法</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/67.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/68.png"></p>
<h4 id="item-解开张量"><a href="#item-解开张量" class="headerlink" title="item()解开张量"></a>item()解开张量</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/69.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/70.png"><br>x变化后，output无变化，梯度为0<br>所以用准确率函数当损失函数不稳定，很多地方梯度都是0</p>
<h4 id="另一种损失函数"><a href="#另一种损失函数" class="headerlink" title="另一种损失函数"></a>另一种损失函数</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/71.png"><br>目标是1的话，那损失就是1-predictions，如果目标是0的话，那损失就是predictions<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/72.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/73.png"><br>上述损失函数只接受0-1范围的输入，如何解决？</p>
<h4 id="sigmoid"><a href="#sigmoid" class="headerlink" title="sigmoid"></a>sigmoid</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/74.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/75.png"></p>
<h4 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h4><p>我们真正关心的计时准确率，但是用准确率往往拿不到梯度，所以引出了一个有较好梯度的损失函数（准确率有时候也可以当损失函数）</p>
<h4 id="mini-batch"><a href="#mini-batch" class="headerlink" title="mini-batch"></a>mini-batch</h4><p>含义其实就是若干条数据，他的大小叫做batchsize<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/76.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/77.png"><br>最后一个batch的size可能会小于设定数</p>
<h3 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/78.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/79.png"><br>其中first是fastai函数，取出迭代器中的第一个元素<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/80.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/81.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/82.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/83.png"><br>梯度会被累加，所以要清零。</p>
<h6 id="​记住下划线意味着函数直接对原始对象进行修改"><a href="#​记住下划线意味着函数直接对原始对象进行修改" class="headerlink" title="​记住下划线意味着函数直接对原始对象进行修改"></a>​记住下划线意味着函数直接对原始对象进行修改</h6><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/84.png"></p>
<h4 id="SGD随机梯度下降的循环"><a href="#SGD随机梯度下降的循环" class="headerlink" title="SGD随机梯度下降的循环"></a>SGD随机梯度下降的循环</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/85.png"><br>因为这一步时不需要计算梯度，所以要用p.data而不是p<br>xb的shape是256<em>28</em>28</p>
<h4 id="梯度下降和随机梯度下降的区别"><a href="#梯度下降和随机梯度下降的区别" class="headerlink" title="梯度下降和随机梯度下降的区别"></a>梯度下降和随机梯度下降的区别</h4><p>随机梯度下降有mini-batch，即贯穿每个小批次的循环<br>对于梯度下降，它每次都是针对整个数据集的(没有for循环，一次性用数据集所有数据算梯度)</p>
<h4 id="准确率-1"><a href="#准确率-1" class="headerlink" title="准确率"></a>准确率</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/86.png"><br>sigmoid的值域是（0，1），所以用0.5分界</p>
<h4 id="验证集准确率"><a href="#验证集准确率" class="headerlink" title="验证集准确率"></a>验证集准确率</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/87.png"><br>round用于保留4位小数</p>
<h4 id="一个epoch"><a href="#一个epoch" class="headerlink" title="一个epoch"></a>一个epoch</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/88.png"></p>
<h4 id="二十个epoch"><a href="#二十个epoch" class="headerlink" title="二十个epoch"></a>二十个epoch</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/89.png"></p>
<h3 id="做一些简化——创建优化器"><a href="#做一些简化——创建优化器" class="headerlink" title="做一些简化——创建优化器"></a>做一些简化——创建优化器</h3><p>首先要做的就是放弃linear（）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/90.png"><br>他被当做函数调用时，有着和linear（）一样的功能，他能自动创建并且初始化权值（包扩bias），并自动保留梯度。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/91.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/92.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/93.png"><br>对比：<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/94.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/95.png"><br>实际使用时用<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/96.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/97.png"><br>训练集中的数据会被打乱但是验证集里不会</p>
<h4 id="学习器类"><a href="#学习器类" class="headerlink" title="学习器类"></a>学习器类</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/98.png"><br>他会调用<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/99.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/100.png"></p>
<h3 id="Adding-a-Nonlinearity——ReLu"><a href="#Adding-a-Nonlinearity——ReLu" class="headerlink" title="Adding a Nonlinearity——ReLu"></a>Adding a Nonlinearity——ReLu</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/101.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/102.png"><br>relu就是<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/103.png">这一行<br>加relu是为了增强拟合能力，不然只有先线性测层的话，多个线性层可以转化成为一个线性层。（通用近似定理）<br>当然因为梯度是逐层传递的，relu会出现梯度为0的情况，导致很多神经元失活浪费算力。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/104.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/105.png"><br>最后输出的是1个数，因为<br>输入是1<em>28</em>28，第一次矩阵运算（1，28<em>28）@ （28</em>28，30）<br>第二次矩阵运算（1，30）     @  （30，1）<br>相当于是先整理了30个线性特征，再把这30个特征又综合了一下<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/106.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/107.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/108.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/109.png"><br>最后一行的第3列：准确率</p>
<h4 id="查看模型"><a href="#查看模型" class="headerlink" title="查看模型"></a>查看模型</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/110.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/111.png"></p>
<h4 id="查看特征图像"><a href="#查看特征图像" class="headerlink" title="查看特征图像"></a>查看特征图像</h4><p>w是30<em>28</em>28<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/112.png"></p>
<h4 id="用fastai试试"><a href="#用fastai试试" class="headerlink" title="用fastai试试"></a>用fastai试试</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/113.png"></p>
<h4 id="jargon"><a href="#jargon" class="headerlink" title="jargon"></a>jargon</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/114.png"></p>
<h2 id="Image-Classification"><a href="#Image-Classification" class="headerlink" title="Image Classification"></a>Image Classification</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/115.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/116.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/117.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/118.png"><br>fastai中大多数返回集合的函数和方法都使用一个名为L的类<br>L可以被认为是普通Python列表类型的增强版本，为普通操作增加了便利。<br>比如在开头就说明了有7394个元素。</p>
<h3 id="任务：分辨pets品种"><a href="#任务：分辨pets品种" class="headerlink" title="任务：分辨pets品种"></a>任务：分辨pets品种</h3><h4 id="演示正则表达式"><a href="#演示正则表达式" class="headerlink" title="演示正则表达式"></a>演示正则表达式</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/119.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/120.png"></p>
<h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><p>其中独立变量是图像t因变量是种类(categoryBlock)<br>使用path里文件们的name属性<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/121.png"><br>接下来这一步是<br>Presizing<br>预先定尺寸</p>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/122.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/123.png"><br>下图中左图为fastai处理效果<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/124.png"></p>
<h4 id="Checking-and-Debugging-a-DataBlock"><a href="#Checking-and-Debugging-a-DataBlock" class="headerlink" title="Checking and Debugging a DataBlock"></a>Checking and Debugging a DataBlock</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/125.png"></p>
<h5 id="加上unique查看同一只狗"><a href="#加上unique查看同一只狗" class="headerlink" title="加上unique查看同一只狗"></a>加上unique查看同一只狗</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/126.png"></p>
<h4 id="一个调试工具"><a href="#一个调试工具" class="headerlink" title="一个调试工具"></a>一个调试工具</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/127.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/128.png"><br>（比报错显示的好</p>
<h4 id="训练一下"><a href="#训练一下" class="headerlink" title="训练一下"></a>训练一下</h4><p>fastai会自动选择合适的损失函数<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/129.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/130.png"></p>
<h4 id="Cross-Entropy-Loss"><a href="#Cross-Entropy-Loss" class="headerlink" title="Cross-Entropy Loss"></a>Cross-Entropy Loss</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/131.png"></p>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/132.png"><br>下图里面的dl是个参数<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/133.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/134.png"><br>可以看到每个概率的和是1，这是通过softmax做到的</p>
<h4 id="softmax"><a href="#softmax" class="headerlink" title="softmax"></a>softmax</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/135.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/136.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/137.png"><br>可以看到他们的和并不是1<br>只能分别代表对3和7的置信度<br>对两个预测值做差再sigmoid得到对3（大概率的那个数）的概率，1-这个概率得到对7的概率</p>
<h4 id="扩展到多个类别"><a href="#扩展到多个类别" class="headerlink" title="扩展到多个类别"></a>扩展到多个类别</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/138.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/139.png"><br>因为这里的每一个值都是除以总和得到的所以它们相加会等于1</p>
<h4 id="Log-Likelihood"><a href="#Log-Likelihood" class="headerlink" title="Log Likelihood"></a>Log Likelihood</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/140.png"><br>以上是softmax之后的值<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/141.png"><br>第一项表示的是返回第几行<br>第二项表示的是返回该行的第几列元素<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/142.png"></p>
<h2 id="这里的loss计算方式存疑"><a href="#这里的loss计算方式存疑" class="headerlink" title="这里的loss计算方式存疑"></a>这里的loss计算方式存疑</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/143.png"><br>取负号是因为想让损失函数是负的</p>
<h4 id="取对数"><a href="#取对数" class="headerlink" title="取对数"></a>取对数</h4><p>增大损失之间的差异<br>​</p>
<p>当我们首先取softmax，然后取它的对数似然，这个组合叫做交叉熵损失。在PyTorch中，这可以作为nn.CrossEntropyLoss使用（实际上，它执行log_softmax，然后是nll_loss）：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/144.png"><br>以上两种写法都可以<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/145.png"><br>以上为查看取均值之前的tensor</p>
<h5 id="为什么损失函数值是负数"><a href="#为什么损失函数值是负数" class="headerlink" title="为什么损失函数值是负数"></a><del>为什么损失函数值是负数</del></h5><h4 id="查看混淆矩阵"><a href="#查看混淆矩阵" class="headerlink" title="查看混淆矩阵"></a>查看混淆矩阵</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/146.png"></p>
<h4 id="查看容易混淆的类别"><a href="#查看容易混淆的类别" class="headerlink" title="查看容易混淆的类别"></a>查看容易混淆的类别</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/147.png">​</p>
<h3 id="Improving-Our-Model"><a href="#Improving-Our-Model" class="headerlink" title="Improving Our Model"></a>Improving Our Model</h3><h5 id="调大学习率"><a href="#调大学习率" class="headerlink" title="调大学习率"></a>调大学习率</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/148.png"><br>可以看到损失增加</p>
<h4 id="寻找合适的学习率"><a href="#寻找合适的学习率" class="headerlink" title="寻找合适的学习率"></a>寻找合适的学习率</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/149.png"><br>选择下图这两个值之间的比较好<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/150.png"></p>
<h4 id="fine-tune"><a href="#fine-tune" class="headerlink" title="fine_tune"></a>fine_tune</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/151.png"><br>一开始先冻结，只有最后一层的参数时可训练的<br>解冻之后所有参数都可以训练<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/152.png"><br>注意cnn_learner默认会冻结预训练模型<br>上图中是对最后一层的参数训练了3轮<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/153.png"><br>此时的learning_rate可能已经不是最优解了，所以再调用一次<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/154.png"><br>尝试找出模型表现开始再次变差的点<br>选取比这个值小数十倍的值<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/155.png"><br>在这里还能训练的更好，因为最后一层只训练了三轮，需要对最后一层再多训练，所以要设置不同的学习率<br>神经网络中不同层应该用不同的学习率来进行训练<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/156.png"></p>
<ul>
<li>在fastai中这个的意思是在第一层的学习率是1e-6，而最后一层的学习率是1e-4，其他中间层的学习率会是他们中间的一些值</li>
<li>learn.fit_one_cycle(12, lr_max=slice(1e-6,1e-4))的前1/3的batchs学习率逐渐增大，之后逐渐减小</li>
</ul>
<p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/157.png"><br>显存不够或者是想加快训练速度时<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/158.png"><br>代价是准确率降低</p>
<blockquote>
<p>用小模型做数据清洗和测试不错</p>
</blockquote>
<h2 id="Multi-label-classification"><a href="#Multi-label-classification" class="headerlink" title="Multi-label classification"></a>Multi-label classification</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/159.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/160.png"><br>取第一列<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/161.png"><br>取第一行<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/162.png"><br>这两种写法效果完全一致<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/163.png"><br>创建新的列<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/164.png"></p>
<h3 id="​"><a href="#​" class="headerlink" title="​"></a>​</h3><h4 id="Constructing-a-DataBlock"><a href="#Constructing-a-DataBlock" class="headerlink" title="Constructing a DataBlock"></a>Constructing a DataBlock</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/165.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/166.png"><br>以 tuple 格式返回每组对应元素<br>下面这种写法是一样的效果<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/167.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/168.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/169.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/170.png"><br>所以这是我们在fastai中建立自变量和因变量的主要方法<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/171.png"><br>上面这些麻烦，所以用datablock</p>
<h4 id="DataBlock"><a href="#DataBlock" class="headerlink" title="DataBlock"></a>DataBlock</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/172.png"><br>之后传入dataframe<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/173.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/174.png"><br>可以看到如果不给定xy的话那就得不到我们想要的自变量（图片）和因变量（标签）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/175.png"><br>也可以这么写<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/176.png"><br>当然只得到一个文件名是不够的，要得到他的路径<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/177.png"><br>为了获取图片，需要传入对应的blocks<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/178.png"><br>这里是独热编码，多标签的分类用独热编码很方便。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/179.png"><br>对【19】的理解：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/180.png"></p>
<h3 id="划分验证集"><a href="#划分验证集" class="headerlink" title="划分验证集"></a>划分验证集</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/181.png"><br>要按照csv中的标签划分验证集，同样是传入一个参数<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/182.png"><br>DataFrame-》DataBlock-》DataLoader（注意没有Dataset）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/183.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/184.png"></p>
<h4 id="Binary-Cross-Entropy"><a href="#Binary-Cross-Entropy" class="headerlink" title="Binary Cross-Entropy"></a>Binary Cross-Entropy</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/185.png"><br>一个batch有64张图，每个图对应20个可能的标签<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/186.png"><br>还没有训练所以这里面的参数值其实是随机的<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/187.png"><br>由于广播机制这个函数会作用在每一列上<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/188.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/189.png"><br>注意这里是用了sigmoid做多标签分类，softmax也可以<br>BCE的特殊之处就在于取了log<br>​</p>
<h3 id="调整准确率函数"><a href="#调整准确率函数" class="headerlink" title="调整准确率函数"></a>调整准确率函数</h3><p>设置阈值0.5<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/190.png"></p>
<h4 id="借助partial函数调整函数参数的默认值"><a href="#借助partial函数调整函数参数的默认值" class="headerlink" title="借助partial函数调整函数参数的默认值"></a>借助partial函数调整函数参数的默认值</h4><p>例子如下图<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/191.png"><br>freeze_epoch期间可以只训练最后层<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/192.png"><br>也可以指定损失函数<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/193.png"><br>选择阈值很重要。如果选择的阈值太低，则通常无法选择正确标记的对象。我们可以通过更改度量，然后调用validate来看到这一点，validate返回验证损失和度量：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/194.png"></p>
<h4 id="挑选合适的阈值"><a href="#挑选合适的阈值" class="headerlink" title="挑选合适的阈值"></a>挑选合适的阈值</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/195.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/196.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/197.png"></p>
<h2 id="人脸中心点检测（图像回归问题）"><a href="#人脸中心点检测（图像回归问题）" class="headerlink" title="人脸中心点检测（图像回归问题）"></a>人脸中心点检测（图像回归问题）</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/198.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/199.png"><br>设置每张图片对应的标签<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/200.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/201.png"><br>获取人脸中心位置坐标<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/202.png"><br>选择13号文件夹下的图片做验证集<br>数据增强已经标准化（标准化其实可以自动完成）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/203.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/204.png"><br>其中3指的是3个chanel<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/205.png"><br>取值范围显然是在【-1,1】</p>
<h3 id="Training-a-model"><a href="#Training-a-model" class="headerlink" title="Training a model"></a>Training a model</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/206.png"><br>实现方法：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/207.png"></p>
<h4 id="损失函数-1"><a href="#损失函数-1" class="headerlink" title="损失函数"></a>损失函数</h4><p>在构建回归模型时均方误差非常常用，另外他的梯度也很好，用来当损失函数和评价指标都可以<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/208.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/209.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/210.png"><br>将均方误差开根得到均方根误差<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/211.png"></p>
<h4 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/212.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/213.png"></p>
<h2 id="协同过滤"><a href="#协同过滤" class="headerlink" title="协同过滤"></a>协同过滤</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/214.png"><br>这部电影作为动作片的系数是0.98。。。。。<br>这个人喜欢动作电影的系数是0.9，战争类的是0,8,科普类的是-0.6<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/215.png"><br>原始数据，协同过滤要做的就是确定图中空白位置的值<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/216.png"><br>先随机生成蓝色部分和黄色部分的数据，然后训练，以确定这两个部分的系数，从而预测出空白位置的值<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/217.png"></p>
<h3 id="Creating-the-DataLoaders"><a href="#Creating-the-DataLoaders" class="headerlink" title="Creating the DataLoaders"></a>Creating the DataLoaders</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/218.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/219.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/220.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/221.png"><br>取出第四行的数据<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/222.png"></p>
<h3 id="Embedding"><a href="#Embedding" class="headerlink" title="Embedding"></a>Embedding</h3><h3 id="Embedding-1"><a href="#Embedding-1" class="headerlink" title="Embedding"></a>Embedding</h3><p>要知道embedding的作用，首先要了解独热编码(one-hot encoding)。假设现在有如下对应编码关系：<br>0：我<br>1：是<br>2：一<br>3：头<br>4：猪<br>那么用来表示一句话比如：“我是猪”表示为：<br>0，1，4<br>而one-hot编码中只存在 0 和1，有多少个字要编码，独热编码的每一行长度就会有多长，比如字典中一共有 5 个字 “我是一头猪” 被从 0-4 进行了编码，那么独热编码的每一行就会有5个用 0或1表示的位置，即使可能要表达的语句只有很短的句子，例如：<br>[1,0,0,0,0] 我–0<br>[0,1,0,0,0] 是–1<br>[0,0,0,0,1] 猪–4<br>在每一句对应的编码位置会被设置成 1，其余的地方都是 0，也就是说，每一行只会有一个1。<br><strong>one-hot编码的优势是：计算方便快捷、表达能力强。</strong> 因为对于这样的稀疏矩阵做矩阵计算的时候，只需要把1对应位置的数相乘求和就可以，但问题也很明显，稀疏矩阵的资源占用太恐怖了，尤其体现在长篇文字的处理中，例如：<br>简体汉字常用3000个被从0-2999编号，也就是说在这套系统中<strong>每个单字的独热编码是3000位</strong>，如果你现在<strong>有一篇10000字的文章</strong>，那么用独热编码的方式编码之后其大小为10000×3000 = 30000000，很恐怖吧，最重要的是，其中很多东西是重复的，只是在文章的不同位置，这样会大量的浪费存储空间。所以如何解决这个问题呢····<br><strong>embedding应运而生</strong>~~~~<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/223.png"><br>embedding的原理是使用矩阵乘法来进行降维，从而达到节约存储空间的目的。<br>假设：我们有一个 2 × 6 2 × 62×6 的矩阵，然后乘上一个 6 × 3 6 × 36×3 的矩阵后，变成了一个2 × 3 2 × 32×3 的矩阵。<br>先不管它什么意思，这个过程，我们把一个12个元素的矩阵变成6个元素的矩阵，直观上，大小是不是缩小了一半？<br>而且，值得注意的是，虽然直观上矩阵的大小变小了，但是其实数字蕴藏的信息并没有改变，<strong>只是按照某一种映射关系将原本矩阵的信息转换到了一个新的维度的矩阵里面</strong>；只要按照逆向的映射关系，对矩阵进行相乘，其又会回到本身的模样！！！从这里来看，<strong>embedding是通过某种矩阵乘法来实现矩阵数据的降维</strong>。<br><strong>如果你想把数据使用另外一个维度的张量来表示，而不想造成信息的损失，可以使用 embedding 来调整。</strong><br><strong>​</strong></p>
<p><strong>那么embedding 除了实现降维之外，还有一个很重要的逆向功能–升维</strong>。<br>当矩阵维度很低的时候，有些有效的信息是不能够被很完整地提取出来的，举个不恰当的例子：<br>在纸上写了一个字<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/224.png"><br>经过embedding之后相当于把纸折起来或者揉搓了一下，变成了：<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/225.png"><br>所以在提取信息的时候可能无法非常顺理，而通过 embedding 进行升维之后，就相当于将整张纸展开，方便于<strong>改变成不同的感受野</strong>进行信息的提取。<br><strong>对低维的数据进行升维时，可能把一些其他特征给放大了，或者把笼统的特征给分开了。同时，这个embedding是一直在学习在优化的，就使得整个过程慢慢形成一个良好的观察点</strong>。<br>​</p>
<p>所以说embedding过程就是矩阵乘法过程，用来把输入降维度<br>​</p>
<p>​</p>
<p>Embedding实现了矩阵乘法取索引值而无需手动设置onehot向量<br>也就是用独热编码矩阵代替了数组查找方式<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/226.png"><br>这个函数的发音是dunder init</p>
<h3 id="Module类"><a href="#Module类" class="headerlink" title="Module类"></a>Module类</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/227.png"><br>其中这个init是创建的时候初始化用的，后面训练的时候都是用forward()来传参数的<br>x就是userid和movid<br>第一个是x[:,0]<br>第二个是x[:,1]<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/228.png"><br>让每个user和每个mov都获得所对应的向量<br>来看一下他们各自的shape<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/229.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/230.png"><br>这样计算出来的就是绿框里的部分<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/231.png"><br>第一个维度是mini-batch的维度，所以要对第二个维度sum，最后得到的就是点乘的结果<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/232.png"></p>
<h3 id="训练-1"><a href="#训练-1" class="headerlink" title="训练"></a>训练</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/233.png"></p>
<h3 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h3><p>回归类型的数据分析，最好告诉fastai标签的数据范围<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/234.png"><br>这里相当于是<br>（res,0,5.5）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/235.png"><br>有的用户就是喜欢打低分，那就加上偏置<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/236.png"><br>过拟合了<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/237.png"></p>
<h2 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/238.png"></p>
<h3 id="Creating-our-own-Embedding-module"><a href="#Creating-our-own-Embedding-module" class="headerlink" title="Creating our own Embedding module"></a>Creating our own Embedding module</h3><p>所以嵌入的意思就是矩阵中的索引<br>而且最好是创建一个自己的版本<br>嵌入层实际上是从Module继承而来的。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/239.png"><br>但是只这么写是不会被学习的，要像下面这么写。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/240.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/241.png">这样的函数不需要像上面一样那么写，因为他已经自动被调用了。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/242.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/243.png"><br>因此像上图一样这样创建的Parameter就可以被学习了。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/244.png"></p>
<h3 id="Interpreting-embeddings-and-biases"><a href="#Interpreting-embeddings-and-biases" class="headerlink" title="Interpreting embeddings and biases"></a>Interpreting embeddings and biases</h3><p>查看偏置最小的五条数据。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/245.png"><br>这是大家最不喜欢的五部电影。<br>相反，以下是大家最喜欢的五部电影。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/246.png"></p>
<h4 id="使用PCA分析"><a href="#使用PCA分析" class="headerlink" title="使用PCA分析"></a>使用PCA分析</h4><p>他就是会把50个因素压缩到三个。<br>可以看到一些电影都找到了他们自己所属的那一个空间。<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/247.png" alt="KRCU5AHE803Z7.png"></p>
<h3 id="用fastai完成协同过滤"><a href="#用fastai完成协同过滤" class="headerlink" title="用fastai完成协同过滤"></a>用fastai完成协同过滤</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/248.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/249.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/250.png"></p>
<h3 id="用余弦相似度查看相似的电影"><a href="#用余弦相似度查看相似的电影" class="headerlink" title="用余弦相似度查看相似的电影"></a>用余弦相似度查看相似的电影</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/251.png"></p>
<h3 id="如果不用点积"><a href="#如果不用点积" class="headerlink" title="如果不用点积"></a>如果不用点积</h3><p>就可以为不同的用户以及不同的电影设置不同的Embedding,这样更灵活<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/252.png"><br>fastai有一个函数get_emb_sz()，它根据fast.ai发现的一个启发式方法返回数据嵌入矩阵的建议大小，该方法在实践中效果很好：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/253.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/254.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/255.png"><br>或者直接<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/256.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/257.png"><br>这里用到了表格模型。</p>
<h3 id="Tabular"><a href="#Tabular" class="headerlink" title="Tabular"></a>Tabular</h3><p>用上述的神经网络是可以的，也可以用随机森林</p>
<h3 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h3><h4 id="使用kaggleAPI"><a href="#使用kaggleAPI" class="headerlink" title="使用kaggleAPI"></a>使用kaggleAPI</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/258.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/259.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/260.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/261.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/262.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/263.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/264.png"></p>
<h4 id="加载数据-1"><a href="#加载数据-1" class="headerlink" title="加载数据"></a>加载数据</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/265.png"></p>
<h4 id="查看一下有哪些列"><a href="#查看一下有哪些列" class="headerlink" title="查看一下有哪些列"></a>查看一下有哪些列</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/266.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/267.png"><br>将此属性转化为有序类别<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/268.png"><br>选择因变量并将其转换为对数，因为kaggle要求这么做<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/269.png"></p>
<h4 id="决策树-1"><a href="#决策树-1" class="headerlink" title="决策树"></a>决策树</h4><p>创建决策树的流程：<br>(暂略)</p>
<h2 id="NLP"><a href="#NLP" class="headerlink" title="NLP"></a>NLP</h2><h3 id="准备数据-1"><a href="#准备数据-1" class="headerlink" title="准备数据"></a>准备数据</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/270.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/271.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/272.png"></p>
<h3 id="Tokenization"><a href="#Tokenization" class="headerlink" title="Tokenization"></a>Tokenization</h3><p>将文本转化为一组单词或词条,那么句号算不算是一个词条呢?通常有三种划分方式<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/273.png"><br>fastai默认分词器spaCy<br>使用WordTokenizer（）创建分词器，会自动分配一个合适的分词器<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/274.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/275.png"><br>为上一步的分词器扩展功能：将大写字母转换成小写，并在词前用xxmaj做标记，因为一个单词无论是大写还是小写都应该都应同一个向量<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/276.png"><br>To see the rules that were used, you can check the default rules:<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/277.png"><br>As always, you can look at the source code of each of them in a notebook by typing:<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/278.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/279.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/280.png"></p>
<h3 id="Subword-tokenization-子分词器"><a href="#Subword-tokenization-子分词器" class="headerlink" title="Subword tokenization(子分词器"></a>Subword tokenization(子分词器</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/281.png"><br>在语料库中找出现频次最高的字符组合，构成单词<br>比如：<br>‘我的’会经常出现，因为他的意思是‘my’<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/282.png"><br>我们实例化标记器，传入要创建的vocab的大小，然后需要“训练”它。也就是说，我们需要让它阅读我们的文档，找到共同的字符序列来创建vocab。这是通过设置完成的。我们很快就会看到，setup是一种特殊的fastai方法，在我们通常的数据处理管道中自动调用。但是，由于我们现在都是手工操作，所以我们必须自己调用它。下面是一个函数，它对给定的vocab大小执行以下步骤，并显示一个示例输出：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/283.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/284.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/285.png"></p>
<h4 id="Numericalization-with-fastai"><a href="#Numericalization-with-fastai" class="headerlink" title="Numericalization with fastai"></a>Numericalization with fastai</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/286.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/287.png"><br>对上一步分好的单词，每个单词都编一个号<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/288.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/289.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/290.png"><br>默认的词汇量是60000，也就是embedding矩阵的大小，如果还有没覆盖到的，就替换到出现频次最低的词<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/291.png"><br>变回原来的样子<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/292.png"></p>
<h3 id="batch"><a href="#batch" class="headerlink" title="batch"></a>batch</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/293.png"><br>对有几百万token的IMDB数据来说，每行数据太多，所以要进行拆分（用列拆分）<br>举个例子：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/294.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/295.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/296.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/297.png"><br>以上得到的就是三个mini-batch，注意行和行之间是完全独立的<br>以上步骤很麻烦，不过都不用我们自己做，直接用fastai的LMDataLoader就行</p>
<h3 id="使用fastai"><a href="#使用fastai" class="headerlink" title="使用fastai"></a>使用fastai</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/298.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/299.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/300.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/301.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/302.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/303.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/304.png"><br>上图中的前两行必不可少，setup（）用来创建字典<br>数字化：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/305.png"><br>（上图效果演示：<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/306.png">）<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/307.png"><br>64是batch-size，序列长度是72<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/308.png"><br>（xxunk表示vocab中没有 这个词）<br>再看看验证集中的数据<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/309.png"><br>可以看到验证集的数据相比训练集左移了一位</p>
<h4 id="Training-a-text-classifier"><a href="#Training-a-text-classifier" class="headerlink" title="Training a text classifier"></a>Training a text classifier</h4><h5 id="Language-model-using-DataBlock"><a href="#Language-model-using-DataBlock" class="headerlink" title="Language model using DataBlock"></a>Language model using DataBlock</h5><p>当TextBlock传递给DataBlock时，fastai自动处理标记化和数值化。可以传递给Tokenize和Numericalize的所有参数也可以传递给TextBlock。在下一章中，我们将讨论分别运行这些步骤的最简单方法，以简化调试，但您始终可以通过在前几节中所示的数据子集上手动运行这些步骤来进行调试。别忘了DataBlock便捷的summary方法，它对于调试数据问题非常有用<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/310.png"><br>这里使用了一个类方法，可以存储分词的结果到这里面，下次可以从存储的数据接着运行<br>​</p>
<p>与以前在DataBlock中使用的类型不同的一点是，我们不仅仅直接使用类（即TextBlock（…），而是调用类方法。类方法是一种Python方法，顾名思义，它属于类而不是对象(如果您不熟悉类方法，请务必在线搜索有关它们的更多信息，因为它们在许多Python库和应用程序中都很常用；我们以前在书中使用过几次，但没有引起注意。）TextBlock之所以特别，是因为设置numericalizer的vocab可能需要很长时间（我们必须阅读并标记每个文档才能获得vocab）。为了尽可能地提高效率，它执行了一些优化：•它将标记化文档保存在临时文件夹中，因此不必多次标记化文档•它并行运行多个标记化进程，以利用计算机的CPU我们需要告诉TextBlock如何访问文本，所以它可以做这个初始的预处理，这是从\u文件夹做的。显示\u批处理然后以通常的方式工作：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/311.png"><br>也就是说show_batches()会自动de-数字化</p>
<h4 id="Fine-tuning-the-language-model"><a href="#Fine-tuning-the-language-model" class="headerlink" title="Fine tuning the language model"></a>Fine tuning the language model</h4><h5 id="创建学习器"><a href="#创建学习器" class="headerlink" title="创建学习器"></a>创建学习器</h5><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/312.png"><br>让我们回到本章开头的流程图。第一个arrow已为我们完成，并在fastai作为预训练模型提供，<br>我们刚刚为第二阶段构建了数据加载器和学习器。现在<br>我们已经准备好微调我们的语言模型了！<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/313.png"><br>训练每个epoch需要相当长的时间，因此我们将在训练过程中保存中间模型结果。因为微调不适合我们，所以我们将使用fit\u one\u cycle。就像cnn\u learner一样，language\u model\u learner在使用预训练模型（这是默认值）时会自动调用freeze，因此这只会训练嵌入（模型中唯一包含随机初始化权重的部分，即嵌入IMDb vocab中但不在预训练模型vocab中的单词）：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/314.png"></p>
<h4 id="Saving-and-Loading-Models"><a href="#Saving-and-Loading-Models" class="headerlink" title="Saving and Loading Models"></a>Saving and Loading Models</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/315.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/316.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/317.png"><br>行话：编码器：模型不包括特定于任务的最终层。当应用于视觉CNN时，这个术语和身体的含义基本相同，但“编码器”往往更多地用于NLP和生成模型。<br>得到不包括最后一层的model，这是个预训练模型，他经过了wiki和imdb下一个词预测的双重预训练，之后开始将这个模型用于分类任务。</p>
<h3 id="Text-generation"><a href="#Text-generation" class="headerlink" title="Text generation"></a>Text generation</h3><p>先试试用上面的模型的预测下一个词的功能做个文本生成模型：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/318.png"><br>如您所见，我们添加了一些随机性（我们根据模型返回的概率选择一个随机词），因此我们不会得到完全相同的评论两次。我们的模型没有任何关于句子结构或语法规则的编程知识，但是它已经清楚地了解了很多英语句子：我们可以看到它适当地大写（我只是转换成I），因为我们的规则需要两个字符或更多的字来考虑一个词大写，所以它是正常的看到它小写）和使用一致的时态。总评乍一看是有道理的，只有仔细阅读，你才能注意到有些东西有点不对劲。对一个几个小时训练的模特来说还不错！但我们的最终目标不是训练一个模型来生成评论，而是对它们进行分类。。。所以让我们用这个模型来做。</p>
<h3 id="Creating-the-Classifier-DataLoaders"><a href="#Creating-the-Classifier-DataLoaders" class="headerlink" title="Creating the Classifier DataLoaders"></a>Creating the Classifier DataLoaders</h3><p>使用之前做好的语料库，因为语料库要是不同那之前的预训练就没有意义了<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/319.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/320.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/321.png"><br>不是语言模型了，现在是分类模型<br>分类模型文本不能像语言模型那样直接切割<br>fastai会把相似长度的文本放在同一个batch中，不同的长度再用padding补齐<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/322.png"><br>如用padding把所有都补成581<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/323.png"></p>
<h3 id="Fine-Tuning-the-Classifier"><a href="#Fine-Tuning-the-Classifier" class="headerlink" title="Fine-Tuning the Classifier"></a>Fine-Tuning the Classifier</h3><p>最后一步是以有区别的学习速度进行训练，并逐渐解冻。在计算机视觉中，我们经常一次解冻模型，但对于NLP分类器，我们发现一次解冻几层会产生真正的影响：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/324.png"><br>仅仅在一个epoch里，我们就得到了和我们在&lt;&gt;中训练一样的结果：还不错！我们可以通过-2冻结\，冻结除最后两个参数组以外的所有参数组：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/325.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/326.png"><br>我们的准确率达到了94.3%，这是三年前最先进的表现。通过对所有向后阅读的文本训练另一个模型并平均这两个模型的预测，我们甚至可以达到95.1%的准确率，这是ULMFiT论文介绍的最新技术。就在几个月前，通过微调一个更大的模型和使用昂贵的数据扩充技术（将句子翻译成另一种语言，然后使用另一种模型进行翻译），它才被打败。使用一个预先训练好的模型，让我们构建一个经过微调的语言模型，它非常强大，可以生成假评论，也可以帮助分类评论。这是令人兴奋的事情，但要记住，这项技术也可以用于恶意目的。</p>
<h3 id="文本的数据增强"><a href="#文本的数据增强" class="headerlink" title="文本的数据增强"></a>文本的数据增强</h3><p>arXiv查论文Unsupervised Data Augmentation for Consistency Training</p>
<h3 id="安全隐患"><a href="#安全隐患" class="headerlink" title="安全隐患"></a>安全隐患</h3><p>fast.ai搜SciPy Keynote</p>
<h2 id="NLP-drive"><a href="#NLP-drive" class="headerlink" title="NLP_drive"></a>NLP_drive</h2><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/327.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/328.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/329.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/330.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/331.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/332.png"></p>
<h3 id="Our-First-Language-Model-from-Scratch"><a href="#Our-First-Language-Model-from-Scratch" class="headerlink" title="Our First Language Model from Scratch"></a>Our First Language Model from Scratch</h3><p>把它变成神经网络的一个简单方法是指定我们要根据前面的三个单词来预测每个单词。我们可以创建一个由三个单词组成的每个序列的列表作为自变量，每个序列后面的下一个单词作为因变量。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/333.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/334.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/335.png"><br>我们现在可以创建一个神经网络结构，将三个单词作为输入，并返回对vocab中每个可能的下一个单词的概率的预测。我们将使用三个标准线性层，但是有两个调整。第一个调整是第一个线性层将只使用第一个单词的嵌入作为激活，第二个层将使用第二个单词的嵌入加上第一个层的输出激活，第三层将使用第三个单词的嵌入加上第二层的输出激活。这样做的关键效果是，每个单词都是在它前面的任何单词的信息上下文中解释的，第二个调整是这三个层中的每一层都将使用相同的权重矩阵。一个单词影响前一个单词激活的方式不应因单词的位置而改变。换言之，激活值将随着数据在层中的移动而改变，但层权重本身不会因层而异。因此，一个层不学习一个序列位置；它必须学会处理所有的位置，因为层的权重不会改变，你可能会认为连续的层是“同一层”的重复。事实上，PyTorch使这一点具体化；我们可以只创建一个层，然后多次使用它。</p>
<h3 id="Our-Language-Model-in-PyTorch"><a href="#Our-Language-Model-in-PyTorch" class="headerlink" title="Our Language Model in PyTorch"></a>Our Language Model in PyTorch</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/336.png"></p>
<h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/337.png"><br>相同颜色代表是同一个权重矩阵（这里把Embedding换成linear就不行了，不知道为啥）</p>
<h4 id="为什么只有一个Embedding矩阵，明明有很多词？"><a href="#为什么只有一个Embedding矩阵，明明有很多词？" class="headerlink" title="为什么只有一个Embedding矩阵，明明有很多词？"></a>为什么只有一个Embedding矩阵，明明有很多词？</h4><p>因为概念上来讲它们都代表英语的内容词（不太懂）<br>我理解的是这个Embedding事实上包含了所有词的意义了已经，毕竟<img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/338.png"></p>
<h3 id="训练-2"><a href="#训练-2" class="headerlink" title="训练"></a>训练</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/339.png"></p>
<h4 id="baseline准确率"><a href="#baseline准确率" class="headerlink" title="baseline准确率"></a>baseline准确率</h4><p>thousand出现的概率最大，假设每次都预测是thousand，那准确率就是15%<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/340.png"></p>
<h3 id="Our-First-Recurrent-Neural-Network"><a href="#Our-First-Recurrent-Neural-Network" class="headerlink" title="Our First Recurrent Neural Network"></a>Our First Recurrent Neural Network</h3><p>看看我们模块的代码，我们可以通过用for循环替换调用层的重复代码来简化它。除了使我们的代码更简单之外，这还有一个好处，即我们能够将我们的模块同样好地应用于不同长度的令牌序列，而不局限于长度为3的令牌列表：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/341.png"><br>h初始化为0是因为0和张量相加时0会广播到张量的大小再相加，这是个很小巧的功能<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/342.png"><br>换张图说明RNN：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/343.png"></p>
<h3 id="Improving-the-RNN"><a href="#Improving-the-RNN" class="headerlink" title="Improving the RNN"></a>Improving the RNN</h3><h4 id="Maintaining-the-state-of-an-RNN"><a href="#Maintaining-the-state-of-an-RNN" class="headerlink" title="Maintaining the state of an RNN"></a>Maintaining the state of an RNN</h4><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/344.png"><br>从开头计算所有的梯度会非常慢：<br>所以通过detach（）方法将计算好的梯度历史值丢掉<br>也就是说激活值依旧保留，但是梯度历史值没有保留<br>仔细想想，不管我们选择的序列长度是多少，这个模型都会有相同的激活，因为隐藏状态会记住上一批中的最后一个激活。唯一不同的是在每一步计算的梯度：它们将只在过去的序列长度标记上计算，而不是整个流。这就是为什么这个序列长度经常被称为bptt，以便通过时间进行反向传播。<br>有时候需要把h值置为0，所以加了reset函数<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/345.png"><br>注意：序号1代表分隔符‘.’<br>接下来划分batch<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/346.png"><br>创建训练集验证集<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/347.png"><br>在每个轮次开始的时候要调用reset（）把r置为0<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/348.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/349.png"><br>传入ModelRester到callbacks列表中（也就是cbs中<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/350.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/351.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/352.png"></p>
<h3 id="创造更多有效信息"><a href="#创造更多有效信息" class="headerlink" title="创造更多有效信息"></a>创造更多有效信息</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/353.png"><br>也就是在创建完每个隐藏状态后我们就立即进行了预测<br>在每次输入三个词之后因变量也变成三个词<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/354.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/355.png"><br>现在我们需要修改我们的模型，以便它在每个单词之后输出预测，而不是仅仅在三个单词序列的末尾：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/356.png"><br>此模型将返回形状bs x sl x vocab_sz的输出（因为我们在dim=1上叠加）。我们的目标形状是bs x sl，所以我们需要先将其展平，然后再将其用于F.cross：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/357.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/358.png"><br>我们需要训练更长的时间，因为任务已经改变了一点，现在更复杂了。但我们最终得到了一个好结果。。。至少，有时候。如果运行几次，就会发现在不同的运行中可以得到完全不同的结果。这是因为实际上我们这里有一个非常深的网络，可以产生非常大或非常小的梯度。我们将在本章的下一部分看到如何处理这个问题。现在，得到一个更好的模型的明显方法是更深入：在我们的基本RNN中，隐藏状态和输出激活之间只有一个线性层，所以也许我们可以用更多的方法得到更好的结果。</p>
<h3 id="加深层数"><a href="#加深层数" class="headerlink" title="加深层数"></a>加深层数</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/359.png"><br>注意：虚线和实线的权重是不同的<br>这个被称作是堆叠RNN或者多层RNN<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/360.png"><br>我们可以通过使用PyTorch的RNN类来节省一些时间，该类实现了我们之前创建的内容，但也为我们提供了堆叠多个RNN的选项，正如我们所讨论的：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/361.png"><br>其中n_layers设置了要堆叠多少个循环层<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/362.png"><br>现在真令人失望。。。我们以前的单层RNN性能更好。为什么？原因是我们有一个更深层次的模型，导致爆炸或消失激活。<br>在实践中，从这种RNN创建精确的模型是困难的。如果我们少调用detach，并且有更多的层，我们将获得更好的结果这将使我们的RNN有更长的时间范围可以学习，并且可以创建更丰富的特性。但这也意味着我们还有更深层的模式需要训练。深度学习发展的关键挑战在于如何训练这些模型。这之所以具有挑战性，是因为当你将一个矩阵乘以很多次时会发生什么。想想当你把一个数乘以很多次时会发生什么。例如，如果你乘以2，从1开始，你得到序列1，2，4，8，。。。经过32步，你已经是4294967296了。如果你乘以0.5，你会得到0.5，0.25，0.125…经过32步，你会得到0.00000000023。正如你所看到的，乘以一个比1稍高或稍低的数，在重复几次乘法之后，我们的起始数就会爆炸或消失。因为矩阵乘法只是将数字相乘并相加，重复的矩阵乘法也会发生同样的情况。这就是深层神经网络的全部——每一层都是另一个矩阵乘法。这意味着一个深度神经网络很容易以非常大或非常小的数字结束。这是一个问题，因为计算机存储数字（称为“浮点”）的方式意味着数字离零越远，它们的准确度就越低。&lt;&gt;中的图表来自一篇优秀的文章“您从未想了解浮点，但将被迫了解的内容”，它显示了浮点数的精度是如何随数字行而变化的。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/363.png"><br>这种不精确性意味着，对于深度网络，通常为更新权重而计算的梯度最终为零或无穷大。这通常被称为消失梯度或爆炸梯度问题。这意味着在SGD中，权重要么根本不更新，要么跳到无穷大。不管怎样，他们都不会随着训练而进步。研究人员已经开发了许多方法来解决这个问题，我们将在本书后面讨论。一种选择是改变层的定义，使其不太可能有爆炸性的激活。当我们讨论批处理规范化时，以及当我们讨论resnet时，我们将在&lt;。处理这个问题的另一个策略是小心初始化，这是我们将在&lt;&gt;中研究的主题。对于RNN，有两种类型的层经常被用来避免爆炸性激活：选通递归单元（GRU）和长-短期记忆（LSTM）层。这两个都可以在PyTorch中使用，并且是RNN层的直接替代品。在这本书中我们将只讨论LSTM；网上有很多很好的教程解释GRUs，它是LSTM设计的一个小变种。</p>
<h3 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h3><p><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/364.png"><br>每一层里有微小的神经网络，用于决定保存多少历史状态，舍弃多少历史状态，添加多少种新状态<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/365.png"><br>实际上，我们可以重构代码。另外，在性能方面，一个大的矩阵乘法要比四个小的矩阵乘法好（这是因为我们只在GPU上启动一次特殊的fast内核，它让GPU有更多的并行工作要做）。堆叠需要一点时间（因为我们必须在GPU上移动一个张量，使其全部位于一个连续的数组中），所以我们使用两个单独的层作为输入和隐藏状态。经过优化和重构的代码如下所示：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/366.png"><br>其中chunk方法用于将数据等分<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/367.png">​<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/368.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/369.png"><br>fastai中查看激活值的方法：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/370.png">​</p>
<h4 id="正则化-1"><a href="#正则化-1" class="headerlink" title="正则化"></a>正则化</h4><p>dropout对RNN非常有效<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/371.png"><br>如果没有在训练或者说正在验证，就无需dropout了<br>mask是一个伯努利概率<br>fastai中的每个module都自带training</p>
<h5 id="激活正则化和时间激活正则化"><a href="#激活正则化和时间激活正则化" class="headerlink" title="激活正则化和时间激活正则化"></a>激活正则化和时间激活正则化</h5><ul>
<li>降低权重</li>
<li>降低激活值</li>
</ul>
<p>激活正则化（AR）和时间激活正则化（TAR）是两种与权重衰减非常相似的正则化方法，在&lt;&gt;中讨论。当应用重量衰减时，我们对损失增加一个小的惩罚，目的是使重量尽可能小。对于激活正则化，它是由LSTM产生的最终激活，我们将尝试使其尽可能小，而不是权重。为了使最终激活规则化，我们必须将它们存储在某个地方，然后将它们的平方平均值添加到损失中（以及乘数alpha，这与重量衰减的wd类似）：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/372.png"><br>时间激活正则化与我们预测句子中的标记有关。这意味着，当我们按顺序阅读LSTMs的输出时，它们很可能在某种程度上是有意义的。TAR是为了鼓励这种行为，在损失中增加一个惩罚，使两个连续的激活之间的差异尽可能小：我们的激活张量有一个形状bs x sl x n\u hid，我们在序列长度轴（中间的维度）上读取连续的激活。由此，TAR可以表示为：<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/373.png"><br>alpha和beta是两个需要调整的超参数。为了实现这一点，我们需要我们的dropout模型返回三个内容：正确的输出、LSTM pre dropout的激活和LSTM post dropout的激活。AR通常应用于退出激活（为了不惩罚我们后来变成零的激活），而TAR应用于非退出激活（因为那些零在两个连续的时间步之间产生了很大的差异）。然后有一个名为RNNRegularizer的回调，它将为我们应用这个正则化。</p>
<h4 id="权重栓连"><a href="#权重栓连" class="headerlink" title="权重栓连"></a>权重栓连</h4><p>预测的下一个单词与将激活值转变为英语单词有关。embedding实现了单词到激活值的转变，一个合理的假设就是这些都是基本相同的运算，或者至少说是顺序相反的，所以为什么不使用相同的权重呢。实际上确实可以这样，而且效果很好。<br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/374.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/375.png"><br><img src="http://106.12.125.218/medias/medias/fastai%E6%95%99%E7%A8%8B/376.png"><br>Now this is far better than our previous model!</p>

      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/dl/" class="">
              dl
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>author:  </strong>snowgo</a>
    </li>
    <li class="post-copyright-link">
    <strong>link:  </strong>
    <a href="/2021/07/28/fastai教程/" target="_blank" title="fastai教程">https://snowgo.live/2021/07/28/fastai教程/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright notice:   </strong>
      All articles on this website, unless otherwise stated, adopt <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      reprint policy. If reproduced, please indicate source!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload" src="https://images7.alphacoders.com/687/687126.png" alt="">
    </div>
    <a href="/2021/07/28/Python%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> Prev:
        <div class="title-text">Python算法——长期更新</div>
      </div>
      
      <!-- <div class="content">
        类型提示就是说一下这个变量是什么类型用的，写了也不编译，就到时候能给检查一下，不容易出错，这样写的代码也好读
123de
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload" src="https://z3.ax1x.com/2021/07/23/Wrw2ZV.jpg" src="" alt="">
    </div>
    <a href="/2021/07/27/Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%85%A5%E9%97%A8/" class="post-nav-link">
      <div class="title">
        Next: <i class="fas fa-angle-right"></i>
        <div class="title-text">Python正则表达式入门</div>
      </div>
      <!-- <div class="content">
        准备工作引入模块import re
编译正则表达式m=re.compile(r’\d+’)
使用正则表达式match（）
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <!-- 文章详情页右侧目录 -->

  <div class="toc-aside">
    <div class="toc-main">
      <div class="toc-aside-title">
        <i class="fas fa-list-ul" aria-hidden="true"></i><span>catalog</span>
        
          <div class="toc-open-close">catalog</div>
        
      </div>
      <div class="toc-content">
        <div class="toc"></div>
      </div>
    </div>
  </div>

  <!-- 手机端目录按钮 -->
  <div id="toc-mobile-btn">
    <i class="fas fa-list-ul" aria-hidden="true"></i>
  </div>


<script>
  function closeToc(init) {
    $(".toc-aside").css({'width': 0, 'padding': 0, 'transition': init ?  'noe' : 'width 0.3s' });
    $(".toc-content").css({'width': 0});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'none'});
    $(".main-content").css({'width': '75%', 'margin': '10px auto'});
  };
  function openToc() {
    $(".main-content").css({'width': '65%', 'margin-right': '10px', 'margin-left': 'calc(35% - 350px)'});
    $(".toc-aside").css({'width': '300px', 'padding': '0 10px', 'transition': 'width 0.3s'});
    $(".toc-content").css({'width': '300px'});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'inline-block'});
  }
  function openBtnClickFn () {
    let openOrCloseBtn = $('.toc-aside .toc-aside-title .toc-open-close');
    let open = eval('' || 'true');
    openOrCloseBtn.click(function() {
      if (open) {
        closeToc();
        open = false;
      } else {
        openToc();
        open = true;
      }
    });
  };
  openBtnClickFn();
  initCloseTocWidth(true);

  function initCloseTocWidth(init) {
    if (window.innerWidth >= 992) {
      let isClose = false;
      isClose && closeToc(init)
    }
  }

  document.addEventListener('pjax:complete', function () {
    $(".toc-aside").css({'transition': 'no'});
  })
  document.addEventListener('pjax:complete', function () {
    openBtnClickFn();
  })
  
</script>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '10000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || 'http://106.12.125.218/medias/%E7%AB%99%E7%82%B9%E5%A3%81%E7%BA%B8%E5%92%8C%E8%A7%86%E9%A2%91/air%E5%A3%81%E7%BA%B82.png';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




      </main>
    </div>

    <!-- 页脚 -->
    
  
  <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = 'rgba(0, 0, 0, 0.5)' || '#272727';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2020 - 2022 <a target="_blank" rel="noopener" href="https://github.com/snowgo">snowgo</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a> | <a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referra" style="display: inline-block;  vertical-align: middle;"><img src="https://cdn.jsdelivr.net/gh/xingjiahui/CDN/又拍云_logo.png" align="absmiddle" width="59px" height="30px" /></a></p>

          </div>
        
      
        
          
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  display: none;
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  display: none;
  
  font-size: 15px;
  color: #010202;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="netease"
  type="playlist"
  id="2303619958"
  fixed='true'
  autoplay='false'
  theme='#010202'
  loop='all'
  order='random'
  preload='auto'
  volume='0.7'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    

    <!-- 图片放大 -->
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <!-- 背景彩带 -->
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script>

<script>
  var headerEl = 'h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -80,
    headingsOffset: -($(window).height() * 0.4 - 45),
    positionFixedSelector: '.toc-main',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 100) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('toc-aside')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  }
</style> 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const headerMenuTransparent = true;
    if (!headerMenuTransparent) { return; }
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.css">
  <script src="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = 'copy';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = '';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', 'snowgo/juicesea')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <script src="/js/cursor/fireworks.js"></script>
  





    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>